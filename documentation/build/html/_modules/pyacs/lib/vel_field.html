

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pyacs.lib.vel_field &mdash; pyacs 0.65.3 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> pyacs
          

          
          </a>

          
            
            
              <div class="version">
                0.65.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../foreword.html">What is pyacs?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">How to install pyacs?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../libraries.html">pyacs core libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gts.html">Time series library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../make_time_series.html">pyacs_make_time_series.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../time_series.html">Time series analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Full code documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyacs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyacs.lib.vel_field</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyacs.lib.vel_field</h1><div class="highlight"><pre>
<div class="viewcode-block" id="Velocity_Field"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field">[docs]</a><span></span><span class="k">class</span> <span class="nc">Velocity_Field</span><span class="p">:</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Velocity_Field class: reads a velocity field from a GMT psvelo file </span>
<span class="sd">    and provides methods to manipulate velocity field</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<span class="c1">###################################################################</span>
    <span class="k">def</span> <span class="fm">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lgmt_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1">###################################################################</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="k">if</span> <span class="n">lgmt_points</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="n">lgmt_points</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Velocity_Field.read"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.read">[docs]</a>    <span class="nd">@classmethod</span>        
<span class="c1">###################################################################</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lexclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">lonly</span><span class="o">=</span><span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads a GMT psvelo file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># import</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        
        <span class="c1"># init</span>
        
        <span class="n">vf</span> <span class="o">=</span> <span class="n">Velocity_Field</span><span class="p">()</span>

        <span class="c1"># fake 4-letters code generation using hexadecimal</span>
        <span class="k">def</span> <span class="nf">__gen_fake_code__</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            
            <span class="n">FAKE</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">fake_code</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%4s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
                <span class="n">FAKE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fake_code</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            
            <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">FAKE</span><span class="p">))</span>

        <span class="c1"># reads psvelo file</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- Reading GMT psvelo file: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">np_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;!!! Could not read file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file_name</span><span class="p">)</span>
        
        <span class="c1"># empty psvelo file</span>
        <span class="k">if</span> <span class="n">np_vel</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span> <span class="n">vf</span> <span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">np_vel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- file </span><span class="si">%s</span><span class="s2"> has 8 columns&quot;</span> <span class="o">%</span> <span class="n">file_name</span><span class="p">)</span>

            <span class="n">np_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np_vel</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">np_code</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            
            <span class="n">code</span> <span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="n">np_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span> <span class="n">np_code</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">np_sort</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">):</span> 
                <span class="k">if</span> <span class="n">np_sort</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">code</span><span class="p">:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!!!&quot;</span><span class="p">,</span><span class="n">code</span><span class="p">)</span> 
                <span class="n">code</span> <span class="o">=</span>  <span class="n">np_sort</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 

            
        <span class="k">elif</span> <span class="p">(</span><span class="n">np_vel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- file </span><span class="si">%s</span><span class="s2"> has 3 columns&quot;</span> <span class="o">%</span> <span class="n">file_name</span><span class="p">)</span>

            <span class="n">np_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np_vel</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">np_code</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">))))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">np_vel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">]):</span>
            <span class="n">np_code</span> <span class="o">=</span> <span class="n">__gen_fake_code__</span><span class="p">(</span><span class="n">np_vel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;!!! Could not decipher file content: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

        <span class="c1"># populates velocity field</span>
        
        <span class="kn">from</span> <span class="nn">pyacs.lib.gmtpoint</span> <span class="kn">import</span> <span class="n">GMT_Point</span>

        <span class="n">lgmt_points</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np_vel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">code</span> <span class="o">=</span> <span class="n">np_code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">np_vel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">Ve</span><span class="p">,</span> <span class="n">Vn</span><span class="p">,</span> <span class="n">SVe</span><span class="p">,</span> <span class="n">SVn</span><span class="p">,</span> <span class="n">SVen</span> <span class="o">=</span> <span class="n">np_vel</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">M</span> <span class="o">=</span> <span class="n">GMT_Point</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">Ve</span><span class="o">=</span><span class="n">Ve</span><span class="p">,</span> <span class="n">Vn</span><span class="o">=</span><span class="n">Vn</span><span class="p">,</span> <span class="n">SVe</span><span class="o">=</span><span class="n">SVe</span><span class="p">,</span> <span class="n">SVn</span><span class="o">=</span><span class="n">SVn</span><span class="p">,</span> <span class="n">SVen</span><span class="o">=</span><span class="n">SVen</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">np_vel</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">M</span> <span class="o">=</span> <span class="n">GMT_Point</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">M</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="c1"># tests whether site will be added</span>
        
            <span class="k">if</span> <span class="n">lonly</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">lonly</span><span class="p">:</span>
                    <span class="n">lgmt_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lexclude</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lexclude</span><span class="p">:</span>
                        <span class="n">lgmt_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lgmt_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    
        <span class="n">vf</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="n">vf</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="n">lgmt_points</span>
         
        <span class="k">return</span> <span class="n">vf</span> </div>

<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.info"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print basics information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- velocity field from: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- number of sites    : </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
            <span class="n">n_site_per_line</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-- list of sites: &#39;</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lcode</span><span class="p">()),</span> <span class="p">[</span><span class="s1">&#39;    &#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_site_per_line</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lcode</span><span class="p">())</span> <span class="p">,</span> <span class="n">n_site_per_line</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_site_per_line</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span></div>
        
<span class="c1">###################################################################</span>

<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.add_point"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.add_point">[docs]</a>    <span class="k">def</span> <span class="nf">add_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends a GMT_Point to a velocity field</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.remove_point"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.remove_point">[docs]</a>    <span class="k">def</span> <span class="nf">remove_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the a GMT_Point to a velocity field given its code</span>
<span class="sd">        </span>
<span class="sd">        :param code: 4-characters code for the point to be removed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">lexclude</span><span class="o">=</span><span class="p">[</span><span class="n">code</span><span class="p">])</span> 
        
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.write"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lexclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">up</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a GMT psvelo file</span>
<span class="sd">        a list site name to be excluded can be provided</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">out_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;! No file name provided. Using tmp_vel.gmt&quot;</span><span class="p">)</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="s1">&#39;tmp_vel.gmt&#39;</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- Writing GMT psvelo file: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">out_file</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">up</span><span class="p">:</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span> <span class="o">+</span> <span class="s1">&#39; | UP component&#39;</span>

        <span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# &#39;</span> <span class="o">+</span> <span class="n">comment</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">up</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
                <span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%10.5lf</span><span class="s2">  </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">Vu</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">SVu</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">SVen</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            
            <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
                <span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%10.5lf</span><span class="s2">  </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">Ve</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">Vn</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">SVe</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">SVn</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">SVen</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>

        <span class="n">fs</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
                        
<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.nsites"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.nsites">[docs]</a>    <span class="k">def</span> <span class="nf">nsites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of sites in velocity field</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span></div>

<span class="c1">#    def lsite(self):</span>
<span class="c1">#        &quot;&quot;&quot;Returns the site from the velocity field as a list GMT_Point object &quot;&quot;&quot;</span>
<span class="c1">#        for M in self.sites:</span>
<span class="c1">#            if M.code == code:</span>
<span class="c1">#                return M</span>

<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.l_GMT_Point"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.l_GMT_Point">[docs]</a>    <span class="k">def</span> <span class="nf">l_GMT_Point</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the velocity field as a list of GMT_Point object </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">lsite</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span><span class="n">lsite</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">lsite</span></div>

<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.print_info_site"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.print_info_site">[docs]</a>    <span class="k">def</span> <span class="nf">print_info_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the info for a given site by his code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">code</span><span class="p">:</span>
                <span class="n">M</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">legend</span><span class="o">=</span><span class="n">verbose</span> <span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.subset"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.subset">[docs]</a>    <span class="k">def</span> <span class="nf">subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lonly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lexclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1">###################################################################</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new Velocity_Field object from a subset of sites</span>
<span class="sd">        </span>
<span class="sd">        :param lonly,lexclude: list of site codes to be included or excluded</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">lGpoint</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
        <span class="c1"># tests whether site will be added</span>

            <span class="k">if</span> <span class="n">lonly</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">lonly</span><span class="p">:</span>
                    <span class="n">lGpoint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lexclude</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lexclude</span><span class="p">:</span>
                        <span class="n">lGpoint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Velocity_Field</span><span class="p">(</span><span class="n">lgmt_points</span><span class="o">=</span><span class="n">lGpoint</span><span class="p">)</span></div>
    
<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.radial"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.radial">[docs]</a>    <span class="k">def</span> <span class="nf">radial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">):</span>
<span class="c1">###################################################################</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a Velocity Field whose components are radial and tangential with respect to a given center</span>
<span class="sd">        </span>
<span class="sd">        :param center: numpy array [longitude,latitude] of center</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">copy</span>
        
        <span class="n">lnew_point</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcode</span><span class="p">():</span>
            
            <span class="n">gmt_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            
            <span class="n">radial_unit_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gmt_point</span><span class="o">.</span><span class="n">lon</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gmt_point</span><span class="o">.</span><span class="n">lat</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">radial_unit_vector</span> <span class="o">=</span> <span class="n">radial_unit_vector</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">radial_unit_vector</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

            <span class="n">tangential_unit_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">radial_unit_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">radial_unit_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            
            <span class="n">new_gmt_point</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">gmt_point</span><span class="p">)</span>
            <span class="n">new_gmt_point</span><span class="o">.</span><span class="n">Ve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gmt_point</span><span class="o">.</span><span class="n">Ve</span><span class="p">,</span> <span class="n">gmt_point</span><span class="o">.</span><span class="n">Vn</span><span class="p">])</span> <span class="o">*</span> <span class="n">radial_unit_vector</span><span class="p">)</span>
            <span class="n">new_gmt_point</span><span class="o">.</span><span class="n">Vn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gmt_point</span><span class="o">.</span><span class="n">Ve</span><span class="p">,</span> <span class="n">gmt_point</span><span class="o">.</span><span class="n">Vn</span><span class="p">])</span> <span class="o">*</span> <span class="n">tangential_unit_vector</span><span class="p">)</span>
        
            <span class="n">lnew_point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_gmt_point</span><span class="p">)</span>

        <span class="n">new_vel</span> <span class="o">=</span> <span class="n">Velocity_Field</span><span class="p">(</span><span class="n">lgmt_points</span><span class="o">=</span><span class="n">lnew_point</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_vel</span></div>

<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.lcode"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.lcode">[docs]</a>    <span class="k">def</span> <span class="nf">lcode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of all point codes in current Velocity Field object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">lcode</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lcode</span><span class="p">):</span><span class="n">lcode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">lcode</span><span class="p">)</span></div>

<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.site"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.site">[docs]</a>    <span class="k">def</span> <span class="nf">site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
<span class="c1">###################################################################</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a site in current Field object as a GMT_Point object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">code</span><span class="p">):</span><span class="k">return</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>
    
<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.calc_pole"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.calc_pole">[docs]</a>    <span class="k">def</span> <span class="nf">calc_pole</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plates</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;WLS&#39;</span> <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs Euler pole calculation</span>
<span class="sd">        </span>
<span class="sd">        :param plates: dictionary with the name of plate as key and list of sites for each plate as values</span>
<span class="sd">        :param method: choose among weighted least-squares &#39;WLS&#39; or &#39;L1&#39;</span>
<span class="sd">        </span>
<span class="sd">        :output: for each plate, the following files will be created:</span>
<span class="sd">                - euler_stat_plate_name.dat: Euler pole values and statistics</span>
<span class="sd">                - plate_name.gmt: velocities (GMT psvelo format) with respect to the calculated Euler pole</span>
<span class="sd">                - plate_name.shp: velocities (shapefile  format) with respect to the calculated Euler pole</span>
<span class="sd">                - eulers_sum.dat: summary of Euler pole values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># import </span>
        <span class="kn">import</span> <span class="nn">pyacs.lib.shapefile</span>
        <span class="kn">import</span> <span class="nn">pyacs.lib.euler</span>

        <span class="c1"># loop on plates</span>

        <span class="c1"># dictionary of W and VCV</span>
        <span class="n">H_w</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">plate</span><span class="p">,</span> <span class="n">lsite</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">plates</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- processing plate: </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%8d</span><span class="s2"> sites &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsite</span><span class="p">)))</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsite</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># error</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vel_plate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">lsite</span><span class="p">)</span> 
                <span class="n">H_w</span><span class="p">[</span> <span class="n">plate</span> <span class="p">]</span> <span class="o">=</span> <span class="n">vel_plate</span><span class="o">.</span><span class="n">pole</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="n">plate</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="s1">&#39;euler_stat_&#39;</span> <span class="o">+</span> <span class="n">plate</span> <span class="o">+</span> <span class="s1">&#39;.dat&#39;</span><span class="p">)</span>
                
                <span class="c1"># get the new velocity field </span>
                <span class="n">new_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">substract_pole</span><span class="p">(</span><span class="n">H_w</span><span class="p">[</span> <span class="n">plate</span> <span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;rot&#39;</span><span class="p">)</span>
                
                <span class="c1"># write it</span>
                <span class="n">outgmt</span> <span class="o">=</span> <span class="n">plate</span> <span class="o">+</span> <span class="s1">&#39;.gmt&#39;</span>
                <span class="n">new_vel</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_file</span><span class="o">=</span><span class="n">plate</span> <span class="o">+</span> <span class="s1">&#39;.gmt&#39;</span><span class="p">)</span>
                <span class="n">pyacs</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">shapefile</span><span class="o">.</span><span class="n">psvelo_to_shapefile</span><span class="p">(</span><span class="n">outgmt</span> <span class="p">,</span> <span class="n">plate</span> <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
 
        <span class="c1"># euler_sum</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-- writing euler_sum.dat&#39;</span><span class="p">)</span>
        <span class="n">euler_sum_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;euler_sum.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="n">euler_sum_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# input file: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">euler_sum_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Euler poles</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">euler_sum_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#-------------------------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">plate</span><span class="p">,</span> <span class="n">lsite</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">plates</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

            <span class="p">[</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">]</span> <span class="o">=</span> <span class="n">H_w</span><span class="p">[</span> <span class="n">plate</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">VCV_POLE_X</span> <span class="o">=</span> <span class="n">H_w</span><span class="p">[</span> <span class="n">plate</span> <span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">(</span><span class="n">llambda</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span> <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">euler</span><span class="o">.</span><span class="n">rot2euler</span><span class="p">(</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">)</span>
            <span class="p">(</span><span class="n">max_sigma</span><span class="p">,</span> <span class="n">min_sigma</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">s_omega</span><span class="p">)</span> <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">euler</span><span class="o">.</span><span class="n">euler_uncertainty</span><span class="p">([</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">],</span> <span class="n">VCV_POLE_X</span><span class="p">)</span>

            <span class="n">euler_sum_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%-10s</span><span class="s2"> | </span><span class="si">%8.3lf</span><span class="s2"> </span><span class="si">%8.3lf</span><span class="s2"> </span><span class="si">%6.3lf</span><span class="s2"> | </span><span class="si">%5.2lf</span><span class="s2"> </span><span class="si">%5.2lf</span><span class="s2"> </span><span class="si">%5.1lf</span><span class="s2"> </span><span class="si">%5.3lf</span><span class="s2"> | </span><span class="si">%11.5G</span><span class="s2"> </span><span class="si">%11.5G</span><span class="s2"> </span><span class="si">%11.5G</span><span class="se">\n</span><span class="s2">&quot;</span> \
                                 <span class="o">%</span> <span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">llambda</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">max_sigma</span><span class="p">,</span> <span class="n">min_sigma</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">s_omega</span> <span class="p">,</span> <span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">))</span>
 
        <span class="n">euler_sum_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#-------------------------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">euler_sum_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Relative Euler poles</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">euler_sum_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Euler poles</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">euler_sum_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#-------------------------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">plate_ref</span><span class="p">,</span> <span class="n">_lsite_ref</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">plates</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

            <span class="p">[</span><span class="n">wx_ref</span><span class="p">,</span> <span class="n">wy_ref</span><span class="p">,</span> <span class="n">wz_ref</span><span class="p">]</span> <span class="o">=</span> <span class="n">H_w</span><span class="p">[</span> <span class="n">plate_ref</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">VCV_POLE_X_REF</span> <span class="o">=</span> <span class="n">H_w</span><span class="p">[</span> <span class="n">plate_ref</span> <span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">plate</span><span class="p">,</span> <span class="n">lsite</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">plates</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    
                <span class="k">if</span> <span class="n">plate</span> <span class="o">!=</span> <span class="n">plate_ref</span><span class="p">:</span>
    
                    <span class="p">[</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">]</span> <span class="o">=</span> <span class="n">H_w</span><span class="p">[</span> <span class="n">plate</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">VCV_POLE_X</span> <span class="o">=</span> <span class="n">H_w</span><span class="p">[</span> <span class="n">plate</span> <span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                    <span class="n">wx</span> <span class="o">=</span> <span class="n">wx</span> <span class="o">-</span> <span class="n">wx_ref</span> 
                    <span class="n">wy</span> <span class="o">=</span> <span class="n">wy</span> <span class="o">-</span> <span class="n">wy_ref</span> 
                    <span class="n">wz</span> <span class="o">=</span> <span class="n">wz</span> <span class="o">-</span> <span class="n">wz_ref</span> 
            
                    <span class="n">VCV_POLE_X</span> <span class="o">=</span> <span class="n">VCV_POLE_X</span> <span class="o">+</span> <span class="n">VCV_POLE_X_REF</span>

                    <span class="p">(</span><span class="n">llambda</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span> <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">euler</span><span class="o">.</span><span class="n">rot2euler</span><span class="p">(</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">max_sigma</span><span class="p">,</span> <span class="n">min_sigma</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">s_omega</span><span class="p">)</span> <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">euler</span><span class="o">.</span><span class="n">euler_uncertainty</span><span class="p">([</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">],</span> <span class="n">VCV_POLE_X</span><span class="p">)</span>

                    <span class="n">euler_sum_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%-5s</span><span class="s2"> wrt </span><span class="si">%-5s</span><span class="s2"> | </span><span class="si">%8.3lf</span><span class="s2"> </span><span class="si">%8.3lf</span><span class="s2"> </span><span class="si">%6.3lf</span><span class="s2"> | </span><span class="si">%5.2lf</span><span class="s2"> </span><span class="si">%5.2lf</span><span class="s2"> </span><span class="si">%6.1lf</span><span class="s2"> </span><span class="si">%5.3lf</span><span class="s2"> | </span><span class="si">%11.5G</span><span class="s2"> </span><span class="si">%11.5G</span><span class="s2"> </span><span class="si">%11.5G</span><span class="se">\n</span><span class="s2">&quot;</span> \
                                         <span class="o">%</span> <span class="p">(</span><span class="n">plate</span><span class="p">,</span> <span class="n">plate_ref</span><span class="p">,</span> <span class="n">llambda</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">max_sigma</span><span class="p">,</span> <span class="n">min_sigma</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">s_omega</span> <span class="p">,</span> <span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">))</span>

        <span class="n">euler_sum_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#-------------------------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">euler_sum_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
                    
<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.pole"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.pole">[docs]</a>    <span class="k">def</span> <span class="nf">pole</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lexclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;WLS&#39;</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="s1">&#39;pLate&#39;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Euler pole calculation; available optimization methods are WLS: weighted least squares, LS: least-squares, Dikin: L1 linear estimator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">pyacs.lib.coordinates</span> <span class="k">as</span> <span class="nn">Coordinates</span>
        <span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">nplinalg</span>
        <span class="kn">import</span> <span class="nn">pyacs.lib.euler</span> <span class="k">as</span> <span class="nn">euler</span>

        <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
        
        <span class="c1"># Gets dimensions for the systems</span>
        <span class="k">if</span> <span class="n">lexclude</span><span class="p">:</span>
            <span class="n">nsites</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">lexclude</span><span class="p">):</span>
                    <span class="n">nsites</span> <span class="o">=</span> <span class="n">nsites</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nsites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsites</span><span class="p">()</span>
        
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nsites</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nsites</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">VCV_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nsites</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nsites</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
        
        <span class="c1"># starts loop on sites to build the linear system</span>

        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">H_sites</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">lexclude</span><span class="p">):</span>
                <span class="c1"># XYZ -&gt; local frame rotation matrix</span>
                <span class="n">H_sites</span><span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="o">.</span><span class="n">mat_rot_general_to_local</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lat</span><span class="p">))</span>
                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="o">.</span><span class="n">geo2xyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">he</span><span class="p">)</span>
                <span class="c1"># Observation equation in local frame</span>
                
                <span class="n">Ai</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">z</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
                
                <span class="n">Ai</span> <span class="o">=</span> <span class="n">Ai</span> <span class="o">/</span> <span class="mf">1000.0</span>
                
                <span class="n">RAi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Ai</span><span class="p">)</span>

                <span class="c1"># fill the observation i into the general design matrix A</span>
                
                <span class="n">A</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAi</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAi</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">RAi</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        
                <span class="n">B</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">Ve</span>
                <span class="n">B</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">Vn</span>
                
                <span class="n">M</span><span class="o">.</span><span class="n">assign_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

                <span class="n">VCV_B</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">SVe</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="n">VCV_B</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">SVn</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">SVe</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">SVn</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">SVen</span>
                <span class="n">VCV_B</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">VCV_B</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span>

                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="c1"># solves linear system</span>
        
        <span class="n">P</span> <span class="o">=</span> <span class="n">nplinalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">VCV_B</span><span class="p">)</span>

        <span class="n">ATP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">P</span><span class="p">)</span>
        
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ATP</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ATP</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
        
        <span class="c1"># Inversion</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">nplinalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

        <span class="c1"># Model Prediction</span>
        <span class="n">MP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>


        <span class="c1"># Residuals</span>
        <span class="n">RVen</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="n">MP</span> <span class="p">)</span>

        <span class="n">VCV_POLE_X</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">*</span> <span class="mf">1.E-12</span>
        <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">RVen</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">),</span> <span class="n">RVen</span><span class="p">)</span>
        <span class="n">dof</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nsites</span> <span class="o">-</span> <span class="mi">3</span>
        <span class="n">reduced_chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">chi2</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">dof</span><span class="p">))</span>

        <span class="p">(</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.E-6</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.E-6</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.E-6</span><span class="p">)</span>

        <span class="c1"># Convert rotation rate in the geocentric cartesian frame to Euler pole in geopgraphical coordinates</span>
        
        <span class="p">(</span><span class="n">llambda</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span> <span class="o">=</span> <span class="n">euler</span><span class="o">.</span><span class="n">rot2euler</span><span class="p">(</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">)</span>
        <span class="p">(</span><span class="n">max_sigma</span><span class="p">,</span> <span class="n">min_sigma</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">s_omega</span><span class="p">)</span> <span class="o">=</span> <span class="n">euler</span><span class="o">.</span><span class="n">euler_uncertainty</span><span class="p">([</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">],</span> <span class="n">VCV_POLE_X</span><span class="p">)</span>

        <span class="c1"># Write log</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">log</span><span class="p">):</span><span class="n">flog_name</span> <span class="o">=</span> <span class="n">exp</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span>
        <span class="k">else</span><span class="p">:</span><span class="n">flog_name</span> <span class="o">=</span> <span class="n">log</span>
        <span class="n">flog</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">flog_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ROTATION RATE VECTOR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Wx (rad/yr): </span><span class="si">%11.5G</span><span class="s2"> +- </span><span class="si">%10.5G</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">VCV_POLE_X</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])))</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Wy (rad/yr): </span><span class="si">%11.5G</span><span class="s2"> +- </span><span class="si">%10.5G</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wy</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">VCV_POLE_X</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])))</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Wz (rad/yr): </span><span class="si">%11.5G</span><span class="s2"> +- </span><span class="si">%10.5G</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">VCV_POLE_X</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])))</span>
        
        <span class="c1"># flog.write(&quot;Wx Wy Wz : %10.5G %10.5G %10.5G\n&quot;, % (wx,wy,wz))</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ASSOCIATED VARIANCE-COVARIANCE MATRIX (rad/yr)**2</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;        Wx          Wy            Wz</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;---------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Wx |</span><span class="si">%11.5G</span><span class="s2"> </span><span class="si">%11.5G</span><span class="s2"> </span><span class="si">%11.5G</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">VCV_POLE_X</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">VCV_POLE_X</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">VCV_POLE_X</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Wy |           </span><span class="si">%11.5G</span><span class="s2"> </span><span class="si">%11.5G</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">VCV_POLE_X</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">VCV_POLE_X</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Wz |                      </span><span class="si">%11.5G</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">VCV_POLE_X</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;---------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">EULER POLE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;longitude (dec. degree)    : </span><span class="si">%6.2lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">llambda</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;latitude  (dec. degree)    : </span><span class="si">%6.2lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">phi</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;angular velocity (deg/Myr ): </span><span class="si">%6.3lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">omega</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ASSOCIATED ERROR ELLIPSE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;semi major axis            : </span><span class="si">%5.2lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">max_sigma</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;semi minor axis            : </span><span class="si">%5.2lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">min_sigma</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;azimuth of semi major axis : </span><span class="si">%5.1lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">azimuth</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;std(angular velocity)      : </span><span class="si">%5.3lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s_omega</span><span class="p">)</span>

        <span class="c1"># Calculating a few statistics</span>

        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">STATISTICS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;----------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Number of sites     = </span><span class="si">%10d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">nsites</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Chi**2              = </span><span class="si">%10.1lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">chi2</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Reduced Chi**2      = </span><span class="si">%10.1lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">reduced_chi2</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Deg. of. freedom    = </span><span class="si">%10d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dof</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dof</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> 
            <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;A post. var. factor = No meaning (dof=0)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigma_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">chi2</span> <span class="o">/</span> <span class="n">dof</span><span class="p">)</span>
            <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;A post. var. factor = </span><span class="si">%10.1lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sigma_0</span><span class="p">)</span>

        <span class="c1"># rms &amp; wrms</span>

        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RESIDUALS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;----------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;site                    pred_e     pred_n         Ve         Vn       R_ve       R_vn       S_ve       S_vn      RN_ve      RN_vn</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;------------------------------------------------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">cpt_site</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">rms</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">wrms</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">dwrms</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">for</span> <span class="n">site</span><span class="p">,</span> <span class="n">M</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">H_sites</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">H_sites</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">lexclude</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_index</span><span class="p">()</span>

                <span class="n">mpe</span> <span class="o">=</span> <span class="n">MP</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">mpn</span> <span class="o">=</span> <span class="n">MP</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">oe</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">on</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

                <span class="n">rve</span> <span class="o">=</span> <span class="n">RVen</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">rvn</span> <span class="o">=</span> <span class="n">RVen</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">sve</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">SVe</span>
                <span class="n">svn</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">SVn</span>
 
                <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%-19s</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> \
                           <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">mpe</span><span class="p">,</span><span class="n">mpn</span><span class="p">,</span><span class="n">oe</span><span class="p">,</span><span class="n">on</span><span class="p">,</span><span class="n">rve</span><span class="p">,</span> <span class="n">rvn</span><span class="p">,</span> <span class="n">sve</span><span class="p">,</span> <span class="n">svn</span><span class="p">,</span> <span class="n">rve</span> <span class="o">/</span> <span class="n">sve</span><span class="p">,</span> <span class="n">rvn</span> <span class="o">/</span> <span class="n">svn</span><span class="p">))</span>
            
                <span class="n">cpt_site</span> <span class="o">=</span> <span class="n">cpt_site</span> <span class="o">+</span> <span class="mi">1</span>
 
                <span class="n">rms</span> <span class="o">=</span> <span class="n">rms</span> <span class="o">+</span> <span class="n">rve</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">rvn</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="n">wrms</span> <span class="o">=</span> <span class="n">wrms</span> <span class="o">+</span> <span class="p">(</span><span class="n">rve</span> <span class="o">/</span> <span class="n">sve</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">rvn</span> <span class="o">/</span> <span class="n">svn</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="n">dwrms</span> <span class="o">=</span> <span class="n">dwrms</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sve</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">svn</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;------------------------------------------------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rms</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">cpt_site</span><span class="p">)</span>
        <span class="n">wrms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wrms</span> <span class="o">/</span> <span class="n">dwrms</span><span class="p">)</span>

        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;rms = </span><span class="si">%10.2lf</span><span class="s2"> mm/yr    wrms = </span><span class="si">%10.2lf</span><span class="s2"> mm/yr</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rms</span><span class="p">,</span> <span class="n">wrms</span><span class="p">))</span>

        <span class="n">flog</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- Rotation rate results logged in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">flog_name</span><span class="p">)</span>
        
        <span class="k">return</span><span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="mf">1.E-6</span> <span class="p">,</span> <span class="n">VCV_POLE_X</span><span class="p">)</span></div>

<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.substract_pole"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.substract_pole">[docs]</a>    <span class="k">def</span> <span class="nf">substract_pole</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">type_euler</span><span class="o">=</span><span class="s1">&#39;rot&#39;</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        substract the prediction of an Euler pole to the velocity field</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">pyacs.lib.coordinates</span> <span class="k">as</span> <span class="nn">Coordinates</span>
        <span class="kn">import</span> <span class="nn">pyacs.lib.euler</span> <span class="k">as</span> <span class="nn">euler</span>

        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ltype</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;euler&#39;</span><span class="p">,</span> <span class="s1">&#39;rot&#39;</span><span class="p">]</span>  <span class="c1"># type is either Euler pole (lon. lat in dec. degrees and deg/Myr or cartesian rotation rate vector in rad/yr)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">type_euler</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ltype</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;!!! type_euler should be either euler or rot. type_euler=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">type_euler</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">type_euler</span> <span class="o">==</span> <span class="s1">&#39;euler&#39;</span><span class="p">):</span>
            <span class="c1"># convert to rotation rate vector</span>
            <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">W</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">W</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="p">(</span><span class="n">wx</span><span class="p">,</span> <span class="n">wy</span><span class="p">,</span> <span class="n">wz</span><span class="p">)</span> <span class="o">=</span> <span class="n">euler</span><span class="o">.</span><span class="n">euler2rot</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">omega</span><span class="p">)</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wx</span>
            <span class="n">W</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wy</span>
            <span class="n">W</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wz</span>

        <span class="c1"># create a new velocity field</span>

        <span class="n">lGpoint</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="o">.</span><span class="n">mat_rot_general_to_local</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lat</span><span class="p">))</span>
                <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="o">.</span><span class="n">geo2xyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">he</span><span class="p">)</span>
                <span class="c1"># Observation equation in local frame</span>
                
                <span class="n">Ai</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">z</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
                
                <span class="n">RAi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Ai</span><span class="p">)</span>
                <span class="c1"># Predicted velocity</span>
                <span class="n">Pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">RAi</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
                <span class="n">pve</span> <span class="o">=</span> <span class="n">Pi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.E3</span>
                <span class="n">pvn</span> <span class="o">=</span> <span class="n">Pi</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.E3</span>
                
                <span class="n">N</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                
                <span class="n">N</span><span class="o">.</span><span class="n">Ve</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">Ve</span> <span class="o">-</span> <span class="n">pve</span>
                <span class="n">N</span><span class="o">.</span><span class="n">Vn</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">Vn</span> <span class="o">-</span> <span class="n">pvn</span>
                
                <span class="n">lGpoint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        
        <span class="n">res_vel</span> <span class="o">=</span> <span class="n">Velocity_Field</span><span class="p">(</span><span class="n">lgmt_points</span><span class="o">=</span><span class="n">lGpoint</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res_vel</span></div>
        
<span class="c1"># !!!!!!!!!!!!! NOT TESTED YET       </span>

<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.common"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.common">[docs]</a>    <span class="k">def</span> <span class="nf">common</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linGpoint</span><span class="p">,</span> <span class="n">prefit</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">lexclude</span><span class="o">=</span><span class="p">[]):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of sites common to the current Velocity Field object and the list of GMT_Points provided in argument</span>
<span class="sd">        Coordinates will be the ones from the Sinex and NOT from the list of Gpoints</span>
<span class="sd">        Commons point are points with same code pt and soln</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loutGpoint</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcode</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="n">linGpoint</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lcode</span><span class="p">:</span><span class="k">continue</span>
            <span class="n">lGpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span><span class="n">lcode</span><span class="o">=</span><span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">code</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">lGpoint</span><span class="p">:</span>
                    <span class="c1"># Test Prefit coordinates</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">xyz_distance</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">prefit</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;! Bad prefit (threshold value </span><span class="si">%8.3lf</span><span class="s2">) for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%10.1lf</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefit</span> <span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">xyz_distance</span><span class="p">(</span><span class="n">N</span><span class="p">)))</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># &#39;Match !&#39;</span>
                    <span class="n">loutGpoint</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> 
        <span class="k">return</span><span class="p">(</span><span class="n">loutGpoint</span><span class="p">)</span></div>
    

<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.proj_profile"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.proj_profile">[docs]</a>    <span class="k">def</span> <span class="nf">proj_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slon</span><span class="p">,</span> <span class="n">slat</span><span class="p">,</span> <span class="n">elon</span><span class="p">,</span> <span class="n">elat</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        project velocity components along a great circle defined by initial/stop points (slon,slat,elon,elat)</span>
<span class="sd">        </span>
<span class="sd">        :param slon,slat: coordinates of profile start point (decimal degrees) </span>
<span class="sd">        :param elon,elat: coordinates of profile end   point (decimal degrees)</span>
<span class="sd">        :param d        : maximum distance for a point to be considered</span>
<span class="sd">        :param save     : output file name (optional)</span>
<span class="sd">        </span>
<span class="sd">        :return         :  numpy 1D array with</span>
<span class="sd">        np_code, np_distance_along_profile, np_distance_to_profile , \</span>
<span class="sd">                np_Ve , np_Vn , np_SVe , np_SVn , \</span>
<span class="sd">                np_v_parallele , np_v_perpendicular , \</span>
<span class="sd">                np_sigma_v_parallele , np_sigma_v_perpendicular , np_lazimuth</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lcode</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ldistance_along_profile</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ldistance_to_profile</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">lVe</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lVn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lSVe</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lSVn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lv_parallele</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lv_perpendicular</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lsigma_v_parallele</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lsigma_v_perpendicular</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lazimuth</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Rt in meters</span>
        
        <span class="n">Rt</span> <span class="o">=</span> <span class="mf">6371.0E3</span>
        
        <span class="c1"># import</span>
        
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">from</span> <span class="nn">pyacs.lib</span> <span class="kn">import</span> <span class="n">coordinates</span> <span class="k">as</span> <span class="n">Coordinates</span>
        <span class="kn">from</span> <span class="nn">pyacs.lib</span> <span class="kn">import</span> <span class="n">vectors</span>
        <span class="kn">from</span> <span class="nn">pyacs.lib.gmtpoint</span> <span class="kn">import</span> <span class="n">GMT_Point</span>
        
        <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="p">)</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="o">.</span><span class="n">geo2xyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">slon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">slat</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">Xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="p">])</span>
        <span class="n">MS</span> <span class="o">=</span> <span class="n">GMT_Point</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">slon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">slat</span><span class="p">)</span>

        <span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span><span class="p">)</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="o">.</span><span class="n">geo2xyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">elon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">elat</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">Xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span><span class="p">])</span>
        <span class="n">ME</span> <span class="o">=</span> <span class="n">GMT_Point</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">elon</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">elat</span><span class="p">)</span>

        <span class="n">length_arc</span> <span class="o">=</span> <span class="n">MS</span><span class="o">.</span><span class="n">spherical_distance</span><span class="p">(</span><span class="n">ME</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>

        <span class="n">POLE</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">vector_product</span><span class="p">(</span><span class="n">Xi</span><span class="p">,</span> <span class="n">Xs</span><span class="p">)</span>
        <span class="n">POLE</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">POLE</span><span class="p">)</span>

        <span class="c1"># LOOP ON SITES</span>

        <span class="n">H_distance</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">M</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-- projecting &#39;</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="o">.</span><span class="n">geo2xyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        
            <span class="n">R</span> <span class="o">=</span> <span class="n">Coordinates</span><span class="o">.</span><span class="n">mat_rot_general_to_local</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;radians&#39;</span><span class="p">)</span>
            <span class="n">OM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
            
            <span class="n">OM</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">OM</span><span class="p">)</span>
        
            <span class="n">unit_parallele_xyz</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">vector_product</span><span class="p">(</span><span class="n">POLE</span><span class="p">,</span> <span class="n">OM</span><span class="p">)</span>
            <span class="n">unit_parallele_enu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">unit_parallele_xyz</span><span class="p">)</span>

            <span class="n">v_parallele</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">Ve</span> <span class="o">*</span> <span class="n">unit_parallele_enu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="o">.</span><span class="n">Vn</span> <span class="o">*</span> <span class="n">unit_parallele_enu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">v_perpendicular</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">Ve</span> <span class="o">*</span> <span class="n">unit_parallele_enu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">M</span><span class="o">.</span><span class="n">Vn</span> <span class="o">*</span> <span class="n">unit_parallele_enu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">unit_parallele_enu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unit_parallele_enu</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="c1"># longitude of M in the system having AOB as equator and P as north pole</span>
            <span class="c1"># to do that, we write the XYZ coordinates of M in the POLE/EQUATOR frame</span>
            <span class="c1"># </span>
            <span class="n">x_m</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">scal_prod</span><span class="p">(</span><span class="n">OM</span><span class="p">,</span> <span class="n">vectors</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">Xi</span><span class="p">))</span>
            <span class="n">y_m</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">scal_prod</span><span class="p">(</span><span class="n">OM</span><span class="p">,</span> <span class="n">vectors</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">vectors</span><span class="o">.</span><span class="n">vector_product</span><span class="p">(</span><span class="n">Xi</span><span class="p">,</span> <span class="o">-</span><span class="n">POLE</span><span class="p">)))</span>

            <span class="n">longitud_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y_m</span><span class="p">,</span> <span class="n">x_m</span><span class="p">)</span>
            <span class="n">distance_along_profile</span> <span class="o">=</span> <span class="n">longitud_m</span> <span class="o">*</span> <span class="n">Rt</span>

            <span class="c1"># distance to profile is obtained from the latitude in POLE/EQUATOR frame</span>

            <span class="n">z_m</span> <span class="o">=</span> <span class="n">vectors</span><span class="o">.</span><span class="n">scal_prod</span><span class="p">(</span><span class="n">OM</span><span class="p">,</span> <span class="n">POLE</span><span class="p">)</span>
            <span class="n">latitud_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">z_m</span><span class="p">)</span>
            
            <span class="c1"># distance_to_profile= np.fabs(latitud_m) * Rt</span>
            <span class="n">distance_to_profile</span> <span class="o">=</span> <span class="n">latitud_m</span> <span class="o">*</span> <span class="n">Rt</span>
            
            <span class="c1"># now propagates the vcv go get the uncertainty in each direction</span>
            <span class="c1"># we use the value of local azimuth of profile and the law of variance propagation</span>
            
            <span class="n">local_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)],</span> \
                              <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)]])</span>

            <span class="n">cov</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">SVe</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">SVn</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">SVen</span>
            <span class="n">vcv_en</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">M</span><span class="o">.</span><span class="n">SVe</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span> <span class="p">[</span><span class="n">cov</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">SVn</span> <span class="o">**</span> <span class="mi">2</span><span class="p">]])</span>
            <span class="n">vcv_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">local_R</span><span class="p">,</span> <span class="n">vcv_en</span><span class="p">),</span> <span class="n">local_R</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

            <span class="n">sigma_v_parallele</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vcv_profile</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">sigma_v_perpendicular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vcv_profile</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">distance_to_profile</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">distance_along_profile</span> <span class="o">/</span> <span class="mf">1000.0</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">distance_along_profile</span> <span class="o">/</span> <span class="mf">1000.0</span> <span class="o">&lt;=</span> <span class="n">length_arc</span><span class="p">):</span>

                <span class="n">lcode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                <span class="n">ldistance_along_profile</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance_along_profile</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span>
                <span class="n">ldistance_to_profile</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance_to_profile</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span>
                <span class="n">lVe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">Ve</span><span class="p">)</span>
                <span class="n">lVn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">Vn</span><span class="p">)</span>
                <span class="n">lSVe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">SVe</span><span class="p">)</span>
                <span class="n">lSVn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">SVn</span><span class="p">)</span>
                <span class="n">lv_parallele</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_parallele</span><span class="p">)</span>
                <span class="n">lv_perpendicular</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_perpendicular</span><span class="p">)</span>
                <span class="n">lsigma_v_parallele</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sigma_v_parallele</span><span class="p">)</span>
                <span class="n">lsigma_v_perpendicular</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sigma_v_perpendicular</span><span class="p">)</span>
                <span class="n">lazimuth</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">azimuth</span><span class="p">))</span>
                
                <span class="n">H_distance</span><span class="p">[</span><span class="n">distance_along_profile</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="s2">&quot;</span><span class="si">%4s</span><span class="s2">           </span><span class="si">%10.3lf</span><span class="s2">               </span><span class="si">%10.3lf</span><span class="s2">        </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2">    </span><span class="si">%10.2lf</span><span class="s2">          </span><span class="si">%10.2lf</span><span class="s2">              </span><span class="si">%10.2lf</span><span class="s2">            </span><span class="si">%10.2lf</span><span class="s2">          </span><span class="si">%10.1lf</span><span class="se">\n</span><span class="s2">&quot;</span>  \
                <span class="o">%</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">distance_along_profile</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">distance_to_profile</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">Ve</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">Vn</span> <span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">SVe</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">SVn</span><span class="p">,</span> <span class="n">v_parallele</span><span class="p">,</span> <span class="n">v_perpendicular</span><span class="p">,</span> <span class="n">sigma_v_parallele</span><span class="p">,</span> <span class="n">sigma_v_perpendicular</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)))</span>
        
        <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- writing results to &quot;</span><span class="p">,</span> <span class="n">save</span><span class="p">)</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            
            <span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#site  profile_distance_to_A (km)  distance_to_profile (km)       Ve         Vn        SVe        SVn    V_parallele     V_perpendicular            SV_parallele            SV_perpendicular        azimuth </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">distance</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">H_distance</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">H_distance</span><span class="p">[</span><span class="n">distance</span><span class="p">])</span>
                
            <span class="n">fs</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
        <span class="n">np_distance_along_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ldistance_along_profile</span><span class="p">)</span>
        <span class="n">lindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np_distance_along_profile</span><span class="p">)</span>
            
        <span class="n">np_code</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lcode</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)[</span><span class="n">lindex</span><span class="p">]</span>
        <span class="n">np_distance_along_profile</span> <span class="o">=</span> <span class="n">np_distance_along_profile</span><span class="p">[</span><span class="n">lindex</span><span class="p">]</span>
        <span class="n">np_distance_to_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ldistance_to_profile</span><span class="p">)[</span><span class="n">lindex</span><span class="p">]</span>
        <span class="n">np_Ve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lVe</span><span class="p">)[</span><span class="n">lindex</span><span class="p">]</span>
        <span class="n">np_Vn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lVn</span><span class="p">)[</span><span class="n">lindex</span><span class="p">]</span>
        <span class="n">np_SVe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lSVe</span><span class="p">)[</span><span class="n">lindex</span><span class="p">]</span>
        <span class="n">np_SVn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lSVn</span><span class="p">)[</span><span class="n">lindex</span><span class="p">]</span>
        <span class="n">np_v_parallele</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lv_parallele</span><span class="p">)[</span><span class="n">lindex</span><span class="p">]</span>
        <span class="n">np_v_perpendicular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lv_perpendicular</span><span class="p">)[</span><span class="n">lindex</span><span class="p">]</span>
        <span class="n">np_sigma_v_parallele</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lsigma_v_parallele</span><span class="p">)[</span><span class="n">lindex</span><span class="p">]</span>
        <span class="n">np_sigma_v_perpendicular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lsigma_v_perpendicular</span><span class="p">)[</span><span class="n">lindex</span><span class="p">]</span>
        <span class="n">np_lazimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lazimuth</span><span class="p">)[</span><span class="n">lindex</span><span class="p">]</span>

        <span class="k">return</span>  <span class="n">np_code</span><span class="p">,</span> <span class="n">np_distance_along_profile</span><span class="p">,</span> <span class="n">np_distance_to_profile</span> <span class="p">,</span> \
                <span class="n">np_Ve</span> <span class="p">,</span> <span class="n">np_Vn</span> <span class="p">,</span> <span class="n">np_SVe</span> <span class="p">,</span> <span class="n">np_SVn</span> <span class="p">,</span> \
                <span class="n">np_v_parallele</span> <span class="p">,</span> <span class="n">np_v_perpendicular</span> <span class="p">,</span> \
                <span class="n">np_sigma_v_parallele</span> <span class="p">,</span> <span class="n">np_sigma_v_perpendicular</span> <span class="p">,</span> <span class="n">np_lazimuth</span></div>


<span class="c1">###################################################################</span>
<div class="viewcode-block" id="Velocity_Field.strain"><a class="viewcode-back" href="../../../pyacs.lib.html#pyacs.lib.vel_field.Velocity_Field.strain">[docs]</a>    <span class="k">def</span> <span class="nf">strain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lcode</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;WLS&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="c1">###################################################################</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the strain rate given a list of sites</span>
<span class="sd">        </span>
<span class="sd">        :param lcode: list of site names </span>
<span class="sd">        :param save  : file to save the result</span>
<span class="sd">        :param method: estimator in &#39;L1&#39;,&#39;WLS&#39; (default: weighted least-squares &#39;WLS&#39;)</span>
<span class="sd">        :param verbose: verbose mode</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">pyacs.lib.strain</span>
        <span class="kn">import</span> <span class="nn">pyacs.lib.glinalg</span>
        
        <span class="c1"># prepare data</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">VE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">VN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">SVE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">SVN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">CVEN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">CODE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">lcode</span><span class="p">:</span>
            
            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">VE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VE</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">Ve</span><span class="p">)</span>
            <span class="n">VN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VN</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">Vn</span><span class="p">)</span>
            <span class="n">SVE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SVE</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">SVe</span><span class="p">)</span>
            <span class="n">SVN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SVN</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">SVn</span><span class="p">)</span>
            <span class="n">CVEN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CVEN</span><span class="p">,</span> <span class="n">M</span><span class="o">.</span><span class="n">SVen</span><span class="p">)</span>
            <span class="n">CODE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CODE</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        
        <span class="c1"># solve X0,Y0, DV</span>
        
        <span class="n">l0</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">SOL</span><span class="p">,</span> <span class="n">COV</span><span class="p">,</span> <span class="n">RESIDUALS</span> <span class="p">,</span> <span class="n">chi2</span> <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">strain</span><span class="o">.</span><span class="n">vgrad</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">VE</span><span class="p">,</span> <span class="n">VN</span><span class="p">,</span> <span class="n">SVE</span><span class="p">,</span> <span class="n">SVN</span><span class="p">,</span> <span class="n">CVEN</span><span class="p">,</span> <span class="n">CODE</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;WLS&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        
        <span class="n">CORR</span> <span class="p">,</span> <span class="n">SIGMA</span> <span class="o">=</span> <span class="n">pyacs</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">glinalg</span><span class="o">.</span><span class="n">cov_to_corr</span><span class="p">(</span><span class="n">COV</span><span class="p">)</span>

        <span class="p">[</span><span class="n">ve0</span><span class="p">,</span> <span class="n">vn0</span><span class="p">,</span> <span class="n">dvx_dx</span><span class="p">,</span> <span class="n">dvx_dy</span><span class="p">,</span> <span class="n">dvy_dx</span><span class="p">,</span> <span class="n">dvy_dy</span><span class="p">]</span> <span class="o">=</span> <span class="n">SOL</span>           
        <span class="p">[</span><span class="n">sve0</span><span class="p">,</span> <span class="n">svn0</span><span class="p">,</span> <span class="n">sdvx_dx</span><span class="p">,</span> <span class="n">sdvx_dy</span><span class="p">,</span> <span class="n">sdvy_dx</span><span class="p">,</span> <span class="n">sdvy_dy</span><span class="p">]</span> <span class="o">=</span> <span class="n">SIGMA</span>

        <span class="n">sven0</span> <span class="o">=</span> <span class="n">CORR</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># strain rate tensor, rotation rate and shear rates</span>
        
        <span class="c1"># From the definition of the strain rate tensor and rotation rate EPS = 0.5 * (DV + DV^T) &amp; omega = 0.5 * (DV - DV^T), </span>
        <span class="c1"># following D. Dong and K. Feigl, we derive EPS, omega and GAMMA using the linear transformation</span>
        
        <span class="c1">#     0 0  1  0   0  0  Edot11</span>
        <span class="c1">#     0 0  0 .5  .5  0  Edot12</span>
        <span class="c1">#     0 0  0  0   0  1  Edot22</span>
        <span class="c1">#     0 0  0 .5 -.5  0  omega</span>
        <span class="c1">#     0 0  1  0   0 -1  gamma1</span>
        <span class="c1">#     0 0  0  1   1  0  gamma2</span>

        <span class="n">TRANS_GRADV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">TRANS_GRADV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">TRANS_GRADV</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">TRANS_GRADV</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">TRANS_GRADV</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">TRANS_GRADV</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">TRANS_GRADV</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-.</span><span class="mi">5</span>
        <span class="n">TRANS_GRADV</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">TRANS_GRADV</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="n">TRANS_GRADV</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">TRANS_GRADV</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        
        <span class="n">TRANS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">TRANS_GRADV</span> <span class="p">,</span> <span class="n">SOL</span><span class="p">)</span>
        
        <span class="p">[</span><span class="n">edot11</span><span class="p">,</span> <span class="n">edot12</span><span class="p">,</span> <span class="n">edot22</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">gamma1</span><span class="p">,</span> <span class="n">gamma2</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRANS</span>
        
        <span class="c1"># variance</span>
        
        <span class="n">VAR_TRANS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">TRANS_GRADV</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">COV</span> <span class="p">,</span> <span class="n">TRANS_GRADV</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        
        <span class="n">COV_STRAIN_RATE</span> <span class="o">=</span> <span class="n">VAR_TRANS</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="c1"># uncertainties for omega, gamma1 &amp; gamma2</span>
        
        <span class="n">s_omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">VAR_TRANS</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="n">s_gamma1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">VAR_TRANS</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
        <span class="n">s_gamma2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">VAR_TRANS</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
        
        <span class="c1"># Epsilon1 &amp; 2</span>
        
        <span class="n">eps1</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">SOL</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">SOL</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">SOL</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">eps2</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">SOL</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">SOL</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">SOL</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        
        <span class="n">azimut</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">SOL</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">SOL</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span> <span class="o">+</span> <span class="mf">90.0</span>
        
        <span class="c1"># Gamma</span>
        
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">gamma1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">gamma2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="c1"># Uncertainties</span>
        
        <span class="n">term</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">SOL</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">SOL</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">dgdl11</span> <span class="o">=</span> <span class="n">term</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span>  <span class="p">(</span><span class="n">SOL</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">dgdl12</span> <span class="o">=</span> <span class="n">term</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span>  <span class="p">(</span><span class="n">SOL</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">dgdl21</span> <span class="o">=</span> <span class="n">term</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span>  <span class="p">(</span><span class="n">SOL</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">dgdl22</span> <span class="o">=</span> <span class="o">-</span><span class="n">term</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span>  <span class="p">(</span><span class="n">SOL</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        
        <span class="c1">#     partials of epsilon 1 with respect to comps of vel. grad. L</span>
        
        <span class="n">bigg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="c1">#     row 1 corresponds to epsilon 1</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mf">1.</span> <span class="o">*</span> <span class="p">(</span><span class="o">.</span><span class="mi">5</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">dgdl11</span><span class="p">)</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mf">1.</span> <span class="o">*</span> <span class="p">(</span><span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">dgdl12</span><span class="p">)</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mf">1.</span> <span class="o">*</span> <span class="p">(</span><span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">dgdl21</span><span class="p">)</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mf">1.</span> <span class="o">*</span> <span class="p">(</span><span class="o">.</span><span class="mi">5</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">dgdl22</span><span class="p">)</span>
        
        <span class="c1">#     row 2 corresponds to epsilon 2</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mf">1.</span> <span class="o">*</span> <span class="p">(</span><span class="o">.</span><span class="mi">5</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">dgdl11</span><span class="p">)</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="p">(</span><span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">dgdl12</span><span class="p">)</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="p">(</span><span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">dgdl21</span><span class="p">)</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mf">1.</span> <span class="o">*</span> <span class="p">(</span><span class="o">.</span><span class="mi">5</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">dgdl22</span><span class="p">)</span>
        
        <span class="c1">#     row 3 corresponds to theta</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="p">(</span><span class="n">SOL</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">SOL</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">term1</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-</span> <span class="n">SOL</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">term1</span> <span class="o">/</span> <span class="n">term3</span> <span class="o">/</span> <span class="n">term2</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">term3</span> <span class="o">/</span> <span class="n">term2</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">term3</span> <span class="o">/</span> <span class="n">term2</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">term1</span> <span class="o">/</span> <span class="n">term3</span> <span class="o">/</span> <span class="n">term2</span>
        
        <span class="c1">#     row 4 corresponds to maximum shear</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dgdl11</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dgdl12</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">dgdl21</span>
        <span class="n">bigg</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">dgdl22</span>

        <span class="n">UNC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bigg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">COV</span><span class="p">,</span> <span class="n">bigg</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
     
        <span class="p">[</span><span class="n">seps1</span><span class="p">,</span> <span class="n">seps2</span><span class="p">,</span> <span class="n">sazimut</span><span class="p">,</span> <span class="n">sgamma</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">UNC</span><span class="p">))</span>
        
        <span class="c1"># statistics</span>

        <span class="n">dof</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">6</span>
        
        <span class="k">if</span> <span class="n">dof</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">var_post</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">chi2</span> <span class="o">/</span> <span class="n">dof</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var_post</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="n">wrms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">chi2</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">SVE</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">SVN</span><span class="p">)))</span>
        
        <span class="c1"># significancy</span>
        
        <span class="n">SRV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">edot11</span><span class="p">,</span> <span class="n">edot12</span><span class="p">,</span> <span class="n">edot22</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">chi2_strain_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">SRV</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pyacs</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">glinalg</span><span class="o">.</span><span class="n">cov_to_invcov</span><span class="p">(</span><span class="n">COV_STRAIN_RATE</span><span class="p">),</span> <span class="n">SRV</span><span class="p">))</span>
        
        <span class="n">chi2_rotation_rate</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">s_omega</span> <span class="o">**</span> <span class="mi">2</span>
        
        <span class="c1"># print results</span>
        
        <span class="n">RS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;INFORMATION</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;----------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;file = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Number of sites used in strain rate calculation: </span><span class="si">%d</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lcode</span><span class="p">))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Velocity at barycenter </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="s2"> </span><span class="si">%10.2lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l0</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">ve0</span><span class="p">,</span> <span class="n">vn0</span><span class="p">,</span> <span class="n">sve0</span><span class="p">,</span> <span class="n">svn0</span><span class="p">,</span> <span class="n">sven0</span><span class="p">))</span>
        
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;VELOCITY GRADIENT TENSOR VALUES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;-------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;  dVx/dx     dVx/dy     dVy/dx      dVy/dy</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;----------  ---------  ----------  ---------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dvx_dx</span><span class="p">,</span> <span class="n">dvx_dy</span><span class="p">,</span> <span class="n">dvy_dx</span><span class="p">,</span> <span class="n">dvy_dy</span><span class="p">))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;VELOCITY GRADIENT TENSOR UNCERTAINTIES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;--------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot; sdVx/dx     sdVx/dy    sdVy/dx     sdVy/dy</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;----------   --------   ---------    --------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sdvx_dx</span><span class="p">,</span> <span class="n">sdvx_dy</span><span class="p">,</span> <span class="n">sdvy_dx</span><span class="p">,</span> <span class="n">sdvy_dy</span><span class="p">))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Unit: nstrain / year </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;FULL COVARIANCE MATRIX (not rescaled)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;-------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;ve     </span><span class="si">%10.5lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">COV</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;vn     </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">COV</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;dvx/dx </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">COV</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;dvx/dy </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">COV</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;dvy/dx </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">COV</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:</span><span class="mi">5</span><span class="p">]))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;dvy/dy </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">COV</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:</span><span class="mi">6</span><span class="p">]))</span>

        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;STRAIN RATE TENSOR</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;     Exx         Exy       Eyy</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;  --------   --------  ---------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">TRANS</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>

        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;STRAIN RATE COVARIANCE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;----------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;          Exx          Exy           Eyy</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Exx </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">COV_STRAIN_RATE</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Exy </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">COV_STRAIN_RATE</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Eyy </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">COV_STRAIN_RATE</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
        
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;PRINCIPAL AXIS </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;---------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Eps1 = </span><span class="si">%10.5lf</span><span class="s2"> +- </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">eps1</span><span class="p">,</span> <span class="n">seps1</span><span class="p">))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Eps2 = </span><span class="si">%10.5lf</span><span class="s2"> +- </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">eps2</span><span class="p">,</span> <span class="n">seps2</span><span class="p">))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Azimut : </span><span class="si">%10.5lf</span><span class="s2"> +- </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">azimut</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">sazimut</span><span class="p">)))</span>

        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Unit: nstrain / year and decimal degree</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Eps1: most extensional eigenvalue of strain tensor</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Eps2: most compressional eigenvalue of strain tensor</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Extension is taken positive</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;azimut is the one of eps2 in degrees CW from North.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;ROTATION</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;--------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;rotation in deg. / Myr :  </span><span class="si">%10.3lf</span><span class="s2"> +- </span><span class="si">%10.3lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">omega</span> <span class="o">*</span> <span class="mf">1.E-9</span> <span class="o">*</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">1.E6</span><span class="p">,</span> <span class="n">s_omega</span> <span class="o">*</span> <span class="mf">1.E-9</span> <span class="o">*</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">1.E6</span><span class="p">))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;rotation in rad /  yr  :  </span><span class="si">%.4E</span><span class="s2"> +- </span><span class="si">%.4E</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">omega</span> <span class="o">*</span> <span class="mf">1.E-9</span><span class="p">,</span> <span class="n">s_omega</span> <span class="o">*</span> <span class="mf">1.E-9</span><span class="p">))</span>

        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;SHEAR RATES</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;-----------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;gamma1 in nstrain / yr : </span><span class="si">%10.5lf</span><span class="s2"> +- </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gamma1</span><span class="p">,</span> <span class="n">s_gamma1</span><span class="p">))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;gamma2 in nstrain / yr : </span><span class="si">%10.5lf</span><span class="s2"> +- </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gamma2</span><span class="p">,</span> <span class="n">s_gamma2</span><span class="p">))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;gamma  in nstrain / yr : </span><span class="si">%10.5lf</span><span class="s2"> +- </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">sgamma</span><span class="p">))</span>

        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;STATISTICS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;----------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;chi2                       : </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chi2</span><span class="p">))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;degree of freedom          : </span><span class="si">%10d</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dof</span><span class="p">))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;posterior variance factor  : </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var_post</span><span class="p">))</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;wrms (mm/yr)               : </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wrms</span><span class="p">))</span>

        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;TEST OF SIGNIFICANCY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;--------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;tested              chi2      threshold values</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;parameter           values       95</span><span class="si">%       99%</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;-----------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;strain rate tensor </span><span class="si">%10.2lf</span><span class="s2">   7.82     11.35</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">chi2_strain_rate</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;rotation rate      </span><span class="si">%10.2lf</span><span class="s2">   3.84      6.64</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">chi2_rotation_rate</span><span class="p">)</span>

        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;RESIDUALS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;---------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;code      long.       lat.       Ve        Vn    Res_Ve    Res_Vn   sigma_Ve   sigma_Vn  RN_Ve     RN_Vn</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;---------------------------------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
       
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">RS</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%10.5lf</span><span class="s2"> </span><span class="si">%8.2lf</span><span class="s2">  </span><span class="si">%8.2lf</span><span class="s2">  </span><span class="si">%8.2lf</span><span class="s2">  </span><span class="si">%8.2lf</span><span class="s2">  </span><span class="si">%8.2lf</span><span class="s2">  </span><span class="si">%8.2lf</span><span class="s2">  </span><span class="si">%8.2lf</span><span class="s2">  </span><span class="si">%8.2lf</span><span class="s2">  </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> \
                   <span class="p">(</span><span class="n">CODE</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">VE</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">VN</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RESIDUALS</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">RESIDUALS</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="n">SVE</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">SVN</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">RESIDUALS</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">SVE</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RESIDUALS</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">SVN</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="p">(</span><span class="n">save</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">RS</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">save</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">RS</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="bp">self</span></div></div>
        
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Jean-Mathieu Nocquet IRD.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>