

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pyacs.sinex.sinex &mdash; pyacs 0.65.3 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> pyacs
          

          
          </a>

          
            
            
              <div class="version">
                0.65.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../foreword.html">What is pyacs?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">How to install pyacs?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../libraries.html">pyacs core libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gts.html">Time series library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../make_time_series.html">pyacs_make_time_series.py</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../time_series.html">Time series analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Full code documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyacs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyacs.sinex.sinex</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyacs.sinex.sinex</h1><div class="highlight"><pre>
<span></span><span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Module   : sinex</span>
<span class="c1"># Purpose  : Read, write and manipulate SINEX files</span>
<span class="c1"># Author   : P. Rebischung</span>
<span class="c1"># Created  : 20-May-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes  :</span>
<span class="c1">#</span>
<span class="c1"># Routines : - __init__            : Initialize a sinex object</span>
<span class="c1">#            - read                : Read a SINEX file into a sinex object</span>
<span class="c1">#            - write               : Write a sinex object into a SINEX file</span>
<span class="c1">#            - check_staid         : Check PT codes and DOMES numbers</span>
<span class="c1">#            - check_solns         : Check solns in an &quot;instantaneous&quot; solution</span>
<span class="c1">#            - check_erp           : Set ERP reference epochs to exactly noon</span>
<span class="c1">#            - get_xyz             : Get cartesian coordinates of specified stations</span>
<span class="c1">#            - get_plh             : Get geographical coordinates of specified stations</span>
<span class="c1">#            - get_lonlat          : Get longitudes and latitudes of specified stations</span>
<span class="c1">#            - get_sigenh          : Get E,N,H formal errors of specified stations</span>
<span class="c1">#            - get_helmert_matrix  : Get design matrix of Helmert parameters</span>
<span class="c1">#            - map                 : Draw station map</span>
<span class="c1">#            - propagate           : Propagate station positions to specified date</span>
<span class="c1">#            - remove_sta          : Remove specified stations from a solution</span>
<span class="c1">#            - keep_sta            : Keep only specified stations in a solution</span>
<span class="c1">#            - remove_sta_wo_domes : Remove stations without DOMES numbers from a solution</span>
<span class="c1">#            - keep_relevant_solns : Extract solns that a relevant to specified epoch from a solution</span>
<span class="c1">#            - remove_params       : Remove certain types of parameters from a solution</span>
<span class="c1">#            - remove_undef_params : Remove &quot;undefined&quot; parameters from a solution</span>
<span class="c1">#            - unconstrain         : Recover unconstrained normal equation from a solution</span>
<span class="c1">#            - prior2ref           : Change a priori values to reference values in a normal equation</span>
<span class="c1">#            - fix_params          : Fix certain types of parameters in a normal equation</span>
<span class="c1">#            - reduce_params       : Reduce certain types of parameters from a normal equation</span>
<span class="c1">#            - reduce_sta          : Reduce specified stations from a normal equation</span>
<span class="c1">#            - reduce_doublons     : Reduce stations appearing twice in a normal equation</span>
<span class="c1">#            - setup_geocenter     : Add geocenter coordinates into a normal equation</span>
<span class="c1">#            - setup_scale         : Add terrestrial scale into a normal equation</span>
<span class="c1">#            - add_min_const       : Add minimal constraints to normal matrix of constraints</span>
<span class="c1">#            - set_constraints     : Define normal matrix of constraints</span>
<span class="c1">#            - neqinv              : Invert normal equation</span>
<span class="c1">#            - rescale             : Multiply solution covariance matrix by given factor</span>
<span class="c1">#            - get_common_points   : Get list of common points between two solutions</span>
<span class="c1">#            - helmert_wrt         : Helmert comparison between two solutions</span>
<span class="c1">#            - trim_metadata       : Remove metadata that are not relevant for specified period</span>
<span class="c1">#            - update_stalist      : Given an AC solution, update list of stations in the IGS combined solution</span>
<span class="c1">#            - get_core            : Get list of core stations in a solution</span>
<span class="c1">#            - extract_core        : Extract core stations from a solution</span>
<span class="c1">#            - calib_lod           : Calibrate LOD estimates wrt reference series (Bulletin A)</span>
<span class="c1">#            - apriori_sf          : Compute a priori scale factor of a solution</span>
<span class="c1">#            - add_metadata        : Add metadata blocks into a sinex object</span>
<span class="c1">#            - get_residuals       : Compare solution to a reference solution and get necessary information for res file</span>
<span class="c1">#            - check_sat_pco       : Check satellite antenna phase center offsets</span>
<span class="c1">#            - correct_opoleload   : Correct ocean pole tide loading displacements in a normal equation</span>
<span class="c1">#            - write_solndomes     : Write special soln file with DOMES numbers (needed for IGS combination database)</span>
<span class="c1">#            - get_nonpubsolns     : Get list of solns to remove from official IGS cumulative solution</span>
<span class="c1">#            - add_psd             : Add post-seismic deformation models to a solution</span>
<span class="c1">#            - remove_psd          : Remove post-seismic deformation models from a solution</span>
<span class="c1">#            - add_per             : Add periodic terms to a solution</span>
<span class="c1">#            - plate_poles         : Estimate tectonic plate rotation poles from site velocities</span>
<span class="c1">#            - insert_disc         : Insert new &quot;discontinuity&quot; for a given station, by duplicating appropriate soln</span>
<span class="c1">#            - apply_offsets       : Apply position offsets to specified solns</span>
<span class="c1">#            - write_solndomes     : Write special soln file with DOMES numbers</span>
<span class="c1">#            - loadest_wrt         : Estimate surface load coefficients from comparison to a reference solution</span>
<span class="c1">#-------------------------------------------------------------------------------</span>



<span class="c1"># LIBRARIES</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">special</span>

<span class="kn">from</span> <span class="nn">.constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.snxutils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.mathutils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.date</span> <span class="kn">import</span> <span class="n">date</span>



<span class="c1"># CONSTANTS</span>
<span class="c1">#-------------------------------------------------------------------------------</span>

<span class="c1"># List of blocks of the SINEX format (unsupported blocks are commented)</span>
<span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FILE/REFERENCE&#39;</span><span class="p">,</span>                   <span class="c1">#  0</span>
          <span class="s1">&#39;FILE/COMMENT&#39;</span><span class="p">,</span>                     <span class="c1">#  1</span>
          <span class="s1">&#39;INPUT/HISTORY&#39;</span><span class="p">,</span>                    <span class="c1">#  2</span>
          <span class="s1">&#39;INPUT/FILES&#39;</span><span class="p">,</span>                      <span class="c1">#  3</span>
          <span class="s1">&#39;INPUT/ACKNOWLEDGEMENTS&#39;</span><span class="p">,</span>           <span class="c1">#  4</span>
          <span class="s1">&#39;SITE/ID&#39;</span><span class="p">,</span>                          <span class="c1">#  5</span>
          <span class="s1">&#39;SITE/RECEIVER&#39;</span><span class="p">,</span>                    <span class="c1">#  6</span>
          <span class="s1">&#39;SITE/ANTENNA&#39;</span><span class="p">,</span>                     <span class="c1">#  7</span>
          <span class="s1">&#39;SITE/GPS_PHASE_CENTER&#39;</span><span class="p">,</span>            <span class="c1">#  8</span>
          <span class="s1">&#39;SITE/ECCENTRICITY&#39;</span><span class="p">,</span>                <span class="c1">#  9</span>
          <span class="s1">&#39;SOLUTION/EPOCHS&#39;</span><span class="p">,</span>                  <span class="c1"># 10</span>
          <span class="s1">&#39;SOLUTION/ESTIMATE&#39;</span><span class="p">,</span>                <span class="c1"># 11</span>
          <span class="s1">&#39;SOLUTION/APRIORI&#39;</span><span class="p">,</span>                 <span class="c1"># 12</span>
          <span class="s1">&#39;SOLUTION/MATRIX_ESTIMATE&#39;</span><span class="p">,</span>         <span class="c1"># 13</span>
          <span class="s1">&#39;SOLUTION/MATRIX_APRIORI&#39;</span><span class="p">,</span>          <span class="c1"># 14</span>
          <span class="s1">&#39;SOLUTION/NORMAL_EQUATION_VECTOR&#39;</span><span class="p">,</span>  <span class="c1"># 15</span>
          <span class="s1">&#39;SOLUTION/NORMAL_EQUATION_MATRIX&#39;</span><span class="p">,</span>  <span class="c1"># 16</span>
          <span class="s1">&#39;SOLUTION/STATISTICS&#39;</span><span class="p">]</span>              <span class="c1"># 17</span>
          <span class="c1">#&#39;NUTATION/DATA&#39;,</span>
          <span class="c1">#&#39;PRECESSION/DATA&#39;,</span>
          <span class="c1">#&#39;SOURCE/ID&#39;,</span>
          <span class="c1">#&#39;SITE/DATA&#39;,</span>
          <span class="c1">#&#39;SITE/GAL_PHASE_CENTER&#39;,</span>
          <span class="c1">#&#39;SATELLITE/ID&#39;,</span>
          <span class="c1">#&#39;SATELLITE/PHASE_CENTER&#39;,</span>
          <span class="c1">#&#39;BIAS/EPOCHS&#39;]</span>

<span class="c1"># Default DOMES number</span>
<span class="n">default_domes</span> <span class="o">=</span> <span class="s1">&#39;     M   &#39;</span>



<span class="c1"># SINEX CLASS</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex">[docs]</a><span class="k">class</span> <span class="nc">sinex</span><span class="p">:</span>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : __init__</span>
<span class="c1"># Purpose : Initialize a sinex object</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 20-May-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   :</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file</span>     <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agency</span>   <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span>    <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span>    <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span>      <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tech</span>     <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npar</span>     <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const</span>    <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span>      <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span>    <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acks</span>     <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta</span>      <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antenna</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span>    <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span>        <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig</span>      <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior</span>    <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span>       <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig0</span>     <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span>        <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ntot</span>     <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Qc</span>       <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nc</span>       <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span>        <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span>        <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span>     <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nunk</span>     <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vPv</span>      <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigphase</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigcode</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dof</span>      <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vf</span>       <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lPl</span>      <span class="o">=</span> <span class="kc">None</span>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : read</span>
<span class="c1"># Purpose : Read a SINEX file into a sinex object</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 20-May-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes : PR, 04-Sep-2014 : Read SOLUTION/STATISTICS block</span>
<span class="c1">#</span>
<span class="c1"># Input   : - file : Name of SINEX file to read</span>
<span class="c1">#           - dont_read : List of keywords to indicate which blocks should not</span>
<span class="c1">#             be read. dont_read can include the following keywords:</span>
<span class="c1">#             &#39;matrices&#39; in order not to read matrices</span>
<span class="c1">#             &#39;comments&#39; in order not to read all &quot;comment&quot; blocks</span>
<span class="c1">#             &#39;apriori&#39;  in order not to read a priori information</span>
<span class="c1">#             &#39;metadata&#39; in order not to read receivers, antennas...</span>
<span class="c1"># Output  : - snx : sinex object</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.read"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.read">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">dont_read</span> <span class="o">=</span> <span class="p">[]):</span>

        <span class="c1"># Initializations</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="n">sinex</span><span class="p">()</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>
        <span class="n">adress</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
        <span class="n">read</span>   <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
        <span class="n">type_matest</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">type_matapr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># In function of argument dont_read, mark blocks which should not be read.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;matrices&#39;</span> <span class="ow">in</span> <span class="n">dont_read</span><span class="p">):</span>
            <span class="n">read</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">read</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">read</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;comments&#39;</span> <span class="ow">in</span> <span class="n">dont_read</span><span class="p">):</span>
            <span class="n">read</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;apriori&#39;</span> <span class="ow">in</span> <span class="n">dont_read</span><span class="p">):</span>
            <span class="n">read</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">read</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;metadata&#39;</span> <span class="ow">in</span> <span class="n">dont_read</span><span class="p">):</span>
            <span class="n">read</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span>

        <span class="c1"># Open input SINEX file</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="c1"># Read 1st line</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">agency</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span>

<span class="c1"># Don&#39;t know why does work any more in Python3.6        </span>
<span class="c1">#        snx.epoch = re.sub(&#39; &#39;, &#39;0&#39;, line[15:27])</span>
<span class="c1">#        snx.start = re.sub(&#39; &#39;, &#39;0&#39;, line[32:44])</span>
<span class="c1">#        snx.end = re.sub(&#39; &#39;, &#39;0&#39;, line[45:57])</span>
        <span class="c1">#print(line[15:27])</span>
        <span class="c1">#print(type(line[15:27]))</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">27</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">32</span><span class="p">:</span><span class="mi">44</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">end</span>   <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">45</span><span class="p">:</span><span class="mi">57</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
        
        <span class="n">snx</span><span class="o">.</span><span class="n">tech</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">58</span><span class="p">:</span><span class="mi">59</span><span class="p">]</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">66</span><span class="p">:</span><span class="mi">67</span><span class="p">]</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">68</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Read rest of the file to get adress of the blocks</span>
        <span class="c1"># Also get types of the matrices (COVA/CORR/INFO)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">):</span>
                <span class="n">block</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                    <span class="n">adress</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">25</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SOLUTION/MATRIX_ESTIMATE&#39;</span><span class="p">):</span>
                    <span class="n">type_matest</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="mi">32</span><span class="p">]</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SOLUTION/MATRIX_APRIORI&#39;</span><span class="p">):</span>
                    <span class="n">type_matapr</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">31</span><span class="p">]</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read FILE/REFERENCE block -&gt; snx.ref</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">output</span>      <span class="o">=</span> <span class="kc">None</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">contact</span>     <span class="o">=</span> <span class="kc">None</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">software</span>    <span class="o">=</span> <span class="kc">None</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">hardware</span>    <span class="o">=</span> <span class="kc">None</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">input</span>       <span class="o">=</span> <span class="kc">None</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DESCRIPTION&#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">20</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OUTPUT&#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">20</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CONTACT&#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">contact</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">20</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SOFTWARE&#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">20</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HARDWARE&#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">hardware</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">20</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;INPUT&#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">20</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read FILE/COMMENT block -&gt; snx.comment</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">comment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read INPUT/HISTORY block -&gt; snx.input</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">)):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">agency</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">epoch</span>   <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">27</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">start</span>   <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">32</span><span class="p">:</span><span class="mi">44</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">end</span>     <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">45</span><span class="p">:</span><span class="mi">57</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">tech</span>    <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">58</span><span class="p">:</span><span class="mi">59</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">npar</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">60</span><span class="p">:</span><span class="mi">65</span><span class="p">])</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">const</span>   <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">66</span><span class="p">:</span><span class="mi">67</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">68</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read INPUT/FILES block -&gt; complement snx.input</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">agency</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">epoch</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">agency</span><span class="o">+</span><span class="n">epoch</span> <span class="ow">in</span> <span class="p">[</span><span class="n">inp</span><span class="o">.</span><span class="n">agency</span><span class="o">+</span><span class="n">inp</span><span class="o">.</span><span class="n">epoch</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">input</span><span class="p">]):</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">inp</span><span class="o">.</span><span class="n">agency</span><span class="o">+</span><span class="n">inp</span><span class="o">.</span><span class="n">epoch</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">input</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">agency</span><span class="o">+</span><span class="n">epoch</span><span class="p">)</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">18</span><span class="p">:</span><span class="mi">47</span><span class="p">]</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">48</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read INPUT/ACKNOWLEDGEMENTS block -&gt; snx.acks</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">acks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">agency</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">acks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read SITE/ID block -&gt; snx.sta</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">5</span><span class="p">]):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sta</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">code</span>         <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">pt</span>           <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">domes</span>        <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">18</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">tech</span>         <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">description</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">:</span><span class="mi">43</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">lon</span>          <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">44</span><span class="p">:</span><span class="mi">55</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">lat</span>          <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">56</span><span class="p">:</span><span class="mi">67</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">h</span>            <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">68</span><span class="p">:</span><span class="mi">75</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">receiver</span>     <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">antenna</span>      <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">eccentricity</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">soln</span>         <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read SITE/RECEIVER block -&gt; snx.sta[*].receiver</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">6</span><span class="p">]):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="n">pt</span>   <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>

                    <span class="c1"># PATCH: Add possibly missing station into snx.sta</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">code</span><span class="o">+</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">])):</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="n">pt</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">domes</span> <span class="o">=</span> <span class="n">default_domes</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">tech</span> <span class="o">=</span> <span class="s1">&#39;P&#39;</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="mi">22</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="mi">11</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="mi">11</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="mi">7</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">receiver</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">antenna</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">eccentricity</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

                    <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">code</span><span class="o">+</span><span class="n">pt</span><span class="p">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">start</span>    <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">28</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">end</span>      <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">29</span><span class="p">:</span><span class="mi">41</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">type</span>     <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">42</span><span class="p">:</span><span class="mi">62</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">):</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">serie</span>    <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">63</span><span class="p">:</span><span class="mi">68</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">serie</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">serie</span> <span class="o">=</span> <span class="s1">&#39;-----&#39;</span>
                    <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">serie</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">serie</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">serie</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">firmware</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">69</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">receiver</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read SITE/ANTENNA block -&gt; snx.sta[*].antenna</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">7</span><span class="p">]):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="n">pt</span>   <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">code</span><span class="o">+</span><span class="n">pt</span><span class="p">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">start</span>    <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">28</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">end</span>      <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">29</span><span class="p">:</span><span class="mi">41</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">type</span>     <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">42</span><span class="p">:</span><span class="mi">62</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;    &#39;</span><span class="p">):</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;NONE&#39;</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">serie</span>    <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">63</span><span class="p">:</span><span class="mi">68</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">antenna</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read SITE/GPS_PHASE_CENTER block -&gt; snx.antenna</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">8</span><span class="p">]):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">antenna</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">21</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">serie</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">27</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">pco</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">pco</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="mi">34</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">pco</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">35</span><span class="p">:</span><span class="mi">41</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">pco</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">42</span><span class="p">:</span><span class="mi">48</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">pco</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">49</span><span class="p">:</span><span class="mi">55</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">pco</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">56</span><span class="p">:</span><span class="mi">62</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">pco</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">63</span><span class="p">:</span><span class="mi">69</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">model</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">70</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">antenna</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read SITE/ECCENTRICITY block -&gt; snx.sta[*].eccentricity</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">9</span><span class="p">]):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="n">pt</span>   <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">code</span><span class="o">+</span><span class="n">pt</span><span class="p">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">start</span>    <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">28</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">end</span>      <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">29</span><span class="p">:</span><span class="mi">41</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">system</span>   <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">42</span><span class="p">:</span><span class="mi">45</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">dx</span>       <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">46</span><span class="p">:</span><span class="mi">54</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">dx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">55</span><span class="p">:</span><span class="mi">63</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">dx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>    <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">64</span><span class="p">:</span><span class="mi">72</span><span class="p">]</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">eccentricity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read SOLUTION/EPOCHS block -&gt; snx.sta[*].soln</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">10</span><span class="p">]):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="n">pt</span>   <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">+</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">]):</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">code</span><span class="o">+</span><span class="n">pt</span><span class="p">)</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span>
<span class="c1">#                        r.datastart = re.sub(&#39; &#39;, &#39;0&#39;, line[16:28])</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">datastart</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">28</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">datastart</span> <span class="o">==</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">):</span>
                            <span class="n">r</span><span class="o">.</span><span class="n">datastart</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">start</span>
<span class="c1">#                        r.dataend = re.sub(&#39; &#39;, &#39;0&#39;, line[29:41])</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">dataend</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">29</span><span class="p">:</span><span class="mi">41</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">dataend</span> <span class="o">==</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">):</span>
                            <span class="n">r</span><span class="o">.</span><span class="n">dataend</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">end</span>
<span class="c1">#                        r.datamean = re.sub(&#39; &#39;, &#39;0&#39;, line[42:54])</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">datamean</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">42</span><span class="p">:</span><span class="mi">54</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">datamean</span> <span class="o">==</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">):</span>
                            <span class="n">mjd1</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_snxepoch</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">datastart</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span>
                            <span class="n">mjd2</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_snxepoch</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">dataend</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span>
                            <span class="n">r</span><span class="o">.</span><span class="n">datamean</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_mjd</span><span class="p">((</span><span class="n">mjd1</span> <span class="o">+</span> <span class="n">mjd2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">snxepoch</span><span class="p">()</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read SOLUTION/ESTIMATE block -&gt; snx.param, snx.x and snx.sig</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">11</span><span class="p">]):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">type</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">code</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">14</span><span class="p">:</span><span class="mi">18</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">pt</span>    <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">21</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">soln</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">]</span>
<span class="c1">#                    r.tref  = re.sub(&#39; &#39;, &#39;0&#39;, line[27:39])</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">tref</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">39</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">unit</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">40</span><span class="p">:</span><span class="mi">44</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">45</span><span class="p">:</span><span class="mi">46</span><span class="p">]</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">47</span><span class="p">:</span><span class="mi">68</span><span class="p">]))</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">69</span><span class="p">:</span><span class="mi">80</span><span class="p">]))</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="n">snx</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">npar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">)</span>

        <span class="c1"># Read SOLUTION/APRIORI block -&gt; snx.prior, snx.x0 and snx.sig0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">12</span><span class="p">]):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">type</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">code</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">14</span><span class="p">:</span><span class="mi">18</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">pt</span>    <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">21</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">soln</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">tref</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">27</span><span class="p">:</span><span class="mi">39</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">unit</span>  <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">40</span><span class="p">:</span><span class="mi">44</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">45</span><span class="p">:</span><span class="mi">46</span><span class="p">]</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">47</span><span class="p">:</span><span class="mi">68</span><span class="p">]))</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">69</span><span class="p">:</span><span class="mi">80</span><span class="p">]))</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="n">snx</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">)</span>

        <span class="c1"># Read SOLUTION/MATRIX_ESTIMATE block -&gt; snx.Q or snx.Ntot</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">13</span><span class="p">]):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="c1"># Read matrix</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">))</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">13</span><span class="p">:</span><span class="mi">34</span><span class="p">])</span>
                    <span class="n">Q</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">35</span><span class="p">:</span><span class="mi">56</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                        <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">35</span><span class="p">:</span><span class="mi">56</span><span class="p">])</span>
                        <span class="n">Q</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">57</span><span class="p">:</span><span class="mi">78</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                        <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">57</span><span class="p">:</span><span class="mi">78</span><span class="p">])</span>
                        <span class="n">Q</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="c1"># If covariance or correlation matrix, store matrix in snx.Q</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">type_matest</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CORR&#39;</span><span class="p">,</span> <span class="s1">&#39;COVA&#39;</span><span class="p">]):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span>

                <span class="c1"># If correlation matrix, compute covariances</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type_matest</span> <span class="o">==</span> <span class="s1">&#39;CORR&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                            <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                            <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

            <span class="c1"># If normal matrix, store matrix in snx.Ntot</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">type_matest</span> <span class="o">==</span> <span class="s1">&#39;INFO&#39;</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Ntot</span> <span class="o">=</span> <span class="n">Q</span>

        <span class="c1"># Read SOLUTION/MATRIX_APRIORI block -&gt; snx.Qc or snx.Nc</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">14</span><span class="p">]):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="c1"># Read matrix</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">))</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">13</span><span class="p">:</span><span class="mi">34</span><span class="p">])</span>
                    <span class="n">Q</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">35</span><span class="p">:</span><span class="mi">56</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                        <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">35</span><span class="p">:</span><span class="mi">56</span><span class="p">])</span>
                        <span class="n">Q</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">57</span><span class="p">:</span><span class="mi">78</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                        <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">57</span><span class="p">:</span><span class="mi">78</span><span class="p">])</span>
                        <span class="n">Q</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="c1"># If covariance or correlation matrix, store matrix in snx.Qc</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">type_matapr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CORR&#39;</span><span class="p">,</span> <span class="s1">&#39;COVA&#39;</span><span class="p">]):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">=</span> <span class="n">Q</span>

                <span class="c1"># If correlation matrix, compute covariances</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">type_matapr</span> <span class="o">==</span> <span class="s1">&#39;CORR&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                            <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                            <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

            <span class="c1"># If normal matrix, store matrix in snx.Nc</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">type_matapr</span> <span class="o">==</span> <span class="s1">&#39;INFO&#39;</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">Q</span>

        <span class="c1"># Read SOLUTION/NORMAL_EQUATION_VECTOR block -&gt; snx.k</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">15</span><span class="p">]):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">47</span><span class="p">:</span><span class="mi">68</span><span class="p">])</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read SOLUTION/NORMAL_EQUATION_MATRIX block -&gt; snx.N</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">16</span><span class="p">]):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">))</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">13</span><span class="p">:</span><span class="mi">34</span><span class="p">])</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">35</span><span class="p">:</span><span class="mi">56</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">35</span><span class="p">:</span><span class="mi">56</span><span class="p">])</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">57</span><span class="p">:</span><span class="mi">78</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">57</span><span class="p">:</span><span class="mi">78</span><span class="p">])</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Read SOLUTION/STATISTICS block</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="ow">and</span> <span class="n">read</span><span class="p">[</span><span class="mi">17</span><span class="p">]):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">adress</span><span class="p">[</span><span class="mi">17</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">31</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NUMBER OF OBSERVATIONS        &#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">nobs</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">32</span><span class="p">:])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">31</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NUMBER OF UNKNOWNS            &#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">nunk</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">32</span><span class="p">:])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">31</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SAMPLING INTERVAL (SECONDS)   &#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">sampling</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">32</span><span class="p">:])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">31</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SQUARE SUM OF RESIDUALS (VTPV)&#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">vPv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">32</span><span class="p">:])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">31</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PHASE MEASUREMENTS SIGMA      &#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">sigphase</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">32</span><span class="p">:])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">31</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CODE MEASUREMENTS SIGMA       &#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">sigcode</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">32</span><span class="p">:])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">31</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NUMBER OF DEGREES OF FREEDOM  &#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">32</span><span class="p">:])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">31</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VARIANCE FACTOR               &#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">vf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">32</span><span class="p">:])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">31</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WEIGHTED SQUARE SUM OF O-C    &#39;</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">lPl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">32</span><span class="p">:])</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Close input SINEX file</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">snx</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : write</span>
<span class="c1"># Purpose : Write a sinex object into a SINEX file</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 22-May-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - file         : Name of SINEX file to write</span>
<span class="c1">#           - dont_write   : List of keywords to indicate which blocks should not</span>
<span class="c1">#                            be written. dont_write can include the following keywords:</span>
<span class="c1">#                            &#39;matrices&#39; in order not to write matrices</span>
<span class="c1">#                            &#39;comments&#39; in order not to write all &quot;comment&quot; blocks</span>
<span class="c1">#                            &#39;apriori&#39;  in order not to write a priori information</span>
<span class="c1">#                            &#39;metadata&#39; in order not to write receivers, antennas...</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.write"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">dont_write</span><span class="o">=</span><span class="p">[],</span> <span class="n">epochs_style</span><span class="o">=</span><span class="s1">&#39;new&#39;</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># Open output SINEX file</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># Update snx.epoch and write first line</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">snxepoch</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;%=SNX 2.02 </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{0}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">agency</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">epoch</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">tech</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">const</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>

        <span class="c1"># Write FILE/REFERENCE block</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+FILE/REFERENCE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">description</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:&lt;18}</span><span class="s1"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;DESCRIPTION&#39;</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">output</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:&lt;18}</span><span class="s1"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;OUTPUT&#39;</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">output</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">contact</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:&lt;18}</span><span class="s1"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;CONTACT&#39;</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">contact</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">software</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:&lt;18}</span><span class="s1"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;SOFTWARE&#39;</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">software</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">hardware</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:&lt;18}</span><span class="s1"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;HARDWARE&#39;</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">hardware</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">input</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:&lt;18}</span><span class="s1"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;INPUT&#39;</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">input</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-FILE/REFERENCE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write FILE/COMMENT block</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+FILE/COMMENT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">comment</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-FILE/COMMENT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write INPUT/ACKNOWLEDGEMENTS block</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">acks</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+INPUT/ACKNOWLEDGEMENTS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*AGY ______________________________FULL_DESCRIPTION_____________________________</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">acks</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">agency</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-INPUT/ACKNOWLEDGEMENTS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write INPUT/HISTORY block</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">input</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+INPUT/HISTORY</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*_VERSION_ CRE __CREATION__ OWN _DATA_START_ __DATA_END__ T PARAM S ____TYPE____</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; +SNX </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">agency</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">epoch</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">tech</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">const</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; =SNX 2.02 </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{0}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">agency</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">epoch</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">tech</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">const</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-INPUT/HISTORY</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write INPUT/FILES block</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">input</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+INPUT/FILES</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*OWN __CREATION__ ___________FILENAME__________ ___________DESCRIPTION__________</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">agency</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">description</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-INPUT/FILES</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SITE/ID block</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SITE/ID</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*CODE PT __DOMES__ T _STATION DESCRIPTION__ _LONGITUDE_ _LATITUDE__ HEIGHT_</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">domes</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">tech</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SITE/ID</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SITE/RECEIVER block</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SITE/RECEIVER</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*CODE PT SOLN T _DATA START_ __DATA_END__ ___RECEIVER_TYPE____ _S/N_ _FIRMWARE__</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">receiver</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> ---- </span><span class="si">{2}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">tech</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="s1"> </span><span class="si">{4}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">serie</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">firmware</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SITE/RECEIVER</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SITE/ANTENNA block</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SITE/ANTENNA</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*CODE PT SOLN T _DATA START_ __DATA_END__ ____ANTENNA_TYPE____ _S/N_</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">antenna</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> ---- </span><span class="si">{2}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">tech</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">serie</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SITE/ANTENNA</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SITE/GPS_PHASE_CENTER block</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">antenna</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SITE/GPS_PHASE_CENTER</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*________TYPE________ _S/N_ _L1_U_ _L1_N_ _L1_E_ _L2_U_ _L2_N_ _L2_E_ __MODEL___</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">antenna</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">serie</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pco</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">model</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SITE/GPS_PHASE_CENTER</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SITE/ECCENTRICITY block</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SITE/ECCENTRICITY</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*CODE PT SOLN T _DATA START_ __DATA_END__ REF __DX_U__ __DX_N__ __DX_E__</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">eccentricity</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> ---- </span><span class="si">{2}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">tech</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">system</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">dx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">e</span><span class="o">.</span><span class="n">dx</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SITE/ECCENTRICITY</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SOLUTION/EPOCHS block</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SOLUTION/EPOCHS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*CODE PT SOLN T _DATA_START_ __DATA_END__ _MEAN_EPOCH_</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">soln</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">tech</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">datastart</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">dataend</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">datamean</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SOLUTION/EPOCHS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SOLUTION/APRIORI block</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;apriori&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SOLUTION/APRIORI</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*INDEX _TYPE_ CODE PT SOLN _REF_EPOCH__ UNIT S ____APRIORI_VALUE____ __STD_DEV__</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:5}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="s1"> </span><span class="si">{4}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">soln</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3:21.14e}</span><span class="s1"> </span><span class="si">{4:11.5e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">tref</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">const</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SOLUTION/APRIORI</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SOLUTION/ESTIMATE block</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SOLUTION/ESTIMATE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*INDEX _TYPE_ CODE PT SOLN _REF_EPOCH__ UNIT S ___ESTIMATED_VALUE___ __STD_DEV__</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:5}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="s1"> </span><span class="si">{4}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">soln</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3:21.14e}</span><span class="s1"> </span><span class="si">{4:11.5e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">tref</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">const</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SOLUTION/ESTIMATE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SOLUTION/MATRIX_APRIORI block (case of covariance matrix)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;matrices&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;apriori&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SOLUTION/MATRIX_APRIORI L COVA</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*PARA1 PARA2 _______PARA2+0_______ _______PARA2+1_______ _______PARA2+2_______</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:5}</span><span class="s1"> </span><span class="si">{1:5}</span><span class="s1"> </span><span class="si">{2:21.14e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">3</span>
                        <span class="k">elif</span> <span class="p">((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">2</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SOLUTION/MATRIX_APRIORI L COVA</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SOLUTION/MATRIX_APRIORI block (case of normal matrix)</span>
        <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;NoneType&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;matrices&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;apriori&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SOLUTION/MATRIX_APRIORI L INFO</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*PARA1 PARA2 _______PARA2+0_______ _______PARA2+1_______ _______PARA2+2_______</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:5}</span><span class="s1"> </span><span class="si">{1:5}</span><span class="s1"> </span><span class="si">{2:21.14e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">3</span>
                        <span class="k">elif</span> <span class="p">((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">2</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SOLUTION/MATRIX_APRIORI L INFO</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SOLUTION/MATRIX_ESTIMATE block (case of covariance matrix)</span>
        <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;NoneType&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;matrices&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SOLUTION/MATRIX_ESTIMATE L COVA</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*PARA1 PARA2 _______PARA2+0_______ _______PARA2+1_______ _______PARA2+2_______</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
                <span class="c1">#j = 0</span>
                <span class="c1">#while (j &lt;= i):</span>
                    <span class="c1">#f.write(&#39; {0:5} {1:5} {2:21.14e}&#39;.format(i+1, j+1, snx.Q[i,j]))</span>
                    <span class="c1">#if (j+1 &lt;= i):</span>
                        <span class="c1">#j = j+1</span>
                        <span class="c1">#f.write(&#39; {0:21.14e}&#39;.format(snx.Q[i,j]))</span>
                        <span class="c1">#if (j+1 &lt;= i):</span>
                            <span class="c1">#j = j+1</span>
                            <span class="c1">#f.write(&#39; {0:21.14e}\n&#39;.format(snx.Q[i,j]))</span>
                        <span class="c1">#else:</span>
                            <span class="c1">#f.write(&#39;\n&#39;)</span>
                    <span class="c1">#else:</span>
                        <span class="c1">#f.write(&#39;\n&#39;)</span>
                    <span class="c1">#j = j+1</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:5}</span><span class="s1"> </span><span class="si">{1:5}</span><span class="s1"> </span><span class="si">{2:21.14e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">3</span>
                        <span class="k">elif</span> <span class="p">((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">2</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SOLUTION/MATRIX_ESTIMATE L COVA</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SOLUTION/MATRIX_ESTIMATE block (case of total normal matrix)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">Ntot</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;matrices&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SOLUTION/MATRIX_ESTIMATE L INFO</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*PARA1 PARA2 _______PARA2+0_______ _______PARA2+1_______ _______PARA2+2_______</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
                <span class="c1">#j = 0</span>
                <span class="c1">#while (j &lt;= i):</span>
                    <span class="c1">#f.write(&#39; {0:5} {1:5} {2:21.14e}&#39;.format(i+1, j+1, snx.Ntot[i,j]))</span>
                    <span class="c1">#if (j+1 &lt;= i):</span>
                        <span class="c1">#j = j+1</span>
                        <span class="c1">#f.write(&#39; {0:21.14e}&#39;.format(snx.Ntot[i,j]))</span>
                        <span class="c1">#if (j+1 &lt;= i):</span>
                            <span class="c1">#j = j+1</span>
                            <span class="c1">#f.write(&#39; {0:21.14e}\n&#39;.format(snx.Ntot[i,j]))</span>
                        <span class="c1">#else:</span>
                            <span class="c1">#f.write(&#39;\n&#39;)</span>
                    <span class="c1">#else:</span>
                        <span class="c1">#f.write(&#39;\n&#39;)</span>
                    <span class="c1">#j = j+1</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Ntot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:5}</span><span class="s1"> </span><span class="si">{1:5}</span><span class="s1"> </span><span class="si">{2:21.14e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">Ntot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Ntot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Ntot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Ntot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">3</span>
                        <span class="k">elif</span> <span class="p">((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Ntot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Ntot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">2</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SOLUTION/MATRIX_ESTIMATE L INFO</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SOLUTION/NORMAL_EQUATION_VECTOR block</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">k</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;matrices&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SOLUTION/NORMAL_EQUATION_VECTOR</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*INDEX _TYPE_ CODE PT SOLN _REF_EPOCH__ UNIT S ___ESTIMATED_VALUE___</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span>  <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:5}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="s1"> </span><span class="si">{4}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">soln</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3:21.14e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">tref</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">const</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SOLUTION/NORMAL_EQUATION_VECTOR</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write SOLUTION/NORMAL_EQUATION_MATRIX block</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;matrices&#39;</span> <span class="ow">in</span> <span class="n">dont_write</span><span class="p">))):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*-------------------------------------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;+SOLUTION/NORMAL_EQUATION_MATRIX</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*PARA1 PARA2 _______PARA2+0_______ _______PARA2+1_______ _______PARA2+2_______</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:5}</span><span class="s1"> </span><span class="si">{1:5}</span><span class="s1"> </span><span class="si">{2:21.14e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">):</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">):</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0:21.14e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-SOLUTION/NORMAL_EQUATION_MATRIX</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write last line and close output SINEX file</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%E</span><span class="s1">NDSNX</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : check_staid</span>
<span class="c1"># Purpose : Check PT codes and DOMES numbers</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 12-Aug-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes : PR, 27-Jan-2017 : Add possibility to check station coordinates in case</span>
<span class="c1">#                             of multiple possible DOMES numbers</span>
<span class="c1">#           PR, 27-Jan-2017 : Add possibility to update SINEX station description</span>
<span class="c1">#                             from DOMES number catalogue</span>
<span class="c1">#</span>
<span class="c1"># Input   : - codomes    : DOMES number catalogue</span>
<span class="c1">#           - check_pt   : True if PT codes should be checked. Default is True.</span>
<span class="c1">#           - check_crd  : True if station coordinates should be checked in case of</span>
<span class="c1">#                          multiple DOMES numbers. Default is True.</span>
<span class="c1">#           - check_desc : True if station descriptions should be updated from DOMES</span>
<span class="c1">#                          number catalogue. Default is True.</span>
<span class="c1">#           - log        : Log file. Default is &#39;None&#39;.</span>
<span class="c1">#           - append     : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  : - modif      : True if any modification has to be made</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.check_staid"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.check_staid">[docs]</a>    <span class="k">def</span> <span class="nf">check_staid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codomes</span><span class="p">,</span> <span class="n">check_pt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_crd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_desc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># If necessary, open log file and write header</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">append</span><span class="p">):</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sinex::check_staid : Check PT codes and DOMES numbers</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Initialization</span>
        <span class="n">modif</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Loop over stations</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">)):</span>
            <span class="n">code</span>  <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">code</span>
            <span class="n">pt</span>    <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span>
            <span class="n">domes</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">domes</span>

            <span class="c1"># Check PT code</span>
            <span class="c1"># -------------</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">check_pt</span><span class="p">):</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># PT should be &#39; A&#39; for all stations...</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">code</span> <span class="o">!=</span> <span class="s1">&#39;IISC&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">code</span> <span class="o">!=</span> <span class="s1">&#39;KELY&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pt</span> <span class="o">!=</span> <span class="s1">&#39; A&#39;</span><span class="p">)):</span>
                    <span class="n">modif</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">mod</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">pt2</span> <span class="o">=</span> <span class="s1">&#39; A&#39;</span>

                <span class="c1"># ...except IISC and KELY.</span>
                <span class="k">elif</span> <span class="p">((</span><span class="n">code</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;IISC&#39;</span><span class="p">,</span> <span class="s1">&#39;KELY&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pt</span> <span class="o">!=</span> <span class="s1">&#39; B&#39;</span><span class="p">)):</span>
                    <span class="n">modif</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">mod</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">pt2</span> <span class="o">=</span> <span class="s1">&#39; B&#39;</span>

                <span class="c1"># If a correction is needed</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">):</span>

                    <span class="c1"># Correct PT in snx.sta</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="n">pt2</span>

                    <span class="c1"># Correct PT in snx.param</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">code</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="o">==</span> <span class="n">pt</span><span class="p">)):</span>
                            <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="n">pt2</span>

                    <span class="c1"># Correct PT in snx.prior</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">code</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="o">==</span> <span class="n">pt</span><span class="p">)):</span>
                                <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="n">pt2</span>

                    <span class="c1"># Print message in log file</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
                        <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;PT corrected    : </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{3}</span><span class="s1"> =&gt; </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> </span><span class="si">{3}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">pt2</span><span class="p">,</span> <span class="n">domes</span><span class="p">))</span>

            <span class="c1"># Check DOMES number</span>
            <span class="c1"># ------------------</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># 1st case: Do not check station coordinates</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">check_crd</span><span class="p">)):</span>
                <span class="k">pass</span>

                <span class="c1">## If code+domes is found in DOMES number catalogue, everything is fine.</span>
                <span class="c1">## Else...</span>
                <span class="c1">#if (not(code+domes in [c.code+c.domes for c in codomes])):</span>

                    <span class="c1">## If code is nevertheless found in DOMES number catalogue, a correction is needed.</span>
                    <span class="c1">#if (code in [c.code for c in codomes]):</span>
                        <span class="c1">#j = [c.code for c in codomes].index(code)</span>
                        <span class="c1">#modif = True</span>
                        <span class="c1">#mod = True</span>
                        <span class="c1">#domes2 = codomes[j].domes</span>

                    <span class="c1">## If code is not found in DOMES number catalogue, set default DOMES number.</span>
                    <span class="c1">#elif (domes != default_domes):</span>
                        <span class="c1">#modif = True</span>
                        <span class="c1">#mod = True</span>
                        <span class="c1">#domes2 = default_domes</span>

            <span class="c1"># 2nd case: Check station coordinates</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Look for every occurence of code in DOMES number catalogue</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">codomes</span><span class="p">])</span> <span class="o">==</span> <span class="n">code</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># If no occurence is found, set default DOMES number if needed.</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">domes</span> <span class="o">!=</span> <span class="n">default_domes</span><span class="p">):</span>
                        <span class="n">modif</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">domes2</span> <span class="o">=</span> <span class="n">default_domes</span>

                <span class="c1"># If one occurence is found,</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Change DOMES number if needed</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">domes</span> <span class="o">!=</span> <span class="n">codomes</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">domes</span><span class="p">):</span>
                        <span class="n">modif</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">domes2</span> <span class="o">=</span> <span class="n">codomes</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">domes</span>

                    <span class="c1"># Change station description if needed</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">check_desc</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">codomes</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">description</span>

                <span class="c1"># If several occurences are found,</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="c1"># Get station coordinates</span>
                    <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">get_lonlat</span><span class="p">([</span><span class="n">code</span><span class="p">])</span>
                    <span class="n">lam</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">phi</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Compute distances to every point of the DOMES number catalogue</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
                        <span class="n">lamj</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">codomes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">lon</span>
                        <span class="n">phij</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">codomes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">lat</span>
                        <span class="n">d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">acos</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">phij</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">phij</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="n">lamj</span><span class="p">))</span>

                    <span class="c1"># Index of the closest point</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">d</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Change DOMES number if needed</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">domes</span> <span class="o">!=</span> <span class="n">codomes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">domes</span><span class="p">):</span>
                        <span class="n">modif</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">domes2</span> <span class="o">=</span> <span class="n">codomes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">domes</span>

                    <span class="c1"># Change station description if needed</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">check_desc</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">codomes</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">description</span>

            <span class="c1"># Correct DOMES number in snx.sta</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mod</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">domes</span> <span class="o">=</span> <span class="n">domes2</span>

                <span class="c1"># Print message in log file</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
                    <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;DOMES corrected : </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> =&gt; </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{3}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">domes</span><span class="p">,</span> <span class="n">domes2</span><span class="p">))</span>

        <span class="c1"># Close log file if necessary</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">modif</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : check_solns</span>
<span class="c1"># Purpose : Check solns in an &quot;instantaneous&quot; solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 12-Aug-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - solns  : Discontinuity list</span>
<span class="c1">#           - log    : Log file. Default is &#39;None&#39;.</span>
<span class="c1">#           - append : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.check_solns"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.check_solns">[docs]</a>    <span class="k">def</span> <span class="nf">check_solns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solns</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># If necessary, open log file and write header</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">append</span><span class="p">):</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sinex::check_solns : Check solution numbers</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># 1 - Check solns of estimated parameters</span>
        <span class="c1"># ---------------------------------------</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># If current station is found in solns table,</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">]):</span>
                    <span class="n">ista</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>

                    <span class="c1"># Look for appropriate soln</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tref</span>
                    <span class="n">isoln</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="p">((</span><span class="n">solns</span><span class="p">[</span><span class="n">ista</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">isoln</span><span class="p">]</span><span class="o">.</span><span class="n">end</span> <span class="o">!=</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">earlier</span><span class="p">(</span><span class="n">solns</span><span class="p">[</span><span class="n">ista</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">isoln</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">t</span><span class="p">))):</span>
                        <span class="n">isoln</span> <span class="o">=</span> <span class="n">isoln</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">soln2</span> <span class="o">=</span> <span class="n">solns</span><span class="p">[</span><span class="n">ista</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">isoln</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span>

                <span class="c1"># Else, default soln is &#39;   1&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">soln2</span> <span class="o">=</span> <span class="s1">&#39;   1&#39;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
                        <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;### </span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> not found in soln catalogue !</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

                <span class="c1"># If soln has to be modified,</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="o">!=</span> <span class="n">soln2</span><span class="p">):</span>

                    <span class="c1"># Print message in log file</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
                        <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> </span><span class="si">{0.soln}</span><span class="s1"> =&gt; </span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">soln2</span><span class="p">))</span>

                    <span class="c1"># Modify soln in snx.param</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="n">soln2</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="n">soln2</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="n">soln2</span>

                <span class="c1"># Modify soln in snx.sta</span>
                <span class="n">ista</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">ista</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="n">soln2</span>

        <span class="c1"># 2 - Check solns of a priori parameters</span>
        <span class="c1"># --------------------------------------</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                    <span class="c1"># If current station is found in solns table,</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">]):</span>
                        <span class="n">ista</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>

                        <span class="c1"># Look for appropriate soln</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tref</span>
                        <span class="n">isoln</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">while</span> <span class="p">((</span><span class="n">solns</span><span class="p">[</span><span class="n">ista</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">isoln</span><span class="p">]</span><span class="o">.</span><span class="n">end</span> <span class="o">!=</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">earlier</span><span class="p">(</span><span class="n">solns</span><span class="p">[</span><span class="n">ista</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">isoln</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="n">t</span><span class="p">))):</span>
                            <span class="n">isoln</span> <span class="o">=</span> <span class="n">isoln</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">soln2</span> <span class="o">=</span> <span class="n">solns</span><span class="p">[</span><span class="n">ista</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">isoln</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span>

                    <span class="c1"># Else, default soln is &#39;   1&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">soln2</span> <span class="o">=</span> <span class="s1">&#39;   1&#39;</span>

                    <span class="c1"># If necessary, modify soln in snx.prior</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="o">!=</span> <span class="n">soln2</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="n">soln2</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="n">soln2</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="n">soln2</span>

        <span class="c1"># Close log file if necessary</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : check_erp</span>
<span class="c1"># Purpose : Set ERP reference epochs to exactly noon</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 24-May-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   :</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.check_erp"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.check_erp">[docs]</a>    <span class="k">def</span> <span class="nf">check_erp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># Check epochs of estimated ERPs</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;XPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;UT    &#39;</span><span class="p">,</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">tref</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;43200&#39;</span><span class="p">):</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">tref</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">tref</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;43200&#39;</span>

        <span class="c1"># Check epochs of a priori ERPs</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;XPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;UT    &#39;</span><span class="p">,</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">tref</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;43200&#39;</span><span class="p">):</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">tref</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">tref</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;43200&#39;</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : get_xyz</span>
<span class="c1"># Purpose : Get cartesian coordinates of specified stations</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 05-Jul-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - code : 4-char codes</span>
<span class="c1">#           - pt   : PT codes. Default is None.</span>
<span class="c1">#           - soln : Solns. Default is None.</span>
<span class="c1"># Output  : - X    : [X, Y, Z] cartesian coordinates in m</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.get_xyz"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.get_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">get_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">soln</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># Initialization</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>

        <span class="c1"># Loop over requested points</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)):</span>

            <span class="c1"># Look for a STAX parameter for current point</span>
            <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span><span class="p">(</span><span class="n">pt</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">soln</span><span class="p">))):</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">soln</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># If a STAX parameter was found for current point, add its coordinates into X</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">X</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : get_plh</span>
<span class="c1"># Purpose : Get geographical coordinates of specified stations</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 05-Jul-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - code : 4-char codes</span>
<span class="c1">#           - pt   : PT codes. Default is None.</span>
<span class="c1">#           - soln : Solns. Default is None.</span>
<span class="c1"># Output  : - phi  : Latitudes (rad)</span>
<span class="c1">#           - lam  : Longitudes (rad)</span>
<span class="c1">#           - h    : Ellipsoidal heights (m)</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.get_plh"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.get_plh">[docs]</a>    <span class="k">def</span> <span class="nf">get_plh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">soln</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cart2geo</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : get_lonlat</span>
<span class="c1"># Purpose : Get longitudes and latitudes of specified stations</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 05-Jul-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - code : 4-char codes</span>
<span class="c1">#           - pt   : PT codes. Default is None.</span>
<span class="c1">#           - soln : Solns. Default is None.</span>
<span class="c1"># Output  : - lon  : Longitudes (deg)</span>
<span class="c1">#           - lat  : Latitudes (deg)</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.get_lonlat"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.get_lonlat">[docs]</a>    <span class="k">def</span> <span class="nf">get_lonlat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">soln</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">get_plh</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="n">lam</span><span class="p">,</span> <span class="mi">180</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="n">phi</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : get_sigenh</span>
<span class="c1"># Purpose : Get E,N,H formal errors of specified stations</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 20-May-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - code : 4-char codes</span>
<span class="c1">#           - pt   : PT codes</span>
<span class="c1">#           - soln : Solns</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.get_sigenh"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.get_sigenh">[docs]</a>    <span class="k">def</span> <span class="nf">get_sigenh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Station positions</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">)</span>

        <span class="c1"># Geocentric to topocentric rotation matrices</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">xyz2enh</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Get E,N,H formal errors</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="mi">3</span><span class="p">][:,</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Q</span><span class="p">),</span> <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">s</span></div>


<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : get_cov_sta</span>
<span class="c1"># Purpose : Get the site covariance matrix for a list of sites</span>
<span class="c1"># Author  : J.-M. Nocquet</span>
<span class="c1"># Created : 26-September-2018</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - code : 4-char codes</span>
<span class="c1">#           - pt   : PT codes</span>
<span class="c1">#           - soln : Solns</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.get_cov_sta"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.get_cov_sta">[docs]</a>    <span class="k">def</span> <span class="nf">get_cov_sta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">soln</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">lQ</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get individual site covariance from the overall solution covariance matrix</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)):</span>

            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">pt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">soln</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
            <span class="n">lQ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="mi">3</span><span class="p">][:,</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">lQ</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : get_helmert_matrix</span>
<span class="c1"># Purpose : Get design matrix of Helmert parameters</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 02-Sep-2014</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - params : String indicating which Helmert parameters should be considered.</span>
<span class="c1">#                      It can be composed by any combination of letters &#39;T&#39; (translations),</span>
<span class="c1">#                     &#39;S&#39; (scale) and &#39;R&#39; (rotations). Default is &#39;RST&#39; (all 7 parameters).</span>
<span class="c1">#           - pole   : If True, the RY/XPO and RX/YPO partial derivatives are set to 1.</span>
<span class="c1">#                      Default is False.</span>
<span class="c1">#           - gc     : If True, the TX/XGC, TY/YGC and TZ/ZGC partial derivatives are set to 1.</span>
<span class="c1"># Output  : - A      : Design matrix of Helmert parameters</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.get_helmert_matrix"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.get_helmert_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">get_helmert_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="s1">&#39;RST&#39;</span><span class="p">,</span> <span class="n">pole</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Initialization</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

        <span class="c1"># Loop over STAX parameters in order to fill the full design matrix A</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPO   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pole</span><span class="p">)):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pole</span><span class="p">)):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XGC   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">gc</span><span class="p">)):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YGC   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">gc</span><span class="p">)):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;ZGC   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">gc</span><span class="p">)):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>

        <span class="c1"># Keep relevant columns of A</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">)))</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">A</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : map</span>
<span class="c1"># Purpose : Draw station map</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 08-Feb-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - write_codes : True for station codes to be written on the map. Default is True.</span>
<span class="c1">#           - title       : Map title. Default is None.</span>
<span class="c1">#           - output      : Output file. Default is None.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.map"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.map">[docs]</a>    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_codes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>


        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">code</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">]</span>
        <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">get_lonlat</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">station_map</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">write_codes</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : propagate</span>
<span class="c1"># Purpose : Propagate station positions to specified date</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 23-May-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - epo      : Epoch (SINEX format)</span>
<span class="c1">#           - keep_vel : True or False depending on whether station velocities</span>
<span class="c1">#                        should be kept or not. Default is False.</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.propagate"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.propagate">[docs]</a>    <span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epo</span><span class="p">,</span> <span class="n">keep_vel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># date object at propagation epoch</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_snxepoch</span><span class="p">(</span><span class="n">epo</span><span class="p">)</span>

        <span class="c1"># Loop over parameters to</span>
        <span class="c1"># - build the design matrix A</span>
        <span class="c1"># - build a table ind containing the indices of non-velocity parameters</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;lil&#39;</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>

            <span class="c1"># If parameter i is a velocity,</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VEL&#39;</span><span class="p">):</span>

                <span class="c1"># Current reference epoch of corresponding &#39;STA&#39; parameter =&gt; dt in years</span>
                <span class="n">ti</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_snxepoch</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">tref</span><span class="p">)</span>
                <span class="n">dti</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">mjd</span> <span class="o">-</span> <span class="n">ti</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.25</span>

                <span class="c1"># Fill design matrix</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dti</span>

            <span class="c1"># Else, add parameter i to the list of non-velocity parameters.</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;STA&#39;</span><span class="p">):</span>
                <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Loop over STA and VEL parameters to change their reference dates</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;STA&#39;</span><span class="p">,</span> <span class="s1">&#39;VEL&#39;</span><span class="p">]):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">tref</span> <span class="o">=</span> <span class="n">epo</span>

        <span class="c1"># If velocities should not be kept in sinex object, make some cleaning.</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">keep_vel</span><span class="p">)):</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">npar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>

        <span class="c1"># Propagate coordinates</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Propagate covariance matrix if available</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># Update standard deviations if covariance matrix is available</span>
        <span class="c1"># Else, set them to 0.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : remove_sta</span>
<span class="c1"># Purpose : Remove specified stations from a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 16-Sep-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - code   : 4-char codes</span>
<span class="c1">#           - pt     : PT codes. Default is None.</span>
<span class="c1">#           - soln   : Solns. Default is None.</span>
<span class="c1">#           - log    : Log file. Default is None.</span>
<span class="c1">#           - append : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.remove_sta"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.remove_sta">[docs]</a>    <span class="k">def</span> <span class="nf">remove_sta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">soln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># If necessary, open log file and write header</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">append</span><span class="p">):</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sinex::remove_sta : Remove specified stations from a solution</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># 1 - Deal with estimated parameters and snx.sta</span>
        <span class="c1">#-----------------------------------------------</span>

        <span class="c1"># Initialization</span>
        <span class="n">indk</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over parameters</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Must parameter i be kept?</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pt</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">soln</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))])):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">pt</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))])):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">code</span><span class="p">)):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># If parameter i has to be removed, print message in log file.</span>
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span><span class="p">(</span><span class="n">keep</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">log</span><span class="p">)):</span>
                <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0.type}</span><span class="s1"> </span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> </span><span class="si">{0.soln}</span><span class="s1"> removed</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

        <span class="c1"># If any parameter has to be deleted,</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>

            <span class="c1"># Update snx.npar, snx.param, snx.x, snx.sig and snx.Q</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">npar</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig</span>   <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>

            <span class="c1"># List of points for which there remain estimated positions</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">codek</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">ptk</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">solnk</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>

            <span class="c1"># Update snx.sta[*].soln</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">codek</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">ptk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">solnk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">codek</span><span class="p">))])):</span>
                        <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1"># Update snx.sta</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1">## PR, 02-Feb-2015 : Simplified handling of snx.sta</span>
            <span class="c1">#i = 0</span>
            <span class="c1">#while (i &lt; len(snx.sta)):</span>
                <span class="c1">#if (not(snx.sta[i].code+snx.sta[i].pt in [codek[k]+ptk[k] for k in range(len(codek))])):</span>
                    <span class="c1">#(snx.sta).pop(i)</span>
                <span class="c1">#else:</span>
                    <span class="c1">#i = i+1</span>

        <span class="c1"># 2 - Deal with a priori parameters</span>
        <span class="c1">#----------------------------------</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">):</span>

            <span class="c1"># Initialization</span>
            <span class="n">indk</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Loop over a priori parameters</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># Must a priori parameter i be kept?</span>
                <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">pt</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">soln</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))])):</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">pt</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))])):</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">code</span><span class="p">)):</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># If any parameter has to be deleted,</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>

                <span class="c1"># Update snx.prior, snx.x0, snx.sig0, snx.Qc and snx.Nc</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">x0</span>    <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span>  <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>

        <span class="c1"># Close log file if necessary</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : keep_sta</span>
<span class="c1"># Purpose : Keep only specified stations in a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 16-Sep-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes : PR, 05-Jul-2016 : Deal with PSD parameters</span>
<span class="c1">#</span>
<span class="c1"># Input   : - code   : 4-char codes</span>
<span class="c1">#           - pt     : PT codes. Default is None.</span>
<span class="c1">#           - soln   : Solns. Default is None.</span>
<span class="c1">#           - log    : Log file. Default is None.</span>
<span class="c1">#           - append : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.keep_sta"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.keep_sta">[docs]</a>    <span class="k">def</span> <span class="nf">keep_sta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">soln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>


        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># If necessary, open log file and write header</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">append</span><span class="p">):</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sinex::keep_sta : Keep only specified stations in a solution</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># 1 - Deal with estimated parameters and snx.sta</span>
        <span class="c1">#-----------------------------------------------</span>

        <span class="c1"># Initialization</span>
        <span class="n">indk</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over parameters</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Must parameter i be kept?</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;STA&#39;</span><span class="p">,</span> <span class="s1">&#39;VEL&#39;</span><span class="p">]))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AEXP&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXP&#39;</span><span class="p">,</span> <span class="s1">&#39;ALOG&#39;</span><span class="p">,</span> <span class="s1">&#39;TLOG&#39;</span><span class="p">]))):</span>
                <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">pt</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">soln</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))]):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">pt</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))]):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">code</span><span class="p">):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># If parameter i has to be removed, print message in log file.</span>
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span><span class="p">(</span><span class="n">keep</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">log</span><span class="p">)):</span>
                <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0.type}</span><span class="s1"> </span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> </span><span class="si">{0.soln}</span><span class="s1"> removed</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

        <span class="c1"># If any parameter has to be deleted,</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>

            <span class="c1"># Update snx.npar, snx.param, snx.x, snx.sig and snx.Q</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">npar</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig</span>   <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>

            <span class="c1"># List of points for which there remain estimated positions</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">codek</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">ptk</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">solnk</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>

            <span class="c1"># Update snx.sta[*].soln</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">codek</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">ptk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">solnk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">codek</span><span class="p">))])):</span>
                        <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1"># Update snx.sta</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1">## PR, 02-Feb-2015 : Simplified handling of snx.sta</span>
            <span class="c1">#i = 0</span>
            <span class="c1">#while (i &lt; len(snx.sta)):</span>
                <span class="c1">#if (not(snx.sta[i].code+snx.sta[i].pt in [code[k]+pt[k] for k in range(len(code))])):</span>
                    <span class="c1">#(snx.sta).pop(i)</span>
                <span class="c1">#else:</span>
                    <span class="c1">#i = i+1</span>

        <span class="c1"># 2 - Deal with a priori parameters</span>
        <span class="c1">#----------------------------------</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">):</span>

            <span class="c1"># Initialization</span>
            <span class="n">indk</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Loop over a priori parameters</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># Must parameter i be kept?</span>
                <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="p">((</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;STA&#39;</span><span class="p">,</span> <span class="s1">&#39;VEL&#39;</span><span class="p">]))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AEXP&#39;</span><span class="p">,</span> <span class="s1">&#39;TEXP&#39;</span><span class="p">,</span> <span class="s1">&#39;ALOG&#39;</span><span class="p">,</span> <span class="s1">&#39;TLOG&#39;</span><span class="p">]))):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">((</span><span class="n">pt</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">soln</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))]):</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">pt</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))]):</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">code</span><span class="p">):</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># If any parameter has to be deleted,</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>

                <span class="c1"># Update snx.prior, snx.x0, snx.sig0, snx.Qc and snx.Nc</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">x0</span>    <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span>  <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>

        <span class="c1"># Close log file if necessary</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : remove_sta_wo_domes</span>
<span class="c1"># Purpose : Remove stations without DOMES numbers from a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 19-May-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   :</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.remove_sta_wo_domes"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.remove_sta_wo_domes">[docs]</a>    <span class="k">def</span> <span class="nf">remove_sta_wo_domes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Initializations</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt</span>   <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get list of stations without DOMES numbers</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">domes</span> <span class="o">==</span> <span class="n">default_domes</span><span class="p">):</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>

        <span class="c1"># Remove those stations</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">remove_sta</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : keep_relevant_solns</span>
<span class="c1"># Purpose : Extract solns that a relevant to specified epoch from a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 27-Jun-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - t     : Epoch (SINEX format)</span>
<span class="c1">#           - solns : Soln table</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.keep_relevant_solns"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.keep_relevant_solns">[docs]</a>    <span class="k">def</span> <span class="nf">keep_relevant_solns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">solns</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Initializations</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="n">soln</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over STAX parameters</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>

                <span class="c1"># If current soln is in reference soln table,</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">r</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">]):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">r</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">]):</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">solns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">start</span>
                        <span class="n">end</span>   <span class="o">=</span> <span class="n">solns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">end</span>

                        <span class="c1"># And if it is relevant to requested epoch,</span>
                        <span class="k">if</span> <span class="p">(((</span><span class="n">start</span> <span class="o">==</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">earlier</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">t</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">((</span><span class="n">end</span> <span class="o">==</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">earlier</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">end</span><span class="p">)))):</span>

                            <span class="c1"># Add it to the list of solns to keep</span>
                            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                            <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>
                            <span class="n">soln</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>

        <span class="c1"># Extract relevant solns</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">keep_sta</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : remove_params</span>
<span class="c1"># Purpose : Remove certain types of parameters from a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 11-Aug-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : types : List of keywords to indicate on which parameters constraints should be removed.</span>
<span class="c1">#                   This can include the following keywords:</span>
<span class="c1">#                   &#39;XPO&#39;, &#39;XPOR&#39;, &#39;YPO&#39;, &#39;YPOR&#39;, &#39;UT&#39;, &#39;LOD&#39;; &#39;ERP&#39; for all kinds of ERPs;</span>
<span class="c1">#                   &#39;SATA_X&#39;, &#39;SATA_Y&#39;, &#39;SATA_Z&#39;; &#39;SATA&#39; for all satellite parameters;</span>
<span class="c1">#                   &#39;STA&#39;; &#39;VEL&#39;; &#39;GC&#39; and &#39;TRANS&#39; for all transformation parameters.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.remove_params"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.remove_params">[docs]</a>    <span class="k">def</span> <span class="nf">remove_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># 1 - Deal with estimated parameters</span>
        <span class="c1">#-----------------------------------</span>

        <span class="c1"># Get indices of parameters to keep</span>
        <span class="n">indk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPO   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;XPO&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>  <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;XPOR&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;YPO&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>  <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;YPOR&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;UT    &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;UT&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>   <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;LOD&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>  <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;XPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;UT    &#39;</span><span class="p">,</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;ERP&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_X&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_X&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_Y&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_Y&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_Z&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_Z&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SATA&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;STA&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;STA&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VEL&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;VEL&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GC&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;GC&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TX    &#39;</span><span class="p">,</span> <span class="s1">&#39;TY    &#39;</span><span class="p">,</span> <span class="s1">&#39;TZ    &#39;</span><span class="p">,</span> <span class="s1">&#39;SC    &#39;</span><span class="p">,</span> <span class="s1">&#39;RX    &#39;</span><span class="p">,</span> <span class="s1">&#39;RY    &#39;</span><span class="p">,</span> <span class="s1">&#39;RZ    &#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;TRANS&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))):</span>
                <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Update sinex object</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">npar</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig</span>   <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;STA&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">sta</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># 2 - Deal with a priori parameters</span>
        <span class="c1">#----------------------------------</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">):</span>

            <span class="c1"># Get indices of parameters to keep</span>
            <span class="n">indk</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span><span class="p">(((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPO   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;XPO&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>  <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;XPOR&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;YPO&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>  <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;YPOR&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;UT    &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;UT&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>   <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;LOD&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>  <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;XPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;UT    &#39;</span><span class="p">,</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;ERP&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_X&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_X&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_Y&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_Y&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_Z&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_Z&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SATA&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;STA&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;STA&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VEL&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;VEL&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GC&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;GC&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                      <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TX    &#39;</span><span class="p">,</span> <span class="s1">&#39;TY    &#39;</span><span class="p">,</span> <span class="s1">&#39;TZ    &#39;</span><span class="p">,</span> <span class="s1">&#39;SC    &#39;</span><span class="p">,</span> <span class="s1">&#39;RX    &#39;</span><span class="p">,</span> <span class="s1">&#39;RY    &#39;</span><span class="p">,</span> <span class="s1">&#39;RZ    &#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;TRANS&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))):</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># Update sinex object</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">x0</span>    <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span>  <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : remove_undef_params</span>
<span class="c1"># Purpose : Remove &quot;undefined&quot; parameters from a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 11-Aug-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   :</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.remove_undef_params"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.remove_undef_params">[docs]</a>    <span class="k">def</span> <span class="nf">remove_undef_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Return if sinex object doesn&#39;t contain a priori information</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
            <span class="k">return</span>

        <span class="c1"># Initializations</span>
        <span class="n">iestdel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">iaprdel</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over estimated parameters</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Look for current parameter in snx.prior</span>
            <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p0</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p0</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">]):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p0</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>

            <span class="c1"># If current parameter has to be deleted,</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;SATA&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">j</span><span class="p">]))):</span>
                <span class="n">iestdel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">iaprdel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

        <span class="c1"># Update estimated parameters</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iestdel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">indk</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)),</span> <span class="n">iestdel</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">npar</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig</span>   <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>

        <span class="c1"># Update a priori parameters</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iaprdel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">indk</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">))),</span> <span class="n">iaprdel</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x0</span>    <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span>  <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : unconstrain</span>
<span class="c1"># Purpose : Recover unconstrained normal equation from a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 11-Aug-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   :</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.unconstrain"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.unconstrain">[docs]</a>    <span class="k">def</span> <span class="nf">unconstrain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># If no a priori information is available, just invert covariance matrix.</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x0</span>    <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">k</span>     <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">N</span>     <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Q</span>     <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="c1"># Get indices of a priori parameters which really correspond to estimated parameters (ind2).</span>
        <span class="c1"># Also get indices of corresponding estimated parameters (ind1).</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Look for estimated parameter corresponding to snx.prior[i]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>
                <span class="n">ind1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">ind2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># If no a priori parameter corresponds to an estimated parameter, just invert covariance matrix.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x0</span>    <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">k</span>     <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">N</span>     <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Q</span>     <span class="o">=</span> <span class="kc">None</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span>    <span class="o">=</span> <span class="kc">None</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span>    <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="c1"># Get normal matrix of constraints</span>
        <span class="n">Nc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;NoneType&#39;</span><span class="p">):</span>
            <span class="n">Nc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;NoneType&#39;</span><span class="p">):</span>
            <span class="n">Nc</span> <span class="o">=</span> <span class="n">sympinv</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Nc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)))</span>

        <span class="c1"># Complete diagonal of the normal matrix of constraints with 1/sig0**2</span>
        <span class="c1"># for potential a priori parameters which do not appear in the MATRIX_APRIORI block</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">Nc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span>
                <span class="n">Nc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># Remove from the normal matrix of constraints the a priori parameters which do not correspond to any estimated parameter</span>
        <span class="c1"># (i.e. RX, RY, RZ in the EMR solutions)</span>
        <span class="n">Nc</span> <span class="o">=</span> <span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind2</span><span class="p">,</span> <span class="n">ind2</span><span class="p">)]</span>

        <span class="c1"># Make normal matrix of constraints consistent with the indexing of estimated parameters</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">))</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Nc</span>
        <span class="n">Nc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Total normal matrix</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Ntot</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;NoneType&#39;</span><span class="p">):</span>
            <span class="n">Ntot</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Ntot</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Ntot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;NoneType&#39;</span><span class="p">):</span>
            <span class="n">Ntot</span> <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Unconstrained normal matrix</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">Ntot</span> <span class="o">-</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span>

        <span class="c1"># Update prior of sinex object: a priori values are unchanged when available,</span>
        <span class="c1"># but set to estimated values when unavailable.</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">)</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
        <span class="n">new_x0</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_x0</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">new_x0</span>

        <span class="c1"># Second member of normal equation: k = Ntot * (x-x0)</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">Ntot</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : prior2ref</span>
<span class="c1"># Purpose : Change a priori values to reference values in a normal equation</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 11-Aug-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>

<span class="c1">#</span>
<span class="c1"># Input   : - ref       : sinex object containing reference a priori values</span>
<span class="c1">#           - log       : Log file. Default is None.</span>
<span class="c1">#           - append    : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.prior2ref"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.prior2ref">[docs]</a>    <span class="k">def</span> <span class="nf">prior2ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>


        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># If necessary, open log file and write header</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">append</span><span class="p">):</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="c1"># Write header</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sinex::prior2ref : Change a priori values to reference values in normal equation</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Initializations</span>
        <span class="n">dx0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span>
        <span class="n">b</span>   <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Loop over parameters in normal equation</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># 1 - Case of a SATA parameter</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SATA&#39;</span><span class="p">):</span>

                <span class="c1"># If this parameter has a reference value,</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pref</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">pref</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                    <span class="n">iref</span> <span class="o">=</span> <span class="p">[</span><span class="n">pref</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">pref</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>

                    <span class="c1"># And if its reference value is different from its a priori value,</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">!=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">dx0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">-</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
                            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0.type}</span><span class="s1"> </span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> </span><span class="si">{0.soln}</span><span class="s1"> : </span><span class="si">{1:21.14e}</span><span class="s1"> =&gt; </span><span class="si">{2:21.14e}</span><span class="s1"> (</span><span class="si">{3:21.14e}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">],</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span><span class="o">-</span><span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

            <span class="c1"># 2 - Case of a STA or VEL parameter</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;STA&#39;</span><span class="p">,</span> <span class="s1">&#39;VEL&#39;</span><span class="p">]):</span>

                <span class="c1"># If this parameter has a reference value,</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pref</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">pref</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">pref</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">pref</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                    <span class="n">iref</span> <span class="o">=</span> <span class="p">[</span><span class="n">pref</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">pref</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">pref</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">pref</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>

                    <span class="c1"># And if its reference value is different from its a priori value,</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">!=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">dx0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">-</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
                            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0.type}</span><span class="s1"> </span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> </span><span class="si">{0.soln}</span><span class="s1"> : </span><span class="si">{1:21.14e}</span><span class="s1"> =&gt; </span><span class="si">{2:21.14e}</span><span class="s1"> (</span><span class="si">{3:21.14e}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">],</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span><span class="o">-</span><span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

            <span class="c1"># 3 - Case of an ERP</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;XPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;UT    &#39;</span><span class="p">,</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">]):</span>

                <span class="c1"># If this parameter has a reference value,</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">tref</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pref</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">pref</span><span class="o">.</span><span class="n">tref</span> <span class="k">for</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                    <span class="n">iref</span> <span class="o">=</span> <span class="p">[</span><span class="n">pref</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">pref</span><span class="o">.</span><span class="n">tref</span> <span class="k">for</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">tref</span><span class="p">)</span>

                    <span class="c1"># And if its reference value is different from its a priori value,</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">!=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">dx0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">-</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
                            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0.type}</span><span class="s1"> </span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> </span><span class="si">{0.soln}</span><span class="s1"> : </span><span class="si">{1:21.14e}</span><span class="s1"> =&gt; </span><span class="si">{2:21.14e}</span><span class="s1"> (</span><span class="si">{3:21.14e}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">],</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span><span class="o">-</span><span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

            <span class="c1"># 4 - Case of a space tie</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TDXJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TDYJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TDZJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TGXJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TGYJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TGZJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TLXJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TLYJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TLZJA2&#39;</span><span class="p">]):</span>

                <span class="c1"># If this parameter has a reference value,</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">pref</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                    <span class="n">iref</span> <span class="o">=</span> <span class="p">[</span><span class="n">pref</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

                    <span class="c1"># And if its reference value is different from its a priori value,</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">!=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">dx0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">-</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
                            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0.type}</span><span class="s1"> </span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> </span><span class="si">{0.soln}</span><span class="s1"> : </span><span class="si">{1:21.14e}</span><span class="s1"> =&gt; </span><span class="si">{2:21.14e}</span><span class="s1"> (</span><span class="si">{3:21.14e}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">],</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span><span class="o">-</span><span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>


        <span class="c1"># If any a priori value has to be modified,</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">):</span>

            <span class="c1"># Modify a priori values</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dx0</span>

            <span class="c1"># Modify 2nd member of normal equation</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;NoneType&#39;</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">dx0</span><span class="p">)</span>

        <span class="c1"># Close log file if necessary</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : fix_params</span>
<span class="c1"># Purpose : Fix certain types of parameters in a normal equation</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 11-Aug-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : types : List of keywords to indicate on which parameters constraints should be removed.</span>
<span class="c1">#                   This can include the following keywords:</span>
<span class="c1">#                   &#39;XPO&#39;, &#39;XPOR&#39;, &#39;YPO&#39;, &#39;YPOR&#39;, &#39;UT&#39;, &#39;LOD&#39;; &#39;ERP&#39; for all kinds of ERPs;</span>
<span class="c1">#                   &#39;SATA_X&#39;, &#39;SATA_Y&#39;, &#39;SATA_Z&#39;; &#39;SATA&#39; for all satellite parameters;</span>
<span class="c1">#                   &#39;STA&#39;; &#39;VEL&#39;; &#39;GC&#39;; &#39;SBIAS&#39;; &#39;ST&#39;</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.fix_params"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.fix_params">[docs]</a>    <span class="k">def</span> <span class="nf">fix_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Get indices of parameters to keep</span>
        <span class="n">indk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPO   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;XPO&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>  <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;XPOR&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;YPO&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>  <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;YPOR&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;UT    &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;UT&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>   <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;LOD&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>  <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;XPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;UT    &#39;</span><span class="p">,</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;ERP&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_X&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_X&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_Y&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_Y&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_Z&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_Z&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SATA&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;STA&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;STA&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VEL&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;VEL&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GC&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;GC&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SBIAS &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SBIAS&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TDXJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TDYJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TDZJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TGXJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TGYJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TGZJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TLXJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TLYJA2&#39;</span><span class="p">,</span> <span class="s1">&#39;TLZJA2&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;ST&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))):</span>
                <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Update sinex object</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">npar</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x0</span>    <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig</span>   <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span>  <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">k</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">N</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : fix_sta</span>
<span class="c1"># Purpose : Fix specified stations in a normal equation</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 11-Aug-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - code   : 4-char codes</span>
<span class="c1">#           - pt     : PT codes. Default is None.</span>
<span class="c1">#           - soln   : Solns. Default is None.</span>
<span class="c1">#           - log    : Log file. Default is None.</span>
<span class="c1">#           - append : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.fix_sta"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.fix_sta">[docs]</a>    <span class="k">def</span> <span class="nf">fix_sta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">soln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># If necessary, open log file and write header</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">append</span><span class="p">):</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sinex::fix_sta : Fix specified stations from a normal equation</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Initialization</span>
        <span class="n">indk</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over parameters</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Must parameter i be kept?</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pt</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">soln</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))])):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">pt</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))])):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">code</span><span class="p">)):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># If parameter i has to be fixed, print message in log file.</span>
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span><span class="p">(</span><span class="n">keep</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">log</span><span class="p">)):</span>
                <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0.type}</span><span class="s1"> </span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> </span><span class="si">{0.soln}</span><span class="s1"> fixed</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

        <span class="c1"># Indices of fixed parameters</span>
        <span class="n">indr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)),</span> <span class="n">indk</span><span class="p">)</span>

        <span class="c1"># If any parameter has to be fixed,</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>

            <span class="c1"># Update normal equation</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">npar</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x0</span>    <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig</span>   <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span>  <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">N</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">k</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Qc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>

            <span class="c1"># List of points for which there remain estimated positions</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">code</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">soln</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>

            <span class="c1"># Update snx.sta[*].soln</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))])):</span>
                        <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1"># Update snx.sta</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

        <span class="c1"># Close log file if necessary</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : reduce_params</span>
<span class="c1"># Purpose : Reduce certain types of parameters from a normal equation</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 26-Jun-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : types : List of keywords to indicate on which parameters constraints should be removed.</span>
<span class="c1">#                   This can include the following keywords:</span>
<span class="c1">#                   &#39;XPO&#39;, &#39;XPOR&#39;, &#39;YPO&#39;, &#39;YPOR&#39;, &#39;UT&#39;, &#39;LOD&#39;; &#39;ERP&#39; for all kinds of ERPs;</span>
<span class="c1">#                   &#39;SATA_X&#39;, &#39;SATA_Y&#39;, &#39;SATA_Z&#39;; &#39;SATA&#39; for all satellite parameters;</span>
<span class="c1">#                   &#39;STA&#39;; &#39;VEL&#39;; &#39;GC&#39;; &#39;RBIAS&#39;</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.reduce_params"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.reduce_params">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Return if no parameter has to be reduced</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Get indices of parameters to keep</span>
        <span class="n">indk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPO   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;XPO&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>  <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;XPOR&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;YPO&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>  <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;YPOR&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;UT    &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;UT&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>   <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;LOD&#39;</span>  <span class="ow">in</span> <span class="n">types</span><span class="p">))</span>  <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;XPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;UT    &#39;</span><span class="p">,</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;ERP&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_X&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_X&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_Y&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_Y&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_Z&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_Z&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SATA&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;STA&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;STA&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VEL&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;VEL&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;XGC   &#39;</span><span class="p">,</span> <span class="s1">&#39;YGC   &#39;</span><span class="p">,</span> <span class="s1">&#39;ZGC   &#39;</span><span class="p">,</span> <span class="s1">&#39;SC    &#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;GC&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))</span> <span class="ow">or</span>
                   <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;RBIAS &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;RBIAS&#39;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">))):</span>
                <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Indices of reduced parameters</span>
        <span class="n">indr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)),</span> <span class="n">indk</span><span class="p">)</span>

        <span class="c1"># Update sinex object</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">npar</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x0</span>    <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig</span>   <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span>  <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">R</span>         <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indr</span><span class="p">)],</span> <span class="n">syminv</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indr</span><span class="p">,</span><span class="n">indr</span><span class="p">)]))</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">N</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indr</span><span class="p">,</span><span class="n">indk</span><span class="p">)])</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">k</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">indr</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : reduce_sta</span>
<span class="c1"># Purpose : Reduce specified stations from a normal equation</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 02-Sep-2014</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - code   : 4-char codes</span>
<span class="c1">#           - pt     : PT codes. Default is None.</span>
<span class="c1">#           - soln   : Solns. Default is None.</span>
<span class="c1">#           - log    : Log file. Default is None.</span>
<span class="c1">#           - append : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.reduce_sta"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.reduce_sta">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_sta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">soln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># If necessary, open log file and write header</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">append</span><span class="p">):</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fl</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sinex::reduce_sta : Reduce specified stations from a normal equation</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Initialization</span>
        <span class="n">indk</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over parameters</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Must parameter i be kept?</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">pt</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">soln</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))])):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">pt</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))])):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">code</span><span class="p">)):</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">indk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># If parameter i has to be removed, print message in log file.</span>
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span><span class="p">(</span><span class="n">keep</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">log</span><span class="p">)):</span>
                <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0.type}</span><span class="s1"> </span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> </span><span class="si">{0.soln}</span><span class="s1"> reduced</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

        <span class="c1"># Indices of reduced parameters</span>
        <span class="n">indr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)),</span> <span class="n">indk</span><span class="p">)</span>

        <span class="c1"># If any parameter has to be reduced,</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>

            <span class="c1"># Update normal equation</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">npar</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indk</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">x0</span>    <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig</span>   <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span>  <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span>
            <span class="n">R</span>         <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indr</span><span class="p">)],</span> <span class="n">syminv</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indr</span><span class="p">,</span><span class="n">indr</span><span class="p">)]))</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">N</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indr</span><span class="p">,</span><span class="n">indk</span><span class="p">)])</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">k</span>     <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">indk</span><span class="p">]</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">indr</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indk</span><span class="p">,</span><span class="n">indk</span><span class="p">)]</span>

            <span class="c1"># List of points for which there remain estimated positions</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">code</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">soln</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>

            <span class="c1"># Update snx.sta[*].soln</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))])):</span>
                        <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1"># Update snx.sta</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

        <span class="c1"># Close log file if necessary</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : reduce_doublons</span>
<span class="c1"># Purpose : Reduce stations appearing twice in a normal equation</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 21-Aug-2013</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - log    : Log file. Default is None.</span>
<span class="c1">#           - append : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.reduce_doublons"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.reduce_doublons">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_doublons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Initializations</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt</span>   <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over STAX parameters</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>

                <span class="c1"># If current stations appears twice, add it to the red list if it is not yet in.</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">q</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">q</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))]))):</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>

        <span class="c1"># Reduce stations appearing twice</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">reduce_sta</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="n">append</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : setup_geocenter</span>
<span class="c1"># Purpose : Add geocenter coordinates into a normal equation</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 02-Sep-2014</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : tref : Reference epoch (SINEX format)</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.setup_geocenter"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.setup_geocenter">[docs]</a>    <span class="k">def</span> <span class="nf">setup_geocenter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tref</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Add XGC parameter</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">type</span>  <span class="o">=</span> <span class="s1">&#39;XGC   &#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">code</span>  <span class="o">=</span> <span class="s1">&#39;----&#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">pt</span>    <span class="o">=</span> <span class="s1">&#39;--&#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">soln</span>  <span class="o">=</span> <span class="s1">&#39;----&#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">tref</span>  <span class="o">=</span> <span class="n">tref</span>
        <span class="n">p</span><span class="o">.</span><span class="n">unit</span>  <span class="o">=</span> <span class="s1">&#39;m   &#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># Add YGC parameter</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;YGC   &#39;</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># Add ZGC parameter</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;ZGC   &#39;</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># Add a priori geocenter coordinates</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Update snx.Nc</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="o">+</span><span class="mi">3</span><span class="p">))))</span>

        <span class="c1"># &quot;Design&quot; matrix</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">))</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">:</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Update snx.N and snx.k</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>

        <span class="c1"># Update snx.npar</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">npar</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span> <span class="o">+</span> <span class="mi">3</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : setup_scale</span>
<span class="c1"># Purpose : Add terrestrial scale into a normal equation</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 02-Sep-2014</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : tref : Reference epoch (SINEX format)</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.setup_scale"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.setup_scale">[docs]</a>    <span class="k">def</span> <span class="nf">setup_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tref</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Add SC parameter</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">type</span>  <span class="o">=</span> <span class="s1">&#39;SC    &#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">code</span>  <span class="o">=</span> <span class="s1">&#39;----&#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">pt</span>    <span class="o">=</span> <span class="s1">&#39;--&#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">soln</span>  <span class="o">=</span> <span class="s1">&#39;----&#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">tref</span>  <span class="o">=</span> <span class="n">tref</span>
        <span class="n">p</span><span class="o">.</span><span class="n">unit</span>  <span class="o">=</span> <span class="s1">&#39;ppb &#39;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># Add a priori scale factor</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Update snx.Nc</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="o">+</span><span class="mi">1</span><span class="p">))))</span>

        <span class="c1"># &quot;Design&quot; matrix</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">))</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;STA&#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e-9</span><span class="o">*</span><span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Update snx.N and snx.k</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>

        <span class="c1"># Update snx.npar</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">npar</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">npar</span> <span class="o">+</span> <span class="mi">1</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : reduce_helmerts</span>
<span class="c1"># Purpose : Reduce origin, scale and/or orientation in a normal equation</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 31-Jul-2013</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : params : String indicating which Helmert parameters should be reduced.</span>
<span class="c1">#                    It can be composed by any combination of letters &#39;T&#39; (translations),</span>
<span class="c1">#                   &#39;S&#39; (scale) and &#39;R&#39; (rotations).</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.reduce_helmerts"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.reduce_helmerts">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_helmerts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Get Helmert design matrix</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">get_helmert_matrix</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pole</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Non-orthogonal projector onto Ker(A&#39;)</span>
        <span class="n">ANAi</span> <span class="o">=</span> <span class="n">sympinv</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">)))</span>
        <span class="n">P</span>    <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">ANAi</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>

        <span class="c1"># Update normal equation</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : add_min_const</span>
<span class="c1"># Purpose : Add minimal constraints to normal matrix of constraints (snx.Nc)</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 08-Mar-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - params         : String indicating on which parameters minimal constraints should be applied.</span>
<span class="c1">#                              It can be composed by any combination of letters &#39;T&#39; (translations),</span>
<span class="c1">#                              &#39;S&#39; (scale) and &#39;R&#39; (rotations). Default is &#39;&#39; (no minimal constraints).</span>
<span class="c1">#           - sigma          : Sigma of minimal constraints in m. Default is 1e-4.</span>
<span class="c1">#           - code, pt, soln : If specified, then minimal constraints will be applied to these points only.</span>
<span class="c1">#           - reduce_B       : True if the rows of B should be reduced rather than the columns of A. Default is False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.add_min_const"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.add_min_const">[docs]</a>    <span class="k">def</span> <span class="nf">add_min_const</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">soln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reduce_B</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Loop over STAX parameters in order to compute design matrix A of minimal constraints</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>

                <span class="c1"># Check whether minimal constraints have to be applied to current point</span>
                <span class="n">b</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">code</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">soln</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))]):</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="p">((</span><span class="n">code</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pt</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))]):</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">code</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))]):</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># If minimal constraints have to be applied to current point, fill design matrix</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">):</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">ae</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">ae</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">ae</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">ae</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span>  <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">ae</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span>  <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">ae</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">ae</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">ae</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span>  <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">ae</span>

        <span class="c1"># Indices of Helmert parameters that should effectively be constrained</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">)))</span>

        <span class="c1"># 1st case: reduce columns of A and compute B</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">reduce_B</span><span class="p">)):</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">syminv</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">)),</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># 2nd case: compute B and reduce rows of B</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">syminv</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">)),</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="n">ind</span><span class="p">,:]</span>

        <span class="c1"># Add minimal constraints to normal matrix of constraints</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : set_constraints</span>
<span class="c1"># Purpose : Define normal matrix of constraints (snx.Nc)</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 08-Mar-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - keep_const_on  : List of keywords indicating for which parameters constraints should be kept.</span>
<span class="c1">#                              This can include the following keywords: &#39;STA&#39; for all station positions; &#39;VEL&#39; for all station velocities;</span>
<span class="c1">#                              &#39;XPO&#39;, &#39;XPOR&#39;, &#39;YPO&#39;, &#39;YPOR&#39;, &#39;UT&#39;, &#39;LOD&#39;; &#39;ERP&#39; for all kinds of ERPs;</span>
<span class="c1">#                              &#39;SATA_X&#39;, &#39;SATA_Y&#39;, &#39;SATA_Z&#39;; &#39;SATA&#39; for all satellite antenna parameters and &#39;GC&#39;.</span>
<span class="c1">#                              Default is [] (no constraints kept).</span>
<span class="c1">#           - add_const_on   : List of keywords indicating for which parameters constraints should be added.</span>
<span class="c1">#                              It can include the same keywords as keep_const_on except &#39;ERP&#39;.</span>
<span class="c1">#                              Default is [] (no constraints added).</span>
<span class="c1">#           - add_const_sig  : Sigmas of constraints which should be added. (One value per keyword in add_const_on.)</span>
<span class="c1">#                              Default is [].</span>
<span class="c1">#           - min_const_on   : String indicating on which parameters minimal constraints should be applied.</span>
<span class="c1">#                              It can be composed by any combination of letters &#39;T&#39; (translations),</span>
<span class="c1">#                              &#39;S&#39; (scale) and &#39;R&#39; (rotations). Default is &#39;&#39; (no minimal constraints).</span>
<span class="c1">#           - min_const_sig  : Sigma of minimal constraints [m].</span>
<span class="c1">#           - code, pt, soln : If specified, then minimal constraints will be applied to these points only.</span>
<span class="c1">#           - reduce_B       : True if the rows of B should be reduced rather than the columns of A. Default is False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.set_constraints"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.set_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">set_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_const_on</span><span class="o">=</span><span class="p">[],</span> <span class="n">add_const_on</span><span class="o">=</span><span class="p">[],</span> <span class="n">add_const_sig</span><span class="o">=</span><span class="p">[],</span> <span class="n">min_const_on</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="n">min_const_sig</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">soln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reduce_B</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># 1 - Re-initialize normal matrix of constraints (snx.Nc)</span>
        <span class="c1">#--------------------------------------------------------</span>

        <span class="c1"># If none of the original constraints should be kept, then set snx.Nc = 0</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keep_const_on</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">)))</span>

        <span class="c1"># Else,</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># First, if snx.Nc is not defined, define it as a diagonal matrix</span>
            <span class="c1"># from the standard deviations of the a priori parameters.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">sc</span>      <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span>
                <span class="n">ind</span>     <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">sc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">sc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Get indices of parameters for which the original constraints should be kept</span>
            <span class="n">indc</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;STA&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;STA&#39;</span> <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span> <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VEL&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;VEL&#39;</span> <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span> <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPO   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;XPO&#39;</span>  <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span>  <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;XPOR&#39;</span>  <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span> <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;YPO&#39;</span>  <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span>  <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;YPOR&#39;</span>  <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span> <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;UT    &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;UT&#39;</span>  <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span>   <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;LOD&#39;</span>  <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span>  <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;XPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;UT    &#39;</span><span class="p">,</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;ERP&#39;</span> <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span> <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_X&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_X&#39;</span> <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span> <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_Y&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_Y&#39;</span> <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span> <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_Z&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA_Z&#39;</span> <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span> <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SATA&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SATA&#39;</span> <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))</span> <span class="ow">or</span>
                    <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GC&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;GC&#39;</span> <span class="ow">in</span> <span class="n">keep_const_on</span><span class="p">))):</span>

                    <span class="n">indc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># Keep snx.Nc[indc,indc] unchanged and set all other elements to 0</span>
            <span class="n">Nc</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indc</span><span class="p">,</span> <span class="n">indc</span><span class="p">)]</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">)))</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indc</span><span class="p">,</span> <span class="n">indc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">indc</span><span class="p">,</span> <span class="n">indc</span><span class="p">)]</span> <span class="o">+</span> <span class="n">Nc</span>

        <span class="c1"># Update standard deviations of a priori parameters</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">sig0</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">)[</span><span class="n">ind</span><span class="p">])</span>

        <span class="c1"># 2 - Add diagonal constaints if requested</span>
        <span class="c1">#-----------------------------------------</span>

        <span class="c1"># On station coordinates</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;STA&#39;</span> <span class="ow">in</span> <span class="n">add_const_on</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">add_const_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;STA&#39;</span><span class="p">)</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">add_const_sig</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;STA&#39;</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">wc</span>

        <span class="c1"># On XPO</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;XPO&#39;</span> <span class="ow">in</span> <span class="n">add_const_on</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">add_const_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;XPO&#39;</span><span class="p">)</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">add_const_sig</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;XPO   &#39;</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">wc</span>

        <span class="c1"># On XPOR</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;XPOR&#39;</span> <span class="ow">in</span> <span class="n">add_const_on</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">add_const_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;XPOR&#39;</span><span class="p">)</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">add_const_sig</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">wc</span>

        <span class="c1"># On YPO</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;YPO&#39;</span> <span class="ow">in</span> <span class="n">add_const_on</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">add_const_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;YPO&#39;</span><span class="p">)</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">add_const_sig</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">wc</span>

        <span class="c1"># On YPOR</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;YPOR&#39;</span> <span class="ow">in</span> <span class="n">add_const_on</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">add_const_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;YPOR&#39;</span><span class="p">)</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">add_const_sig</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">wc</span>

        <span class="c1"># On UT</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;UT&#39;</span> <span class="ow">in</span> <span class="n">add_const_on</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">add_const_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;UT&#39;</span><span class="p">)</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">add_const_sig</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;UT    &#39;</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">wc</span>

        <span class="c1"># On LOD</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;LOD&#39;</span> <span class="ow">in</span> <span class="n">add_const_on</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">add_const_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;LOD&#39;</span><span class="p">)</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">add_const_sig</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">wc</span>

        <span class="c1"># On SATA_X</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;SATA_X&#39;</span> <span class="ow">in</span> <span class="n">add_const_on</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">add_const_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;SATA_X&#39;</span><span class="p">)</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">add_const_sig</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;SATA_X&#39;</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">wc</span>

        <span class="c1"># On SATA_Y</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;SATA_Y&#39;</span> <span class="ow">in</span> <span class="n">add_const_on</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">add_const_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;SATA_Y&#39;</span><span class="p">)</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">add_const_sig</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;SATA_Y&#39;</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">wc</span>

        <span class="c1"># On SATA_Z</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;SATA_Z&#39;</span> <span class="ow">in</span> <span class="n">add_const_on</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">add_const_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;SATA_Z&#39;</span><span class="p">)</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">add_const_sig</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;SATA_Z&#39;</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">wc</span>

        <span class="c1"># On all SATA parameters</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;SATA&#39;</span> <span class="ow">in</span> <span class="n">add_const_on</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">add_const_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;SATA&#39;</span><span class="p">)</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">add_const_sig</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;SATA&#39;</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">wc</span>

        <span class="c1"># On geocenter</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;GC&#39;</span> <span class="ow">in</span> <span class="n">add_const_on</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="n">add_const_on</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;GC&#39;</span><span class="p">)</span>
            <span class="n">wc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">add_const_sig</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;GC&#39;</span><span class="p">)</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">wc</span>

        <span class="c1"># 3 - Add minimal constraints if requested</span>
        <span class="c1">#-----------------------------------------</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">min_const_on</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">add_min_const</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">min_const_on</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">min_const_sig</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="o">=</span><span class="n">soln</span><span class="p">,</span> <span class="n">reduce_B</span><span class="o">=</span><span class="n">reduce_B</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : neqinv</span>
<span class="c1"># Purpose : Invert normal equation</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 07-Jul-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - keep_const_on  : List of keywords indicating for which parameters constraints should be kept.</span>
<span class="c1">#                              This can include the following keywords: &#39;STA&#39; for all station positions; &#39;VEL&#39; for all station velocities;</span>
<span class="c1">#                              &#39;XPO&#39;, &#39;XPOR&#39;, &#39;YPO&#39;, &#39;YPOR&#39;, &#39;UT&#39;, &#39;LOD&#39;; &#39;ERP&#39; for all kinds of ERPs;</span>
<span class="c1">#                              &#39;SATA_X&#39;, &#39;SATA_Y&#39;, &#39;SATA_Z&#39;; &#39;SATA&#39; for all satellite antenna parameters and &#39;GC&#39;.</span>
<span class="c1">#                              Default is [] (no constraints kept).</span>
<span class="c1">#           - add_const_on   : List of keywords indicating for which parameters constraints should be added.</span>
<span class="c1">#                              It can include the same keywords as keep_const_on except &#39;ERP&#39;.</span>
<span class="c1">#                              Default is [] (no constraints added).</span>
<span class="c1">#           - add_const_sig  : Sigmas of constraints which should be added. (One value per keyword in add_const_on.)</span>
<span class="c1">#                              Default is [].</span>
<span class="c1">#           - min_const_on   : String indicating on which parameters minimal constraints should be applied.</span>
<span class="c1">#                              It can be composed by any combination of letters &#39;T&#39; (translations),</span>
<span class="c1">#                              &#39;S&#39; (scale) and &#39;R&#39; (rotations). Default is &#39;&#39; (no minimal constraints).</span>
<span class="c1">#           - min_const_sig  : Sigma of minimal constraints [m].</span>
<span class="c1">#           - code, pt, soln : If specified, then minimal constraints will be applied to these points only.</span>
<span class="c1">#           - reduce_B       : True if the rows of B should be reduced rather than the columns of A. Default is False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.neqinv"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.neqinv">[docs]</a>    <span class="k">def</span> <span class="nf">neqinv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_const_on</span><span class="o">=</span><span class="p">[],</span> <span class="n">add_const_on</span><span class="o">=</span><span class="p">[],</span> <span class="n">add_const_sig</span><span class="o">=</span><span class="p">[],</span> <span class="n">min_const_on</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
               <span class="n">min_const_sig</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">soln</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reduce_B</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        
        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Set normal matrix of constraints</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">set_constraints</span><span class="p">(</span><span class="n">keep_const_on</span><span class="p">,</span> <span class="n">add_const_on</span><span class="p">,</span> <span class="n">add_const_sig</span><span class="p">,</span> <span class="n">min_const_on</span><span class="p">,</span> <span class="n">min_const_sig</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">,</span> <span class="n">reduce_B</span><span class="p">)</span>

        <span class="c1"># Solve normal equation</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span> <span class="o">+</span> <span class="n">snx</span><span class="o">.</span><span class="n">Nc</span><span class="p">)</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">))</span>

        <span class="c1"># Clear snx.N and snx.k</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : rescale</span>
<span class="c1"># Purpose : Multiply solution covariance matrix by given factor</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 20-May-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : f : Scale factor (square-root of variance factor)</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.rescale"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.rescale">[docs]</a>    <span class="k">def</span> <span class="nf">rescale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Rescale sigmas</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span> <span class="o">*</span> <span class="n">f</span>

        <span class="c1"># Rescals covariance matrix</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">f</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : get_common_points</span>
<span class="c1"># Purpose : Get list of common points between two solutions</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 09-Mar-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - ref       : Second sinex object</span>
<span class="c1"># Output  : - code      : 4-char codes of common points</span>
<span class="c1">#           - pt        : PT codes of common points</span>
<span class="c1">#           - soln      : Solns of common points</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.get_common_points"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.get_common_points">[docs]</a>    <span class="k">def</span> <span class="nf">get_common_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Initializations</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">soln</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over STAX parameters of snx to identify common stations</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>

                <span class="c1"># If current station is common to both solutions,</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p0</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p0</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>
                    <span class="n">soln</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : helmert_wrt</span>
<span class="c1"># Purpose : Helmert comparison between two solutions</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 24-May-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - ref       : Solution to which the comparison is made (sinex object)</span>
<span class="c1">#           - params    : String indicating which parameters should be estimated.</span>
<span class="c1">#                         It can be composed by any combination of letters &#39;T&#39; (translations),</span>
<span class="c1">#                         &#39;S&#39; (scale) and &#39;R&#39; (rotations). Default is &#39;RST&#39; (all 7 parameters).</span>
<span class="c1">#           - weighting : Keyword to indicate which weighting should be used.</span>
<span class="c1">#                         It can take the following values :</span>
<span class="c1">#                         - &#39;identity&#39; to use an identity weight matrix (default)</span>
<span class="c1">#                         - &#39;diagonal&#39; to use a diagonal weight matrix</span>
<span class="c1">#                         - &#39;full&#39; to use a full weight matrix (inv(snx.Q))</span>
<span class="c1">#           - with_vel  : True or False depending on whether 7 or 14 parameters</span>
<span class="c1">#                         must be estimated. Default is False.</span>
<span class="c1">#           - normalize : If False, covariance matrix of estimated Helmert parameters</span>
<span class="c1">#                         will not be scaled by unit variance factor. Default is True.</span>
<span class="c1">#           - log       : Log file. Default is None.</span>
<span class="c1">#           - append    : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  : - T         : 7 (14) Helmert parameters (mm, ppb, mas, [mm/y, ppb/y, mas/y])</span>
<span class="c1">#           - Q         : Corresponding covariance matrix</span>
<span class="c1">#           - code      : 4-char codes of points used for the comparison</span>
<span class="c1">#           - pt        : PT codes of points used for the comparison</span>
<span class="c1">#           - soln      : solns of points used for the comparison</span>
<span class="c1">#           - vl        : E, N, H residuals (mm[/y])</span>
<span class="c1">#           - vn        : Normalized E, N, H residuals</span>
<span class="c1">#           - w         : E, N, H WRMS (mm[/y])</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.helmert_wrt"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.helmert_wrt">[docs]</a>    <span class="k">def</span> <span class="nf">helmert_wrt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="s1">&#39;RST&#39;</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="s1">&#39;identity&#39;</span><span class="p">,</span> <span class="n">with_vel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Initializations</span>
        <span class="n">nsta</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ind0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="n">soln</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over STAX parameters of snx to identify common stations</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">)):</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>

                <span class="c1"># If current station is common to both solutions,</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p0</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p0</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                    <span class="n">nsta</span> <span class="o">=</span> <span class="n">nsta</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>
                    <span class="n">soln</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>

                    <span class="n">j</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p0</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">with_vel</span><span class="p">):</span>
                        <span class="n">ind1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">)))</span>
                        <span class="n">ind0</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">6</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ind1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">)))</span>
                        <span class="n">ind0</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">3</span><span class="p">)))</span>

        <span class="c1"># Get reference coordinates of common stations</span>
        <span class="n">nobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind0</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">with_vel</span><span class="p">):</span>
            <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">]]</span>
            <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind0</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">]]</span>
            <span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind0</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>
            <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind0</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>
            <span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind0</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>

        <span class="c1"># Design matrix in case of 14-parameter comparison</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">with_vel</span><span class="p">):</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nobs</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>

            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Design matrix in case of 7-parameter comparison</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nobs</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>  <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Indices of parameters that have to be estimated (ind)</span>
        <span class="n">ind</span>  <span class="o">=</span> <span class="p">[]</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">)))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">with_vel</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
                <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">)))</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
                <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
                <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">14</span><span class="p">)))</span>

        <span class="c1"># Reduce A to these parameters</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">npar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>

        <span class="c1"># 2nd member B</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind0</span><span class="p">]</span>

        <span class="c1"># Compute normal matrix and 2nd member of normal equation</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;identity&#39;</span><span class="p">):</span>
            <span class="n">N</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
            <span class="n">K</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;diagonal&#39;</span><span class="p">):</span>
            <span class="n">P</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">N</span>  <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">P</span>
            <span class="n">K</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
            <span class="n">N</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">):</span>
            <span class="n">P</span>  <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind1</span><span class="p">)])</span>
            <span class="n">N</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
            <span class="n">K</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
            <span class="n">N</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>

        <span class="c1"># Solve normal equation</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

        <span class="c1"># Compute residuals and variance factor</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">B</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;identity&#39;</span><span class="p">):</span>
            <span class="n">vPv</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;diagonal&#39;</span><span class="p">):</span>
            <span class="n">vPv</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">P</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">):</span>
            <span class="n">vPv</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

        <span class="n">sigma0</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">vPv</span> <span class="o">/</span> <span class="p">(</span><span class="n">nobs</span> <span class="o">-</span> <span class="n">npar</span><span class="p">))</span>

        <span class="c1"># Compute covariance matrix of residuals</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;identity&#39;</span><span class="p">):</span>
            <span class="n">Qv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nobs</span><span class="p">)</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;diagonal&#39;</span><span class="p">):</span>
            <span class="n">Qv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Qv</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind1</span><span class="p">)]</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

        <span class="c1"># Scale covariance matrices with unit variance factor</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">normalize</span><span class="p">):</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">sigma0</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Q</span>
            <span class="n">Qv</span> <span class="o">=</span> <span class="n">sigma0</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Qv</span>

        <span class="c1"># Compute (X,Y,Z) -&gt; (E,N,H) rotation matrices</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">xyz2enh</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Compute E,N,H [normalized] residuals and E,N,H WRMS</span>
        <span class="n">vl</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nobs</span><span class="p">)</span>
        <span class="n">vn</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nobs</span><span class="p">)</span>

        <span class="c1"># 1st case : 14 parameters</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">with_vel</span><span class="p">):</span>
            <span class="n">w</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">d</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsta</span><span class="p">):</span>
                <span class="n">vl</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">Ql</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dot</span><span class="p">(</span><span class="n">Qv</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
                <span class="n">vn</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">vl</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Ql</span><span class="p">))</span>
                <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">vl</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Ql</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Ql</span><span class="p">)</span>

                <span class="n">vl</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">])</span>
                <span class="n">Ql</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dot</span><span class="p">(</span><span class="n">Qv</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
                <span class="n">vn</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">vl</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Ql</span><span class="p">))</span>
                <span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">vl</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Ql</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Ql</span><span class="p">)</span>

        <span class="c1"># 2nd case : 7 parameters</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">d</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsta</span><span class="p">):</span>
                <span class="n">vl</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">Ql</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dot</span><span class="p">(</span><span class="n">Qv</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
                <span class="n">vn</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">vl</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Ql</span><span class="p">))</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">+</span> <span class="n">vl</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Ql</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Ql</span><span class="p">)</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span>

        <span class="c1"># Reshape residual arrays</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">with_vel</span><span class="p">):</span>
            <span class="n">vl</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
            <span class="n">vn</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vl</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">vn</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Convert raw residuals and WRMS into mm[/y]</span>
        <span class="n">vl</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">vl</span>
        <span class="n">w</span>  <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">w</span>

        <span class="c1"># Reshape array of transformation parameters and covariance matrix</span>
        <span class="c1"># (Put zeros for non-estimated parameters)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">with_vel</span><span class="p">):</span>
            <span class="n">Tfull</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">Qfull</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Tfull</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
            <span class="n">Qfull</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

        <span class="n">Tfull</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
        <span class="n">Qfull</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">ind</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Q</span>

        <span class="n">T</span> <span class="o">=</span> <span class="n">Tfull</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">Qfull</span>
        <span class="n">sT</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>

        <span class="c1"># Write log file</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">append</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="c1"># Write header</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sinex::helmert_wrt : </span><span class="si">{0}</span><span class="s1"> vs </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Write main options and statistics</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Number of common points : </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nsta</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Number of parameters    : </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npar</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Weighting               : </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weighting</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Variance factor         : </span><span class="si">{0:.8e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma0</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WRMS East               : </span><span class="si">{0:8.3f}</span><span class="s1"> mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WRMS North              : </span><span class="si">{0:8.3f}</span><span class="s1"> mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WRMS Up                 : </span><span class="si">{0:8.3f}</span><span class="s1"> mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">with_vel</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WRMS vel East           : </span><span class="si">{0:8.3f}</span><span class="s1"> mm/y</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WRMS vel North          : </span><span class="si">{0:8.3f}</span><span class="s1"> mm/y</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WRMS vel Up             : </span><span class="si">{0:8.3f}</span><span class="s1"> mm/y</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Write estimated parameters and formal errors</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Estimated Helmert parameters :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;       |  TX(mm)  TY(mm)  TZ(mm) SC(ppb) RX(mas) RY(mas) RZ(mas) |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------|---------------------------------------------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;       | </span><span class="si">{0[0]:7.1f}</span><span class="s1"> </span><span class="si">{0[1]:7.1f}</span><span class="s1"> </span><span class="si">{0[2]:7.1f}</span><span class="s1"> </span><span class="si">{0[3]:7.2f}</span><span class="s1"> </span><span class="si">{0[4]:7.3f}</span><span class="s1"> </span><span class="si">{0[5]:7.3f}</span><span class="s1"> </span><span class="si">{0[6]:7.3f}</span><span class="s1"> |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  +/-  | </span><span class="si">{0[0]:7.1f}</span><span class="s1"> </span><span class="si">{0[1]:7.1f}</span><span class="s1"> </span><span class="si">{0[2]:7.1f}</span><span class="s1"> </span><span class="si">{0[3]:7.2f}</span><span class="s1"> </span><span class="si">{0[4]:7.3f}</span><span class="s1"> </span><span class="si">{0[5]:7.3f}</span><span class="s1"> </span><span class="si">{0[6]:7.3f}</span><span class="s1"> |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sT</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------|---------------------------------------------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">with_vel</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; rates |  (mm/y)  (mm/y)  (mm/y) (ppb/y) (mas/y) (mas/y) (mas/y) |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------|---------------------------------------------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;       | </span><span class="si">{0[7]:7.1f}</span><span class="s1"> </span><span class="si">{0[8]:7.1f}</span><span class="s1"> </span><span class="si">{0[9]:7.1f}</span><span class="s1"> </span><span class="si">{0[10]:7.2f}</span><span class="s1"> </span><span class="si">{0[11]:7.3f}</span><span class="s1"> </span><span class="si">{0[12]:7.3f}</span><span class="s1"> </span><span class="si">{0[13]:7.3f}</span><span class="s1"> |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  +/-  | </span><span class="si">{0[7]:7.1f}</span><span class="s1"> </span><span class="si">{0[8]:7.1f}</span><span class="s1"> </span><span class="si">{0[9]:7.1f}</span><span class="s1"> </span><span class="si">{0[10]:7.2f}</span><span class="s1"> </span><span class="si">{0[11]:7.3f}</span><span class="s1"> </span><span class="si">{0[12]:7.3f}</span><span class="s1"> </span><span class="si">{0[13]:7.3f}</span><span class="s1"> |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sT</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------|---------------------------------------------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Write residuals</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Residuals :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-----------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># 1st case : 14 parameters</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">with_vel</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;             |         Raw residuals (mm, mm/y)          |           Normalized residuals            |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------------|-------------------------------------------|-------------------------------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;code pt soln |    E      N      H     VE     VN     VH   |    E      N      H     VE     VN     VH   |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------------|-------------------------------------------|-------------------------------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsta</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0[0]:6.1f}</span><span class="s1"> </span><span class="si">{0[1]:6.1f}</span><span class="s1"> </span><span class="si">{0[2]:6.1f}</span><span class="s1"> </span><span class="si">{0[3]:6.1f}</span><span class="s1"> </span><span class="si">{0[4]:6.1f}</span><span class="s1"> </span><span class="si">{0[5]:6.1f}</span><span class="s1"> |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vl</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0[0]:6.1f}</span><span class="s1"> </span><span class="si">{0[1]:6.1f}</span><span class="s1"> </span><span class="si">{0[2]:6.1f}</span><span class="s1"> </span><span class="si">{0[3]:6.1f}</span><span class="s1"> </span><span class="si">{0[4]:6.1f}</span><span class="s1"> </span><span class="si">{0[5]:6.1f}</span><span class="s1"> |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vn</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------------|-------------------------------------------|-------------------------------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># 2nd case : 7 parameters</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;             |  Raw residuals (mm)  | Normalized residuals |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------------|----------------------|----------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;code pt soln |    E      N      H   |    E      N      H   |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------------|----------------------|----------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsta</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0[0]:6.1f}</span><span class="s1"> </span><span class="si">{0[1]:6.1f}</span><span class="s1"> </span><span class="si">{0[2]:6.1f}</span><span class="s1"> |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vl</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0[0]:6.1f}</span><span class="s1"> </span><span class="si">{0[1]:6.1f}</span><span class="s1"> </span><span class="si">{0[2]:6.1f}</span><span class="s1"> |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vn</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------------|----------------------|----------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">,</span> <span class="n">vl</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : trim_metadata</span>
<span class="c1"># Purpose : Remove metadata that are not relevant for specified period</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 18-May-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - start : Start of period of interest in SINEX format</span>
<span class="c1">#           - end   : End of period of interest in SINEX format</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.trim_metadata"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.trim_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">trim_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Loop over stations</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>

            <span class="c1"># Loop over receivers</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">receiver</span><span class="p">)):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">receiver</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># If current receiver is relevant for specified period, keep it.</span>
                <span class="k">if</span> <span class="p">(((</span><span class="n">earlier</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">))</span> <span class="ow">and</span>
                    <span class="p">((</span><span class="n">earlier</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">end</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">end</span>   <span class="o">==</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">))):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

                <span class="c1"># Else, remove it.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">receiver</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># Loop over antennas</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">antenna</span><span class="p">)):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">antenna</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># If current antenna is relevant for specified period, keep it.</span>
                <span class="k">if</span> <span class="p">(((</span><span class="n">earlier</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">))</span> <span class="ow">and</span>
                    <span class="p">((</span><span class="n">earlier</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">end</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">end</span>   <span class="o">==</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">))):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

                <span class="c1"># Else, remove it.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">antenna</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># Loop over eccentricities</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">eccentricity</span><span class="p">)):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">eccentricity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># If current eccentricity is relevant for specified period, keep it.</span>
                <span class="k">if</span> <span class="p">(((</span><span class="n">earlier</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">))</span> <span class="ow">and</span>
                    <span class="p">((</span><span class="n">earlier</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">end</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">end</span>   <span class="o">==</span> <span class="s1">&#39;00:000:00000&#39;</span><span class="p">))):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

                <span class="c1"># Else, remove it.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">eccentricity</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : update_stalist</span>
<span class="c1"># Purpose : Given an AC solution, update list of stations in the IGS combined solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 16-May-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - sta : Station list</span>
<span class="c1">#           - ac  : AC combination options</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.update_stalist"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.update_stalist">[docs]</a>    <span class="k">def</span> <span class="nf">update_stalist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">ac</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Loop over stations in AC solution</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>

            <span class="c1"># If current station is not yet in station list,</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">r</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sta</span><span class="p">])):</span>

                <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                <span class="n">r</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">code</span>
                <span class="n">r</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">pt</span>
                <span class="n">r</span><span class="o">.</span><span class="n">domes</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">domes</span>
                <span class="n">r</span><span class="o">.</span><span class="n">tech</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">tech</span>
                <span class="n">r</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">lon</span>
                <span class="n">r</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">lat</span>
                <span class="n">r</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">h</span>
                <span class="n">r</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">description</span>
                <span class="n">r</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">r</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="p">],</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">r</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">i</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                <span class="n">i</span><span class="o">.</span><span class="n">ac</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">name</span>
                <span class="n">i</span><span class="o">.</span><span class="n">receiver</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">receiver</span>
                <span class="n">i</span><span class="o">.</span><span class="n">antenna</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">antenna</span>
                <span class="n">i</span><span class="o">.</span><span class="n">eccentricity</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">eccentricity</span>
                <span class="n">r</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                <span class="n">sta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

            <span class="c1"># Else (current station already in station list),</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">r</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>

                <span class="n">i</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
                <span class="n">i</span><span class="o">.</span><span class="n">ac</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">name</span>
                <span class="n">i</span><span class="o">.</span><span class="n">receiver</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">receiver</span>
                <span class="n">i</span><span class="o">.</span><span class="n">antenna</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">antenna</span>
                <span class="n">i</span><span class="o">.</span><span class="n">eccentricity</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">eccentricity</span>
                <span class="n">sta</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : get_core</span>
<span class="c1"># Purpose : Get list of core stations in a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 15-Nov-2013</span>
<span class="c1">#</span>
<span class="c1"># Changes : PR, 13-Feb-2014 : Add possibility to reject stations with abnormally large formal errors</span>
<span class="c1">#</span>
<span class="c1"># Input   : - file   : File containing list of core stations (IGb08_core.txt)</span>
<span class="c1">#           - ref    : Datum (sinex object)</span>
<span class="c1">#           - thr    : Threshold for rejecting stations whose formal errors exceed</span>
<span class="c1">#                      (thr * median of formal errors) either in East, North or Up.</span>
<span class="c1">#                      Default is None (no rejection).</span>
<span class="c1">#           - log    : Log file. Default is None.</span>
<span class="c1">#           - append : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.get_core"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.get_core">[docs]</a>    <span class="k">def</span> <span class="nf">get_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">thr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Read list of core stations</span>
        <span class="n">core</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">core</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Open log file</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">append</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="c1"># Write header</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sinex::get_core : Get list of core stations in a solution</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Build list of core stations available in snx : loop over core clusters</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="n">soln</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">core</span><span class="p">)):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">b</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Look for any station of current cluster in snx and ref</span>
            <span class="k">while</span> <span class="p">((</span><span class="ow">not</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">core</span><span class="p">[</span><span class="n">i</span><span class="p">]))):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">core</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                    <span class="n">isnx</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">core</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">core</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">isnx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">isnx</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1"># If one station of the cluster was found in snx and ref,</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">):</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">core</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">isnx</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>
                <span class="n">soln</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">isnx</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> : core station found</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">core</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>

            <span class="c1"># Else,</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> : not available</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">core</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># If requested, reject stations with abnormally large formal errors</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">thr</span><span class="p">):</span>

            <span class="c1"># Compute 3D formal errors</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Get indices of outliers</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">sig</span> <span class="o">&gt;</span> <span class="n">thr</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sig</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># If any outlier,</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>

                <span class="c1"># Write outliers into log file</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> : Rejected because of abnormally large formal error</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>

                <span class="c1"># Reject outliers</span>
                <span class="n">indk</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))),</span> <span class="n">ind</span><span class="p">)</span>
                <span class="n">code</span> <span class="o">=</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
                <span class="n">pt</span>   <span class="o">=</span> <span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>
                <span class="n">soln</span> <span class="o">=</span> <span class="p">[</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indk</span><span class="p">]</span>

        <span class="c1"># Close log file</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : extract_core</span>
<span class="c1"># Purpose : Extract core stations from a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 15-Nov-2013</span>
<span class="c1">#</span>
<span class="c1"># Changes : PR, 13-Feb-2014 : Add possibility to reject stations with abnormally large formal errors</span>
<span class="c1">#</span>
<span class="c1"># Input   : - file   : File containing list of core stations (IGb08_core.txt)</span>
<span class="c1">#           - ref    : Datum (sinex object)</span>
<span class="c1">#           - thr    : Threshold for rejecting stations whose formal errors exceed</span>
<span class="c1">#                      (thr * median of formal errors) either in East, North or Up.</span>
<span class="c1">#                      Default is None (no rejection).</span>
<span class="c1">#           - log    : Log file. Default is None.</span>
<span class="c1">#           - append : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.extract_core"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.extract_core">[docs]</a>    <span class="k">def</span> <span class="nf">extract_core</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">thr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Get list of core stations</span>
        <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">)</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">get_core</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">thr</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">append</span><span class="p">)</span>

        <span class="c1"># Remove non-core stations from snx</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">keep_sta</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">append</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : calib_lod</span>
<span class="c1"># Purpose : Calibrate LOD estimates wrt reference series (Bulletin A)</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 17-Dec-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes : PR, 25-Sep-2014 : Apply correction at the normal equation level</span>
<span class="c1">#</span>
<span class="c1"># Input   : - rec    : erp object or file containing time series of LOD estimates</span>
<span class="c1">#           - ref    : Reference erp object or file (Bulletin A)</span>
<span class="c1">#           - log    : Log file. Default is None.</span>
<span class="c1">#           - append : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1">#     def calib_lod(self, rec, ref, log=None, append=False):</span>
<span class="c1"># </span>
<span class="c1">#         # snx = self for class methof # Added JMN 05/01/2018</span>
<span class="c1">#         snx = self</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1">#         # If necessary, open log file and write header</span>
<span class="c1">#         if (log):</span>
<span class="c1">#             if (append):</span>
<span class="c1">#                 f = open(log, &#39;a&#39;)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 f = open(log, &#39;w&#39;)</span>
<span class="c1"># </span>
<span class="c1">#             # Write header</span>
<span class="c1">#             f.write(&#39;================================================================================\n&#39;)</span>
<span class="c1">#             f.write(&#39;sinex::calib_lod : Calibrate LOD estimates wrt reference series (Bulletin A)\n&#39;)</span>
<span class="c1">#             f.write(&#39;================================================================================\n&#39;)</span>
<span class="c1">#             f.write(&#39;\n&#39;)</span>
<span class="c1"># </span>
<span class="c1">#         # Read ERP time series</span>
<span class="c1">#         if (rec.__class__.__name__ != &#39;erp&#39;):</span>
<span class="c1">#             rec = erp.read_igs(rec)</span>
<span class="c1"># </span>
<span class="c1">#         # Read reference ERP time series</span>
<span class="c1">#         if (ref.__class__.__name__ != &#39;erp&#39;):</span>
<span class="c1">#             ref = erp.read_bulla(ref)</span>
<span class="c1"># </span>
<span class="c1">#         # Loop over LOD parameters in sinex object</span>
<span class="c1">#         for i in range(snx.npar):</span>
<span class="c1">#             p = snx.param[i]</span>
<span class="c1">#             if (p.type == &#39;LOD   &#39;):</span>
<span class="c1"># </span>
<span class="c1">#                 # Initializations</span>
<span class="c1">#                 b = 0</span>
<span class="c1">#                 n = 0</span>
<span class="c1">#                 mjdref = (date.from_snxepoch(p.tref)).mjd</span>
<span class="c1"># </span>
<span class="c1">#                 # Loop over the 10 previous days</span>
<span class="c1">#                 for mjd in numpy.arange(mjdref-10, mjdref):</span>
<span class="c1">#                     if ((mjd in rec.mjd) and (mjd in ref.mjd)):</span>
<span class="c1">#                         irec = (numpy.nonzero(rec.mjd == mjd))[0][0]</span>
<span class="c1">#                         iref = (numpy.nonzero(ref.mjd == mjd))[0][0]</span>
<span class="c1">#                         b = b + ref.lod[iref] - rec.lod[irec]</span>
<span class="c1">#                         n = n+1</span>
<span class="c1"># </span>
<span class="c1">#                 # If at least one previous day was available,</span>
<span class="c1">#                 if (n &gt; 0):</span>
<span class="c1"># </span>
<span class="c1">#                     # Modify normal equation</span>
<span class="c1">#                     b = b / n</span>
<span class="c1">#                     snx.k = snx.k + b * snx.N[:,i]</span>
<span class="c1"># </span>
<span class="c1">#                     # Write message in log file</span>
<span class="c1">#                     if (log):</span>
<span class="c1">#                         f.write(&#39;LOD    {0.soln} {0.tref} corrected by {1:21.14e} ms (mean over {2:2d} days)\n&#39;.format(p, b, n))</span>
<span class="c1"># </span>
<span class="c1">#                 # Else, write message in log file</span>
<span class="c1">#                 elif (log):</span>
<span class="c1">#                     f.write(&#39;LOD    {0.soln} {0.tref} NOT corrected !\n&#39;.format(p))</span>
<span class="c1"># </span>
<span class="c1">#         # Close log file if necessary</span>
<span class="c1">#         if (log):</span>
<span class="c1">#             f.write(&#39;\n&#39;)</span>
<span class="c1">#             f.close()</span>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : apriori_sf</span>
<span class="c1"># Purpose : Compute a priori scale factor of a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 16-May-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - stdref : Reference 3D formal error (mm)</span>
<span class="c1"># Output  : - sf     : A priori scale factor</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.apriori_sf"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.apriori_sf">[docs]</a>    <span class="k">def</span> <span class="nf">apriori_sf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stdref</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Get list of points in solution</span>
        <span class="n">ind</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
        <span class="n">pt</span>   <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
        <span class="n">soln</span> <span class="o">=</span> <span class="p">[</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>

        <span class="c1"># Get 3D formal errors</span>
        <span class="n">senh</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">get_sigenh</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">)</span>
        <span class="n">s3d</span>  <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">senh</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Compute a priori scale factor, given reference 3D formal error</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">stdref</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">s3d</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>

        <span class="k">return</span> <span class="n">sf</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : add_metadata</span>
<span class="c1"># Purpose : Add metadata blocks into a sinex object</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 09-Mar-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - metasnx  : sinex object with information from sitelogs</span>
<span class="c1">#           - ref      : File with information for FILE/REFERENCE block. Default is None.</span>
<span class="c1">#           - comments : File with information for FILE/COMMENTS block. Default is None.</span>
<span class="c1">#           - acks     : File with information for INPUT/ACKNOWLEDGEMENTS block. Default is None.</span>
<span class="c1">#           - t        : date object (needed for FILE/REFERENCE block). Default is None.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.add_metadata"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.add_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metasnx</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Fill FILE/REFERENCE block if requested</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">read_yaml</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">sed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>

            <span class="c1"># Replace agency if specified in the reference record</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">agency</span><span class="p">):</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">agency</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">agency</span>

        <span class="c1"># Fill FILE/COMMENTS block if requested</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">comments</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">read_yaml</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>

        <span class="c1"># Fill INPUT/ACKNOWLEDGEMENTS if requested</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">acks</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">acks</span> <span class="o">=</span> <span class="n">read_yaml</span><span class="p">(</span><span class="n">acks</span><span class="p">)</span>

        <span class="c1"># Loop over stations with available metadata</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="p">[</span><span class="n">metas</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">metas</span> <span class="ow">in</span> <span class="n">metasnx</span><span class="o">.</span><span class="n">sta</span><span class="p">]):</span>

                <span class="c1"># Index of current station in metasnx.sta</span>
                <span class="n">im</span> <span class="o">=</span> <span class="p">[</span><span class="n">metas</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">metas</span> <span class="ow">in</span> <span class="n">metasnx</span><span class="o">.</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                <span class="n">metas</span> <span class="o">=</span> <span class="n">metasnx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">im</span><span class="p">]</span>

                <span class="c1"># Copy station metadata from metasnx to snx</span>
                <span class="n">s</span><span class="o">.</span><span class="n">receiver</span>     <span class="o">=</span> <span class="n">metas</span><span class="o">.</span><span class="n">receiver</span>
                <span class="n">s</span><span class="o">.</span><span class="n">antenna</span>      <span class="o">=</span> <span class="n">metas</span><span class="o">.</span><span class="n">antenna</span>
                <span class="n">s</span><span class="o">.</span><span class="n">eccentricity</span> <span class="o">=</span> <span class="n">metas</span><span class="o">.</span><span class="n">eccentricity</span>

        <span class="c1">## Loop over antennas to fill snx.antenna</span>
        <span class="c1">#snx.antenna = []</span>
        <span class="c1">#for s in snx.sta:</span>
            <span class="c1">#for a in s.antenna:</span>

                <span class="c1">## If current antenna is not yet in snx.antenna,</span>
                <span class="c1">#if (not(a.type in [ant.type for ant in snx.antenna])):</span>

                    <span class="c1">## And if current antenna is in metasnx.antenna,</span>
                    <span class="c1">#if (a.type in [ant.type for ant in metasnx.antenna]):</span>

                        <span class="c1">## Add current antenna to snx.antenna</span>
                        <span class="c1">#ind = [ant.type for ant in metasnx.antenna].index(a.type)</span>
                        <span class="c1">#snx.antenna.append(metasnx.antenna[ind])</span>

        <span class="c1"># Copy metasnx.antenna to snx.antenna</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">antenna</span> <span class="o">=</span> <span class="n">metasnx</span><span class="o">.</span><span class="n">antenna</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : get_residuals</span>
<span class="c1"># Purpose : Compare solution to a reference solution and get necessary information for res file</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 20-May-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - ref  : Reference solution (sinex object)</span>
<span class="c1">#           - erp  : True if ERPs should be compared. Default is False.</span>
<span class="c1">#           - gc   : True if origins should be compared. Default is False.</span>
<span class="c1"># Output  : - code : 4-char codes of common points</span>
<span class="c1">#           - pt   : PT codes of common points</span>
<span class="c1">#           - soln : Solution numbers of common points</span>
<span class="c1">#           - v    : E,N,H station position residuals (mm)</span>
<span class="c1">#           - s    : E,N,H station position formal errors (mm)</span>
<span class="c1">#           - verp : ERP residuals</span>
<span class="c1">#           - serp : ERP formal errors</span>
<span class="c1">#           - vgc  : Geocenter residuals (mm)</span>
<span class="c1">#           - sgc  : Geocenter formal errors (mm)</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.get_residuals"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.get_residuals">[docs]</a>    <span class="k">def</span> <span class="nf">get_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">erp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Helmert comparison</span>
        <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">helmert_wrt</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="s1">&#39;RT&#39;</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>

        <span class="c1"># Get E,N,H station position formal errors</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">get_sigenh</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">)</span>

        <span class="c1"># If ERPs should be compared,</span>
        <span class="n">verp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">serp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="p">):</span>

            <span class="c1"># Initializations</span>
            <span class="n">nerp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;XPO   &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">verp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="n">nerp</span><span class="p">))</span>
            <span class="n">serp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="n">nerp</span><span class="p">))</span>
            <span class="n">ixpo</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">ixpor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">iypo</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">iypor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">iut</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">ilod</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="c1"># Loop over ERPs</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">)):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;XPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">,</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">,</span> <span class="s1">&#39;UT    &#39;</span><span class="p">,</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">]):</span>

                    <span class="c1"># Get index of corresponding parameter in reference solution</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">q</span><span class="o">.</span><span class="n">tref</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">tref</span><span class="p">)</span>

                    <span class="c1"># Store corresponding residual and formal error</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPO   &#39;</span><span class="p">):</span>
                        <span class="n">ixpo</span> <span class="o">=</span> <span class="n">ixpo</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">verp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ixpo</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                        <span class="n">serp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ixpo</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">):</span>
                        <span class="n">ixpor</span> <span class="o">=</span> <span class="n">ixpor</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">verp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ixpor</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                        <span class="n">serp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ixpor</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">):</span>
                        <span class="n">iypo</span> <span class="o">=</span> <span class="n">iypo</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">verp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">iypo</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                        <span class="n">serp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">iypo</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">):</span>
                        <span class="n">iypor</span> <span class="o">=</span> <span class="n">iypor</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">verp</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">iypor</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                        <span class="n">serp</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">iypor</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;UT    &#39;</span><span class="p">):</span>
                        <span class="n">iut</span> <span class="o">=</span> <span class="n">iut</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">verp</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">iut</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">15</span><span class="o">*</span><span class="n">dera_dt</span><span class="p">)</span>
                        <span class="n">serp</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">iut</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">):</span>
                        <span class="n">ilod</span> <span class="o">=</span> <span class="n">ilod</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">verp</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">ilod</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                        <span class="n">serp</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">ilod</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># If geocenters should be compared,</span>
        <span class="n">vgc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sgc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gc</span><span class="p">):</span>

            <span class="c1"># If solution contains an XGC parameter</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;XGC   &#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>

                <span class="c1"># Get indices of XGC parameters in both solutions</span>
                <span class="n">ind</span>  <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;XGC   &#39;</span><span class="p">)</span>
                <span class="n">indr</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;XGC   &#39;</span><span class="p">)</span>

                <span class="c1"># Geocenter residuals</span>
                <span class="n">vgc</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indr</span><span class="p">:</span><span class="n">indr</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span> <span class="o">-</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

                <span class="c1"># Geocenter formal errors</span>
                <span class="n">sgc</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">verp</span><span class="p">,</span> <span class="n">serp</span><span class="p">,</span> <span class="n">vgc</span><span class="p">,</span> <span class="n">sgc</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : check_sat_pco</span>
<span class="c1"># Purpose : Check satellite antenna phase center offsets</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 18-Nov-2014</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - ref  : Reference sinex object containing nominal satellite PCOs</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.check_sat_pco"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.check_sat_pco">[docs]</a>    <span class="k">def</span> <span class="nf">check_sat_pco</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Loop over a priori SATA parameters</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">)):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">prior</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SATA&#39;</span><span class="p">):</span>

                <span class="c1"># Index of corresponding parameter in reference solution</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">pref</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">pref</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">pref</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>

                <span class="c1"># If a priori value differs from reference value,</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> : </span><span class="si">{2:21.14e}</span><span class="s1"> instead of </span><span class="si">{3:21.14e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : refsys_effect</span>
<span class="c1"># Purpose : Compute generalized reference system effect of a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 17-Nov-2011</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - params : List of keywords indicating on what &quot;parameters&quot; the reference</span>
<span class="c1">#                      system effect should be computed. It can contain the following</span>
<span class="c1">#                      keywords:</span>
<span class="c1">#                      - &#39;T&#39;    (How well is defined the origin of the solution?)</span>
<span class="c1">#                      - &#39;S&#39;    (How well is defined the scale of the solution?)</span>
<span class="c1">#                      - &#39;R&#39;    (How well is defined the orientation of the solution?)</span>
<span class="c1">#                      - &#39;dT&#39;   (How well is defined the origin rate of the solution?)</span>
<span class="c1">#                      - &#39;dS&#39;   (How well is defined the scale rate of the solution?)</span>
<span class="c1">#                      - &#39;dR&#39;   (How well is defined the orientation rate of the solution?)</span>
<span class="c1">#                      - &#39;XPO&#39;  (How well is defined the mean of the XPO parameters?)</span>
<span class="c1">#                      - &#39;XPOR&#39; (How well is defined the mean of the XPOR parameters?)</span>
<span class="c1">#                      - &#39;YPO&#39;  (How well is defined the mean of the YPO parameters?)</span>
<span class="c1">#                      - &#39;YPOR&#39; (How well is defined the mean of the YPOR parameters?)</span>
<span class="c1">#                      - &#39;UT&#39;   (How well is defined the mean of the UT parameters?)</span>
<span class="c1">#                      - &#39;LOD&#39;  (How well is defined the mean of the LOD parameters?)</span>
<span class="c1">#                      - &#39;XPCO&#39; (How well is defined the mean of the SATA_X parameters?)</span>
<span class="c1">#                      - &#39;YPCO&#39; (How well is defined the mean of the SATA_Y parameters?)</span>
<span class="c1">#                      - &#39;ZPCO&#39; (How well is defined the mean of the SATA_Z parameters?)</span>
<span class="c1">#                      - &#39;GC&#39;   (How well are defined the XGC/YGC/ZGC parameters?)</span>
<span class="c1">#                      - &#39;mT&#39;   (How well are defined the means of the TX/TY/TZ parameters - in case of a combined solution?)</span>
<span class="c1">#                      - &#39;mS&#39;   (How well is defined the mean of the SC parameters - in case of a combined solution?)</span>
<span class="c1">#                      - &#39;mR&#39;   (How well are defined the means of the RX/RY/RZ parameters - in case of a combined solution?)</span>
<span class="c1">#                      - &#39;all&#39;  (Compute reference system effect on all possible &quot;parameters&quot;. This is the default.)</span>
<span class="c1">#           - log    : Log file. Default is None.</span>
<span class="c1">#           - append : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.refsys_effect"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.refsys_effect">[docs]</a>    <span class="k">def</span> <span class="nf">refsys_effect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Initializations</span>
        <span class="n">par_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TX&#39;</span><span class="p">,</span> <span class="s1">&#39;TY&#39;</span><span class="p">,</span> <span class="s1">&#39;TZ&#39;</span><span class="p">,</span> <span class="s1">&#39;SC&#39;</span><span class="p">,</span> <span class="s1">&#39;RX&#39;</span><span class="p">,</span> <span class="s1">&#39;RY&#39;</span><span class="p">,</span> <span class="s1">&#39;RZ&#39;</span><span class="p">,</span> <span class="s1">&#39;dTX&#39;</span><span class="p">,</span> <span class="s1">&#39;dTY&#39;</span><span class="p">,</span> <span class="s1">&#39;dTZ&#39;</span><span class="p">,</span> <span class="s1">&#39;dSC&#39;</span><span class="p">,</span> <span class="s1">&#39;dRX&#39;</span><span class="p">,</span> <span class="s1">&#39;dRY&#39;</span><span class="p">,</span> <span class="s1">&#39;dRZ&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;mXPO&#39;</span><span class="p">,</span> <span class="s1">&#39;mXPOR&#39;</span><span class="p">,</span> <span class="s1">&#39;mYPO&#39;</span><span class="p">,</span> <span class="s1">&#39;mYPOR&#39;</span><span class="p">,</span> <span class="s1">&#39;mUT&#39;</span><span class="p">,</span> <span class="s1">&#39;mLOD&#39;</span><span class="p">,</span> <span class="s1">&#39;mXPCO&#39;</span><span class="p">,</span> <span class="s1">&#39;mYPCO&#39;</span><span class="p">,</span> <span class="s1">&#39;mZPCO&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;XGC&#39;</span><span class="p">,</span> <span class="s1">&#39;YGC&#39;</span><span class="p">,</span> <span class="s1">&#39;ZGC&#39;</span><span class="p">,</span> <span class="s1">&#39;mTX&#39;</span><span class="p">,</span> <span class="s1">&#39;mTY&#39;</span><span class="p">,</span> <span class="s1">&#39;mTZ&#39;</span><span class="p">,</span> <span class="s1">&#39;mSC&#39;</span><span class="p">,</span> <span class="s1">&#39;mRX&#39;</span><span class="p">,</span> <span class="s1">&#39;mRY&#39;</span><span class="p">,</span> <span class="s1">&#39;mRZ&#39;</span><span class="p">]</span>
        <span class="n">par_units</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;ppb&#39;</span><span class="p">,</span> <span class="s1">&#39;mas&#39;</span><span class="p">,</span> <span class="s1">&#39;mas&#39;</span><span class="p">,</span> <span class="s1">&#39;mas&#39;</span><span class="p">,</span> <span class="s1">&#39;mm/y&#39;</span><span class="p">,</span> <span class="s1">&#39;mm/y&#39;</span><span class="p">,</span> <span class="s1">&#39;mm/y&#39;</span><span class="p">,</span> <span class="s1">&#39;ppb/y&#39;</span><span class="p">,</span> <span class="s1">&#39;mas/y&#39;</span><span class="p">,</span> <span class="s1">&#39;mas/y&#39;</span><span class="p">,</span> <span class="s1">&#39;mas/y&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;mas&#39;</span><span class="p">,</span> <span class="s1">&#39;mas/d&#39;</span><span class="p">,</span> <span class="s1">&#39;mas&#39;</span><span class="p">,</span> <span class="s1">&#39;mas/d&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;ms/d&#39;</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="s1">&#39;ppb&#39;</span><span class="p">,</span> <span class="s1">&#39;mas&#39;</span><span class="p">,</span> <span class="s1">&#39;mas&#39;</span><span class="p">,</span> <span class="s1">&#39;mas&#39;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;NoneType&#39;</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x0</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">par_names</span><span class="p">)))</span>

        <span class="c1"># Fill design matrix</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">)):</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1e-3</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1e-3</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1e-3</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;VELX  &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>  <span class="o">=</span>  <span class="mf">1e-3</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">1e-9</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPO   &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XPOR  &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YPOR  &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;UT    &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;LOD   &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_X&#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_Y&#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SATA_Z&#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;XGC   &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;YGC   &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;ZGC   &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TX    &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TY    &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TZ    &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;SC    &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;RX    &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;RY    &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;RZ    &#39;</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Get indices of required parameters</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">)))</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;dT&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;dS&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;dR&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">)))</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;XPO&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;XPOR&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;YPO&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;YPOR&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;UT&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;LOD&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;XPCO&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;YPCO&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ZPCO&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;GC&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">26</span><span class="p">)))</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mT&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">29</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mS&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">29</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;mR&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">33</span><span class="p">)))</span>

        <span class="c1"># Restrict design matrix to required parameters</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span><span class="n">ind</span><span class="p">]</span>

        <span class="c1"># Solution&#39;s normal matrix</span>
        <span class="n">N</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;NoneType&#39;</span><span class="p">):</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">N</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span>

        <span class="c1"># Covariance matrix of reference frame parameters</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">A</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>

        <span class="c1">## Covariance matrix of reference frame parameters</span>
        <span class="c1">#B = dot(syminv(dot(A.T, A)), A.T)</span>
        <span class="c1">#Q = dot(B, dot(snx.Q, B.T))</span>

        <span class="c1"># Correlation matrix</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">Q2C</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>

        <span class="c1"># Put correlations in a vector</span>
        <span class="n">name1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">corr</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Q</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">name1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                <span class="n">name2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
                <span class="n">corr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>

        <span class="c1"># Sort correlations by absolute values</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">corr</span><span class="p">))</span>

        <span class="c1"># Print results - 1st case : No log file</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Standard deviations of meta-parameters:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------------------&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;mm&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1">    mm ~ </span><span class="si">{1:15.8f}</span><span class="s1">    mm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;ppb&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1">   ppb ~ </span><span class="si">{2:15.8f}</span><span class="s1">    mm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mf">1e-6</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;mas&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1">   mas ~ </span><span class="si">{2:15.8f}</span><span class="s1">    mm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mi">1000</span><span class="o">*</span><span class="n">mas2rad</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;mm/y&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1">  mm/y ~ </span><span class="si">{1:15.8f}</span><span class="s1">  mm/y&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;ppb/y&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1"> ppb/y ~ </span><span class="si">{2:15.8f}</span><span class="s1">  mm/y&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mf">1e-6</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;mas/y&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1"> mas/y ~ </span><span class="si">{2:15.8f}</span><span class="s1">  mm/y&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mi">1000</span><span class="o">*</span><span class="n">mas2rad</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;mas/d&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1"> mas/d ~ </span><span class="si">{2:15.8f}</span><span class="s1">  mm/d&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mi">1000</span><span class="o">*</span><span class="n">mas2rad</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;ms&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1">    ms ~ </span><span class="si">{2:15.8f}</span><span class="s1">    mm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mi">1000</span><span class="o">*</span><span class="n">ms2rad</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;ms/d&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1">  ms/d ~ </span><span class="si">{2:15.8f}</span><span class="s1">  mm/d&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mi">1000</span><span class="o">*</span><span class="n">ms2rad</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correlations:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> - </span><span class="si">{1:&gt;5s}</span><span class="s1"> : </span><span class="si">{2:13.10f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name1</span><span class="p">[</span><span class="n">ic</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">name2</span><span class="p">[</span><span class="n">ic</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">corr</span><span class="p">[</span><span class="n">ic</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Print results - 2nd case : Log file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">append</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sinex::refsys_effect : Compute generalized reference system effect of a solution</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Standard deviations of meta-parameters:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;---------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;mm&#39;</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1">    mm ~ </span><span class="si">{1:15.8f}</span><span class="s1">    mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;ppb&#39;</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1">   ppb ~ </span><span class="si">{2:15.8f}</span><span class="s1">    mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mf">1e-6</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;mas&#39;</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1">   mas ~ </span><span class="si">{2:15.8f}</span><span class="s1">    mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mi">1000</span><span class="o">*</span><span class="n">mas2rad</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;mm/y&#39;</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1">  mm/y ~ </span><span class="si">{1:15.8f}</span><span class="s1">  mm/y</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;ppb/y&#39;</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1"> ppb/y ~ </span><span class="si">{2:15.8f}</span><span class="s1">  mm/y</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mf">1e-6</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;mas/y&#39;</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1"> mas/y ~ </span><span class="si">{2:15.8f}</span><span class="s1">  mm/y</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mi">1000</span><span class="o">*</span><span class="n">mas2rad</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;mas/d&#39;</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1"> mas/d ~ </span><span class="si">{2:15.8f}</span><span class="s1">  mm/d</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mi">1000</span><span class="o">*</span><span class="n">mas2rad</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;ms&#39;</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1">    ms ~ </span><span class="si">{2:15.8f}</span><span class="s1">    mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mi">1000</span><span class="o">*</span><span class="n">ms2rad</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">par_units</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;ms/d&#39;</span><span class="p">):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> : </span><span class="si">{1:15.8f}</span><span class="s1">  ms/d ~ </span><span class="si">{2:15.8f}</span><span class="s1">  mm/d</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">par_names</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]),</span> <span class="mi">1000</span><span class="o">*</span><span class="n">ms2rad</span><span class="o">*</span><span class="n">ae</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">])))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Correlations:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;5s}</span><span class="s1"> - </span><span class="si">{1:&gt;5s}</span><span class="s1"> : </span><span class="si">{2:13.10f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name1</span><span class="p">[</span><span class="n">ic</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">name2</span><span class="p">[</span><span class="n">ic</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">corr</span><span class="p">[</span><span class="n">ic</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : correct_opoleload</span>
<span class="c1"># Purpose : Correct ocean pole tide loading displacements in a normal equation</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 10-Feb-2015</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - opole   : Object containing interpolating splines for the 6 OPTL coefficients</span>
<span class="c1">#           - mjd     : MJD</span>
<span class="c1">#           - meanpm  : Keyword indicating which mean pole model should be used</span>
<span class="c1">#                       (&#39;IERS2003&#39; or &#39;IERS2010&#39;). Default is &#39;IERS2010&#39;.</span>
<span class="c1">#           - reverse : True if ocean pole tide displacements should be added back instead</span>
<span class="c1">#                       of removed. Default is False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.correct_opoleload"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.correct_opoleload">[docs]</a>    <span class="k">def</span> <span class="nf">correct_opoleload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opole</span><span class="p">,</span> <span class="n">mjd</span><span class="p">,</span> <span class="n">meanpm</span><span class="o">=</span><span class="s1">&#39;IERS2010&#39;</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Get indices of STAX parameters</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get station coordinates and XYZ-&gt;ENH rotation matrices</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)):</span>
            <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">indx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="o">=</span> <span class="n">cart2geo</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="mi">180</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="n">phi</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="mi">180</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="n">lam</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">xyz2enh</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Get pole coordinates</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;XPO   &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xpo</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;YPO   &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ypo</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

        <span class="c1"># Compute ENH ocean pole tide loading displacements</span>
        <span class="n">denh</span> <span class="o">=</span> <span class="n">compute_opoleload</span><span class="p">(</span><span class="n">opole</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">mjd</span><span class="p">,</span> <span class="n">xpo</span><span class="p">,</span> <span class="n">ypo</span><span class="p">,</span> <span class="n">meanpm</span><span class="p">)</span>

        <span class="c1"># Compute vector of XYZ displacements</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)):</span>
            <span class="n">dx</span><span class="p">[</span><span class="n">indx</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">indx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">denh</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>

        <span class="c1"># If necessary, change sign of displacements</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">reverse</span><span class="p">):</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="o">-</span><span class="n">dx</span>

        <span class="c1"># Modify 2nd member of normal equation</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">k</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span></div>

        <span class="c1">## Modify estimated station positions</span>
        <span class="c1">#snx.x = snx.x - dx</span>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : get_nonpubsolns</span>
<span class="c1"># Purpose : Get list of solns to remove from official IGS cumulative solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 13-Jun-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - sigmax : Maximal velocity formal error (m/y)</span>
<span class="c1">#           - fcontr : File with velocity constraints</span>
<span class="c1"># Output  : - code   : 4-char codes of solns to remove</span>
<span class="c1">#           - pt     : PT codes of solns to remove</span>
<span class="c1">#           - soln   : Solution numbers of solns to remove</span>
<span class="c1">#           - domes  : DOMES numbers of solns to remove</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.get_nonpubsolns"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.get_nonpubsolns">[docs]</a>    <span class="k">def</span> <span class="nf">get_nonpubsolns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigmax</span><span class="p">,</span> <span class="n">fcontr</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Initialization</span>
        <span class="n">code</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt</span>    <span class="o">=</span> <span class="p">[]</span>
        <span class="n">soln</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="n">domes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get list of solns with constrained velocities</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fcontr</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0.0000  0.0000  0.0000&#39;</span><span class="p">):</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">64</span><span class="p">:</span><span class="mi">68</span><span class="p">])</span>
                <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">69</span><span class="p">:</span><span class="mi">71</span><span class="p">])</span>
                <span class="n">soln</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">])</span>
                <span class="n">domes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Loop over stations</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Keep current station if it has a DOMES number</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">domes</span> <span class="o">!=</span> <span class="s1">&#39;     M   &#39;</span><span class="p">):</span>

                <span class="c1"># and at least one velocity with formal error &lt; sigmax</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;VELX  &#39;</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">&lt;</span> <span class="n">sigmax</span><span class="p">):</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># If necessary, add all solns of current station to the black list</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">keep</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>
                    <span class="n">soln</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>
                    <span class="n">domes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">domes</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">,</span> <span class="n">domes</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : add_psd</span>
<span class="c1"># Purpose : Add post-seismic deformation models to a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 10-Nov-2015</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : psd : sinex object containing post-seismic deformation models</span>
<span class="c1"># Output  :</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.add_psd"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.add_psd">[docs]</a>    <span class="k">def</span> <span class="nf">add_psd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psd</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># List of stations with post-seismic deformation models</span>
        <span class="n">codept</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psd</span><span class="o">.</span><span class="n">param</span><span class="p">]</span>

        <span class="c1"># Loop over STAX parameters</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>

                <span class="c1"># If current station has post-seismic deformation models,</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="n">codept</span><span class="p">):</span>

                    <span class="c1"># Compute ENH post-seismic deformations</span>
                    <span class="p">(</span><span class="n">denh</span><span class="p">,</span> <span class="n">senh</span><span class="p">)</span> <span class="o">=</span> <span class="n">compute_psd</span><span class="p">(</span><span class="n">psd</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">tref</span><span class="p">)</span>

                    <span class="c1"># Compute XYZ post-seismic deformations</span>
                    <span class="n">R</span> <span class="o">=</span> <span class="n">xyz2enh</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">dxyz</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">denh</span><span class="p">)</span>
                    <span class="n">Qenh</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">senh</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">Qxyz</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">Qenh</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>

                    <span class="c1"># Add post-seismic deformations</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">dxyz</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">Qxyz</span>
                        <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]))</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : remove_psd</span>
<span class="c1"># Purpose : Remove post-seismic deformation models from a solution</span>
<span class="c1">#           (without touching covariance matrix)</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 16-Jan-2017</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : psd : sinex object containing post-seismic deformation models</span>
<span class="c1"># Output  :</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.remove_psd"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.remove_psd">[docs]</a>    <span class="k">def</span> <span class="nf">remove_psd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psd</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># List of stations with post-seismic deformation models</span>
        <span class="n">codept</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">psd</span><span class="o">.</span><span class="n">param</span><span class="p">]</span>

        <span class="c1"># Loop over STAX parameters</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>

                <span class="c1"># If current station has post-seismic deformation models,</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="n">codept</span><span class="p">):</span>

                    <span class="c1"># Compute ENH post-seismic deformations</span>
                    <span class="p">(</span><span class="n">denh</span><span class="p">,</span> <span class="n">senh</span><span class="p">)</span> <span class="o">=</span> <span class="n">compute_psd</span><span class="p">(</span><span class="n">psd</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">tref</span><span class="p">)</span>

                    <span class="c1"># Compute XYZ post-seismic deformations</span>
                    <span class="n">R</span> <span class="o">=</span> <span class="n">xyz2enh</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">dxyz</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">denh</span><span class="p">)</span>

                    <span class="c1"># Remove post-seismic deformations</span>
                    <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">dxyz</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : add_per</span>
<span class="c1"># Purpose : Add periodic terms to a solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 08-Mar-2016</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - file : File containing periodic term coefficients</span>
<span class="c1">#           - T    : Period (days)</span>
<span class="c1">#           - tref : Reference epoch</span>
<span class="c1"># Output  :</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.add_per"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.add_per">[docs]</a>    <span class="k">def</span> <span class="nf">add_per</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">tref</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Read input file</span>
        <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">,</span> <span class="n">ae</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">an</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">ah</span><span class="p">,</span> <span class="n">bh</span><span class="p">)</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;O,O,i,f,f,f,f,f,f&#39;</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pt</span><span class="p">]</span>
        <span class="n">soln</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0:4d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">soln</span><span class="p">]</span>
        <span class="n">codeptsoln</span> <span class="o">=</span> <span class="p">[</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">))]</span>

        <span class="c1"># Reference MJD</span>
        <span class="n">mjd0</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_snxepoch</span><span class="p">(</span><span class="n">tref</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span>

        <span class="c1"># Loop over STAX parameters</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>

                <span class="c1"># Get index of corresponding periodic terms</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">codeptsoln</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>

                <span class="c1"># Compute ENH deformations</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_snxepoch</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">tref</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span> <span class="o">-</span> <span class="n">mjd0</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="n">T</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="n">T</span><span class="p">)</span>
                <span class="n">denh</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">denh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ae</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">be</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="n">s</span>
                <span class="n">denh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">an</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">bn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="n">s</span>
                <span class="n">denh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ah</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">bh</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="n">s</span>

                <span class="c1"># Compute and add XYZ deformations</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">xyz2enh</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">denh</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : plate_poles</span>
<span class="c1"># Purpose : Estimate tectonic plate rotation poles from site velocities</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 10-Jun-2016</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - file      : File containing station &lt;-&gt; plate correspondence</span>
<span class="c1">#           - Trate     : True or False depending on whether a translation rate bias</span>
<span class="c1">#                         should be estimated. Default is True.</span>
<span class="c1">#           - weighting : Keyword to indicate which weighting should be used, i.e.,</span>
<span class="c1">#                         &#39;identity&#39;, &#39;diagonal&#39;, or &#39;full&#39; (default).</span>
<span class="c1">#           - log       : Log file. Default is None.</span>
<span class="c1">#           - append    : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  :</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.plate_poles"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.plate_poles">[docs]</a>    <span class="k">def</span> <span class="nf">plate_poles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">Trate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Read station &lt;-&gt; plate correspondence file</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">plate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">tab</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">plate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># List of plates</span>
        <span class="n">plate_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">plate</span><span class="p">))</span>

        <span class="c1"># Initializations</span>
        <span class="n">plate_nsta</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">plate_sta</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">plate_ivx</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over plates</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">plate_list</span><span class="p">)):</span>

            <span class="c1"># Initializations</span>
            <span class="n">sta</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ivx</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Loop over VELX parameters</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;VELX  &#39;</span><span class="p">):</span>

                    <span class="c1"># If current point belongs to current plate,</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">plate</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">==</span> <span class="n">plate_list</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="n">sta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                        <span class="n">ivx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

            <span class="c1"># If at least two points on current plate,</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>

                <span class="c1"># Sort stations</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">sta</span><span class="p">)</span>
                <span class="n">sta</span> <span class="o">=</span> <span class="p">[</span><span class="n">sta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
                <span class="n">ivx</span> <span class="o">=</span> <span class="p">[</span><span class="n">ivx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>

                <span class="c1"># Save information</span>
                <span class="n">plate_nsta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sta</span><span class="p">))</span>
                <span class="n">plate_sta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sta</span><span class="p">)</span>
                <span class="n">plate_ivx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ivx</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

            <span class="c1"># Else, remove current plate</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plate_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Sort plates</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">plate_list</span><span class="p">)</span>
        <span class="n">plate_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">plate_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
        <span class="n">plate_nsta</span> <span class="o">=</span> <span class="p">[</span><span class="n">plate_nsta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
        <span class="n">plate_sta</span> <span class="o">=</span> <span class="p">[</span><span class="n">plate_sta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>
        <span class="n">plate_ivx</span> <span class="o">=</span> <span class="p">[</span><span class="n">plate_ivx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">]</span>

        <span class="c1"># Initializations</span>
        <span class="n">nplate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plate_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Trate</span><span class="p">):</span>
            <span class="n">npar</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">nplate</span> <span class="o">+</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">npar</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">nplate</span>
        <span class="n">nsta</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">plate_nsta</span><span class="p">)</span>
        <span class="n">iQ</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nsta</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nsta</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">nsta</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsta</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nsta</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">nsta</span><span class="p">,</span> <span class="n">npar</span><span class="p">))</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">nsta</span><span class="p">))</span>
        <span class="n">ista</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Loop over stations</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nplate</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plate_nsta</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="n">ista</span> <span class="o">=</span> <span class="n">ista</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">iQ</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">plate_ivx</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">plate_ivx</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span>

                <span class="c1"># Get station coordinates</span>
                <span class="n">X</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">plate_ivx</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="n">plate_ivx</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span>
                <span class="n">V</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">plate_ivx</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]:</span><span class="n">plate_ivx</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
                <span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="o">=</span> <span class="n">cart2geo</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">lon</span><span class="p">[</span><span class="n">ista</span><span class="p">]</span> <span class="o">=</span> <span class="mi">180</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="n">lam</span>
                <span class="n">lat</span><span class="p">[</span><span class="n">ista</span><span class="p">]</span> <span class="o">=</span> <span class="mi">180</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="n">phi</span>

                <span class="c1"># Update global rotation matrix</span>
                <span class="n">Ri</span> <span class="o">=</span> <span class="n">xyz2enh</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ista</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ri</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span>

                <span class="c1"># VE,VN / pole partial derivatives</span>
                <span class="n">Ai</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">X</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">X</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">X</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">X</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">X</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Ai</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">X</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ista</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">as2rad</span> <span class="o">*</span> <span class="n">dot</span><span class="p">(</span><span class="n">Ri</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:],</span> <span class="n">Ai</span><span class="p">)</span>

                <span class="c1"># VE,VN / translation rate partial derivatives</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Trate</span><span class="p">):</span>
                    <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">ista</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">ista</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">nplate</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">nplate</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ri</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span>

        <span class="c1"># Build least-squares system</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">):</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">iQ</span><span class="p">,</span> <span class="n">iQ</span><span class="p">)],</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;diagonal&#39;</span><span class="p">):</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">iQ</span><span class="p">,</span> <span class="n">iQ</span><span class="p">)],</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;identity&#39;</span><span class="p">):</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="c1"># Solve least-squares system</span>
        <span class="n">Qx</span> <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">Qx</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">vm</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">vm</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;identity&#39;</span><span class="p">):</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nsta</span><span class="o">-</span><span class="n">npar</span><span class="p">))</span>
            <span class="n">Qv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nsta</span><span class="p">)</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">Qx</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s0</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nsta</span><span class="o">-</span><span class="n">npar</span><span class="p">))</span>
            <span class="n">Qv</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">Qx</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">Qx</span> <span class="o">=</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Qx</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Qx</span><span class="p">))</span>
        <span class="n">Qv</span> <span class="o">=</span> <span class="n">s0</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Qv</span>
        <span class="n">vn</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Qv</span><span class="p">))</span>

        <span class="c1"># Compute East and North WRMS</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">we</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Qv</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)]))</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Qv</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)])))</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">wn</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Qv</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)]))</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Qv</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)])))</span>

        <span class="c1"># Write log file</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">append</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="c1"># Write header</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sinex::plate_poles : from </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Write main options and statistics</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Number of plates   : </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nplate</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Number of stations : </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nsta</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Translation rate   : </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Trate</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Weighting          : </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weighting</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Variance factor    : </span><span class="si">{0:.8e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s0</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WRMS East          : </span><span class="si">{0:6.3f}</span><span class="s1"> mm/yr</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">we</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WRMS North         : </span><span class="si">{0:6.3f}</span><span class="s1"> mm/yr</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wn</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Write translation rate if estimated</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Trate</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Translation rate:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-----------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; TX = </span><span class="si">{0:7.3f}</span><span class="s1"> +/- </span><span class="si">{1:7.3f}</span><span class="s1"> mm/yr</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">sx</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; TY = </span><span class="si">{0:7.3f}</span><span class="s1"> +/- </span><span class="si">{1:7.3f}</span><span class="s1"> mm/yr</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">sx</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; TZ = </span><span class="si">{0:7.3f}</span><span class="s1"> +/- </span><span class="si">{1:7.3f}</span><span class="s1"> mm/yr</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Write plate summary</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Tectonic plates:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;----------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;      | #sta      WRMS E/N   |    OX (mas/yr)        OY (mas/yr)        OZ (mas/yr)   |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;------|----------------------|--------------------------------------------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nplate</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">i0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">plate_nsta</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">wei</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Qv</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">ind</span><span class="p">)]))</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Qv</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">ind</span><span class="p">)])))</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i0</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">plate_nsta</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">wni</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Qv</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">ind</span><span class="p">)]))</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Qv</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">ind</span><span class="p">)])))</span>
                <span class="n">i0</span> <span class="o">=</span> <span class="n">i0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">plate_nsta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0}</span><span class="s1"> | </span><span class="si">{1:4d}</span><span class="s1">   </span><span class="si">{2:6.3f}</span><span class="s1"> </span><span class="si">{3:6.3f}</span><span class="s1"> | </span><span class="si">{4:6.3f}</span><span class="s1"> +/- </span><span class="si">{5:5.3f}</span><span class="s1">   </span><span class="si">{6:6.3f}</span><span class="s1"> +/- </span><span class="si">{7:5.3f}</span><span class="s1">   </span><span class="si">{8:6.3f}</span><span class="s1"> +/- </span><span class="si">{9:5.3f}</span><span class="s1"> |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plate_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">plate_nsta</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">wei</span><span class="p">,</span> <span class="n">wni</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="n">sx</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">sx</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="n">sx</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;------|----------------------|--------------------------------------------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Write residuals</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Residuals:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;----------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; code   plat | Raw: E/N, mm/yr | Normalized: E/N |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------------|-----------------|-----------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nplate</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plate_nsta</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0}</span><span class="s1">   </span><span class="si">{1}</span><span class="s1"> | </span><span class="si">{2:7.3f}</span><span class="s1"> </span><span class="si">{3:7.3f}</span><span class="s1"> | </span><span class="si">{4:7.3f}</span><span class="s1"> </span><span class="si">{5:7.3f}</span><span class="s1"> |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plate_sta</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">plate_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">vn</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">0</span><span class="p">],</span> <span class="n">vn</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------------|-----------------|-----------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Close log file</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Re-arrange outputs</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Trate</span><span class="p">):</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nplate</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nplate</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nplate</span><span class="p">):</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">plate_sta</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">v</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">vn</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Return</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">plate_list</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Qx</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vn</span><span class="p">,</span> <span class="n">vm</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : insert_disc</span>
<span class="c1"># Purpose : Insert new &quot;discontinuity&quot; for a given station, by duplicating appropriate soln</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 23-Jun-2016</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - code : 4-char station ID</span>
<span class="c1">#           - t    : discontinuity date (SINEX format)</span>
<span class="c1"># Output  :</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.insert_disc"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.insert_disc">[docs]</a>    <span class="k">def</span> <span class="nf">insert_disc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Get station from snx.sta</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

        <span class="c1"># Look for which soln to split</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">b</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">b</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">earlier</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">datastart</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">earlier</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dataend</span><span class="p">))):</span>
                <span class="n">b</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

        <span class="c1"># Modify end (and mean) date of soln i</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dataend</span>
        <span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dataend</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">mjd1</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_snxepoch</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">datastart</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span>
        <span class="n">mjd2</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_snxepoch</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dataend</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span>
        <span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">datamean</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_mjd</span><span class="p">((</span><span class="n">mjd1</span><span class="o">+</span><span class="n">mjd2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">snxepoch</span><span class="p">()</span>

        <span class="c1"># Insert new soln</span>
        <span class="n">oldsoln</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span>
        <span class="n">newsoln</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:4d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">record</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="n">newsoln</span>
        <span class="n">r</span><span class="o">.</span><span class="n">datastart</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">r</span><span class="o">.</span><span class="n">dataend</span> <span class="o">=</span> <span class="n">end</span>
        <span class="n">mjd1</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_snxepoch</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">datastart</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span>
        <span class="n">mjd2</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_snxepoch</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">dataend</span><span class="p">)</span><span class="o">.</span><span class="n">mjd</span>
        <span class="n">r</span><span class="o">.</span><span class="n">datamean</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">from_mjd</span><span class="p">((</span><span class="n">mjd1</span><span class="o">+</span><span class="n">mjd2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">snxepoch</span><span class="p">()</span>
        <span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

        <span class="c1"># Modify solns of subsequent solns</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">code</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span><span class="p">)):</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:4d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:4d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">soln</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Get indices of parameters to be duplicated</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">npar</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">code</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="o">==</span> <span class="n">oldsoln</span><span class="p">)):</span>
                <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Duplicate parameters</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="o">=</span> <span class="n">newsoln</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c1"># Duplicate parameter values and sigmas</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">sig</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>

        <span class="c1"># Extend covariance matrix</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">snx</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[:,</span><span class="n">ind</span><span class="p">])),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">ind</span><span class="p">)]))))</span>

        <span class="c1"># Update number of parameters</span>
        <span class="n">snx</span><span class="o">.</span><span class="n">npar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">)</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : apply_offsets</span>
<span class="c1"># Purpose : Apply position offsets to specified solns</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 05-Jul-2016</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - code   : 4-char station IDs</span>
<span class="c1">#           - pt     : PT codes</span>
<span class="c1">#           - soln   : Solns</span>
<span class="c1">#           - denh   : E/N/H position offsets (mm)</span>
<span class="c1"># Output  :</span>
<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.apply_offsets"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.apply_offsets">[docs]</a>    <span class="k">def</span> <span class="nf">apply_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">,</span> <span class="n">denh</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Loop over offsets to apply</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)):</span>

            <span class="c1"># If current soln not in solution,</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">])):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; not found in solution !&#39;</span><span class="p">)</span>

            <span class="c1"># Else,</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Get index of matching STAX parameter</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="c1"># Apply position offset</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">xyz2enh</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">denh</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="mi">1000</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : write_solndomes</span>
<span class="c1"># Purpose : Write special soln file with DOMES numbers (needed for IGS combination database)</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 21-Jul-2015</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - solns : Soln table</span>
<span class="c1">#           - file  : File to write</span>
<span class="c1"># Output  :</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.write_solndomes"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.write_solndomes">[docs]</a>    <span class="k">def</span> <span class="nf">write_solndomes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solns</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>

        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Open output file</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># Loop over stations</span>
        <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">snx</span><span class="o">.</span><span class="n">sta</span><span class="p">:</span>

            <span class="c1"># If station is in soln table,</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">sta</span><span class="o">.</span><span class="n">pt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">]):</span>

                <span class="c1"># Get index of station in soln table</span>
                <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">pt</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sta</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">sta</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>

                <span class="c1"># Write P-solns</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> </span><span class="si">{0.domes}</span><span class="s1"> </span><span class="si">{1.soln}</span><span class="s1"> P </span><span class="si">{1.start}</span><span class="s1"> </span><span class="si">{1.end}</span><span class="s1"> P - </span><span class="si">{1.reason}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

                <span class="c1"># Write V-solns</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">V</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0.code}</span><span class="s1"> </span><span class="si">{0.pt}</span><span class="s1"> </span><span class="si">{0.domes}</span><span class="s1"> </span><span class="si">{1.soln}</span><span class="s1"> P </span><span class="si">{1.start}</span><span class="s1"> </span><span class="si">{1.end}</span><span class="s1"> V - </span><span class="si">{1.reason}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

        <span class="c1"># Close output file</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">#-------------------------------------------------------------------------------</span>
<span class="c1"># Routine : loadest_wrt</span>
<span class="c1"># Purpose : Estimate surface load coefficients from comparison to a reference solution</span>
<span class="c1"># Author  : P. Rebischung</span>
<span class="c1"># Created : 31-Jan-2012</span>
<span class="c1">#</span>
<span class="c1"># Changes :</span>
<span class="c1">#</span>
<span class="c1"># Input   : - ref       : Solution to which the comparison is made (sinex object)</span>
<span class="c1">#           - center    : &#39;CM&#39;, &#39;CF&#39; or &#39;CN&#39;</span>
<span class="c1">#           - lmax      : Maximal SH degree</span>
<span class="c1">#           - lovefile  : File containing load Love numbers</span>
<span class="c1">#           - weighting : Keyword to indicate which weighting should be used.</span>
<span class="c1">#                         It can take the following values :</span>
<span class="c1">#                         - &#39;identity&#39; to use an identity weight matrix (default)</span>
<span class="c1">#                         - &#39;diagonal&#39; to use a diagonal weight matrix</span>
<span class="c1">#                         - &#39;full&#39; to use a full weight matrix (inv(snx.Q))</span>
<span class="c1">#           - log       : Log file. Default is None.</span>
<span class="c1">#           - append    : If true, text will be appended to log file. Default if False.</span>
<span class="c1"># Output  : - T         : Vector of estimated parameters (rotations + load coefficients)</span>
<span class="c1">#           - Q         : Covariance matrix of estimated parameters</span>
<span class="c1">#           - code      : 4-char codes of points used for the comparison</span>
<span class="c1">#           - pt        : PT codes of points used for the comparison</span>
<span class="c1">#           - soln      : solns of points used for the comparison</span>
<span class="c1">#           - vl        : E, N, H residuals</span>
<span class="c1">#           - vln       : Normalized E, N, H residuals</span>
<span class="c1">#           - w         : WRMS of topocentric residuals</span>
<span class="c1">#-------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="sinex.loadest_wrt"><a class="viewcode-back" href="../../../pyacs.sinex.html#pyacs.sinex.sinex.sinex.loadest_wrt">[docs]</a>    <span class="k">def</span> <span class="nf">loadest_wrt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">lovefile</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>


        <span class="c1"># snx = self for class methof # Added JMN 05/01/2018</span>
        <span class="n">snx</span> <span class="o">=</span> <span class="bp">self</span>


        <span class="c1"># Initializations</span>
        <span class="n">re</span>   <span class="o">=</span> <span class="p">(</span><span class="n">ae</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">be</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="n">me</span>   <span class="o">=</span> <span class="mf">5.9726e24</span>
        <span class="n">rho</span>  <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">me</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">re</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">nsta</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ind0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pt</span>   <span class="o">=</span> <span class="p">[]</span>
        <span class="n">soln</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Read Love numbers</span>
        <span class="n">lovel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">loveh</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">lovefile</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="n">tab</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">loveh</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">lovel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tab</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">lovel</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lovel</span><span class="p">)</span>
        <span class="n">loveh</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">loveh</span><span class="p">)</span>

        <span class="c1"># Loop over STAX parameters of snx to identify common stations</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">)):</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STAX  &#39;</span><span class="p">):</span>

                <span class="c1"># If current station is common to both solutions,</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">soln</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p0</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p0</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]):</span>
                    <span class="n">nsta</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                    <span class="n">pt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">pt</span><span class="p">)</span>
                    <span class="n">soln</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>

                    <span class="n">j</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span><span class="o">.</span><span class="n">type</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p0</span><span class="o">.</span><span class="n">soln</span> <span class="k">for</span> <span class="n">p0</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;STAX  &#39;</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">code</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">pt</span><span class="o">+</span><span class="n">p1</span><span class="o">.</span><span class="n">soln</span><span class="p">)</span>
                    <span class="n">ind1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">)))</span>
                    <span class="n">ind0</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">3</span><span class="p">)))</span>

        <span class="c1"># Get reference coordinates of common stations</span>
        <span class="n">nobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind0</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind0</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">X</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind0</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span>

        <span class="c1"># Compute lat, colat, lon and XYZ-&gt;ENH rotation matrices</span>
        <span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span> <span class="o">=</span> <span class="n">cart2geo</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">phi</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">xyz2enh</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Compute all spherical harmonics up to degree/order lmax</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">lmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsta</span><span class="p">))</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">lmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsta</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">special</span><span class="o">.</span><span class="n">sph_harm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
                <span class="n">C</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
                <span class="n">S</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

        <span class="c1"># Initialize design matrix A</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;CM&#39;</span><span class="p">):</span>
            <span class="n">npar</span> <span class="o">=</span> <span class="n">lmax</span><span class="o">*</span><span class="p">(</span><span class="n">lmax</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">center</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CF&#39;</span><span class="p">,</span> <span class="s1">&#39;CN&#39;</span><span class="p">]):</span>
            <span class="n">npar</span> <span class="o">=</span> <span class="n">lmax</span><span class="o">*</span><span class="p">(</span><span class="n">lmax</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nobs</span><span class="p">,</span> <span class="n">npar</span><span class="p">))</span>

        <span class="c1"># XYZ / translations-rotations partial derivatives</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;CM&#39;</span><span class="p">):</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">center</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CF&#39;</span><span class="p">,</span> <span class="s1">&#39;CN&#39;</span><span class="p">]):</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-3</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mas2rad</span> <span class="o">*</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Loop over degrees</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

            <span class="c1"># Index of load(l,0,C) parameter</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;CM&#39;</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">center</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CF&#39;</span><span class="p">,</span> <span class="s1">&#39;CN&#39;</span><span class="p">]):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span>

            <span class="c1"># ENH/load(l,0,C) partial derivatives</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">lovel</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="n">l</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,:])</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">3</span><span class="o">*</span><span class="n">loveh</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="mi">0</span><span class="p">,:]</span>

            <span class="c1"># Loop over orders &gt; 0</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

                <span class="c1"># Index of load(l,m,C) parameter</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;CM&#39;</span><span class="p">):</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">2</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">center</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CF&#39;</span><span class="p">,</span> <span class="s1">&#39;CN&#39;</span><span class="p">]):</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">5</span>

                <span class="c1"># ENH/load(l,m,C) partial derivatives</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="n">lovel</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">*</span><span class="n">S</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,:]</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">lovel</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,:]</span><span class="o">-</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">m</span><span class="p">))</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">m</span><span class="p">,:])</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">3</span><span class="o">*</span><span class="n">loveh</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,:]</span>

                <span class="c1"># ENH/load(l,m,S) partial derivatives</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">3</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="n">lovel</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">*</span><span class="n">C</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,:]</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">lovel</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">S</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,:]</span><span class="o">-</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">m</span><span class="p">))</span><span class="o">*</span><span class="n">S</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">m</span><span class="p">,:])</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">nobs</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">3</span><span class="o">*</span><span class="n">loveh</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">S</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,:]</span>

        <span class="c1"># Rotate ENH/load partial derivatives to obtain XYZ/load partial derivatives</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;CM&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsta</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">:])</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">center</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CF&#39;</span><span class="p">,</span> <span class="s1">&#39;CN&#39;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsta</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">:]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">:])</span>

        <span class="c1"># 2nd member B</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ind0</span><span class="p">]</span>

        <span class="c1"># Compute normal matrix and 2nd member of normal equation</span>
        <span class="c1"># Also modify design matrix if we&#39;re in CN.</span>
        <span class="n">N</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="n">K</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="n">P</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;identity&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;CN&#39;</span><span class="p">):</span>
                <span class="n">AtP</span>  <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">Q</span>    <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">AtP</span><span class="p">,</span> <span class="n">A</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]))</span>
                <span class="n">proj</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">Q</span><span class="p">),</span> <span class="n">AtP</span><span class="p">)</span>
                <span class="n">A</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:]</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">A</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:])</span>
            <span class="n">N</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
            <span class="n">K</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;diagonal&#39;</span><span class="p">):</span>
            <span class="n">P</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;CN&#39;</span><span class="p">):</span>
                <span class="n">AtP</span>  <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">P</span>
                <span class="n">Q</span>    <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">AtP</span><span class="p">,</span> <span class="n">A</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]))</span>
                <span class="n">proj</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">Q</span><span class="p">),</span> <span class="n">AtP</span><span class="p">)</span>
                <span class="n">A</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:]</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">A</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:])</span>
            <span class="n">N</span>  <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">P</span>
            <span class="n">K</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
            <span class="n">N</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">):</span>
            <span class="n">P</span>  <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind1</span><span class="p">)])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;CN&#39;</span><span class="p">):</span>
                <span class="n">AtP</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
                <span class="n">Q</span>    <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">AtP</span><span class="p">,</span> <span class="n">A</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]))</span>
                <span class="n">proj</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">Q</span><span class="p">),</span> <span class="n">AtP</span><span class="p">)</span>
                <span class="n">A</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:]</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">A</span><span class="p">[:,</span><span class="mi">6</span><span class="p">:])</span>
            <span class="n">N</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
            <span class="n">K</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
            <span class="n">N</span>  <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>

        <span class="c1"># Solve normal equation</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">syminv</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

        <span class="c1"># Compute residuals and variance factor</span>
        <span class="n">vg</span> <span class="o">=</span> <span class="n">B</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        <span class="n">vPv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sigma0</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;identity&#39;</span><span class="p">):</span>
            <span class="n">vPv</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">vg</span><span class="p">,</span> <span class="n">vg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;diagonal&#39;</span><span class="p">):</span>
            <span class="n">vPv</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">vg</span><span class="o">*</span><span class="n">P</span><span class="p">,</span> <span class="n">vg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">):</span>
            <span class="n">vPv</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">vg</span><span class="p">,</span> <span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">vg</span><span class="p">))</span>

        <span class="n">sigma0</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">vPv</span> <span class="o">/</span> <span class="p">(</span><span class="n">nobs</span> <span class="o">-</span> <span class="n">npar</span><span class="p">))</span>

        <span class="c1"># Standard deviations of estimated transformation parameters</span>
        <span class="n">sT</span> <span class="o">=</span> <span class="n">sigma0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>

        <span class="c1"># Compute covariance matrix of residuals (Qv)</span>
        <span class="n">Qv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;identity&#39;</span><span class="p">):</span>
            <span class="n">Qv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nobs</span><span class="p">)</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Q</span><span class="p">),</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;diagonal&#39;</span><span class="p">):</span>
            <span class="n">Qv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="n">snx</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind1</span><span class="p">])</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Q</span><span class="p">),</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Qv</span> <span class="o">=</span> <span class="n">snx</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind1</span><span class="p">)]</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Q</span><span class="p">),</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># Compute normalized residuals</span>
        <span class="n">vgn</span> <span class="o">=</span> <span class="n">vg</span> <span class="o">/</span> <span class="n">sigma0</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Qv</span><span class="p">))</span>

        <span class="c1"># Compute E,N,H [normalized] residuals and WRMS</span>
        <span class="n">vl</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nobs</span><span class="p">))</span>
        <span class="n">vln</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nobs</span><span class="p">))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsta</span><span class="p">):</span>
            <span class="n">vl</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vg</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">Ql</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dot</span><span class="p">(</span><span class="n">Qv</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">][:,</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
            <span class="n">vln</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">vl</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">sigma0</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Ql</span><span class="p">))</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">w</span> <span class="o">+</span> <span class="n">vl</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Ql</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">Ql</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span>

        <span class="c1"># Reshape residual tables</span>
        <span class="n">vg</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">vgn</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">vl</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">vln</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">nsta</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Convert raw residuals and WRMS into mm</span>
        <span class="n">vg</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">vg</span>
        <span class="n">vl</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">vl</span>
        <span class="n">w</span>  <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">w</span>

        <span class="c1"># Write log file</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">log</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">append</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="c1"># Write header</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sinex::loadest_wrt : </span><span class="si">{0}</span><span class="s1"> vs </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">snx</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;================================================================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Write main options and statistics</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Number of common points : </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nsta</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Number of parameters    : </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npar</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Weighting               : </span><span class="si">{0}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">weighting</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Variance factor         : </span><span class="si">{0:.8e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma0</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WRMS East               : </span><span class="si">{0:8.3f}</span><span class="s1"> mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WRMS North              : </span><span class="si">{0:8.3f}</span><span class="s1"> mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;WRMS Up                 : </span><span class="si">{0:8.3f}</span><span class="s1"> mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Degree 1 load -&gt; geocenter conversion factors (from P. Gegout&#39;s load Love numbers)</span>
            <span class="n">kz</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">0.1285877758E+01</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="mf">0.8960817937E+00</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">pi</span><span class="p">))</span>
            <span class="n">kxy</span> <span class="o">=</span> <span class="n">kz</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Write estimated parameters and formal errors</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Estimated parameters :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;----------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;CM&#39;</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;RX  = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> mas</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;RY  = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> mas</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;RZ  = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> mas</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;C10 = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> kg*m^-2 &lt;=&gt; TZ = </span><span class="si">{2:15.8e}</span><span class="s1"> +/- </span><span class="si">{3:15.8e}</span><span class="s1"> m</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">kz</span> <span class="o">*</span><span class="n">T</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">kz</span> <span class="o">*</span><span class="n">sT</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;C11 = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> kg*m^-2 &lt;=&gt; TX = </span><span class="si">{2:15.8e}</span><span class="s1"> +/- </span><span class="si">{3:15.8e}</span><span class="s1"> m</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">kxy</span><span class="o">*</span><span class="n">T</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">kxy</span><span class="o">*</span><span class="n">sT</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;S11 = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> kg*m^-2 &lt;=&gt; TY = </span><span class="si">{2:15.8e}</span><span class="s1"> +/- </span><span class="si">{3:15.8e}</span><span class="s1"> m</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">kxy</span><span class="o">*</span><span class="n">T</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">kxy</span><span class="o">*</span><span class="n">sT</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">center</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CF&#39;</span><span class="p">,</span> <span class="s1">&#39;CN&#39;</span><span class="p">]):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TX  = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TY  = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;TZ  = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> mm</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;RX  = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> mas</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;RY  = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> mas</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;RZ  = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> mas</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;C10 = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> kg*m^-2 &lt;=&gt; TZ = </span><span class="si">{2:15.8e}</span><span class="s1"> +/- </span><span class="si">{3:15.8e}</span><span class="s1"> m</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">kz</span> <span class="o">*</span><span class="n">T</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">kz</span> <span class="o">*</span><span class="n">sT</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;C11 = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> kg*m^-2 &lt;=&gt; TX = </span><span class="si">{2:15.8e}</span><span class="s1"> +/- </span><span class="si">{3:15.8e}</span><span class="s1"> m</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">kxy</span><span class="o">*</span><span class="n">T</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">kxy</span><span class="o">*</span><span class="n">sT</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;S11 = </span><span class="si">{0:15.8e}</span><span class="s1"> +/- </span><span class="si">{1:15.8e}</span><span class="s1"> kg*m^-2 &lt;=&gt; TY = </span><span class="si">{2:15.8e}</span><span class="s1"> +/- </span><span class="si">{3:15.8e}</span><span class="s1"> m</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">kxy</span><span class="o">*</span><span class="n">T</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">kxy</span><span class="o">*</span><span class="n">sT</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span>

            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">lmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;CM&#39;</span><span class="p">):</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">center</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CF&#39;</span><span class="p">,</span> <span class="s1">&#39;CN&#39;</span><span class="p">]):</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;C</span><span class="si">{0}</span><span class="s1">0 = </span><span class="si">{1:15.8e}</span><span class="s1"> +/- </span><span class="si">{2:15.8e}</span><span class="s1"> kg*m^-2</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">T</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;CM&#39;</span><span class="p">):</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">2</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">center</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CF&#39;</span><span class="p">,</span> <span class="s1">&#39;CN&#39;</span><span class="p">]):</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="mi">5</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;C</span><span class="si">{0}{1}</span><span class="s1"> = </span><span class="si">{2:15.8e}</span><span class="s1"> +/- </span><span class="si">{3:15.8e}</span><span class="s1"> kg*m^-2</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;S</span><span class="si">{0}{1}</span><span class="s1"> = </span><span class="si">{2:15.8e}</span><span class="s1"> +/- </span><span class="si">{3:15.8e}</span><span class="s1"> kg*m^-2</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">sT</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Write residuals</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Residuals :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-----------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;             |  Raw residuals (mm)  | Normalized residuals |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------------|----------------------|----------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;code pt soln |    E      N      H   |    E      N      H   |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------------|----------------------|----------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsta</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1"> |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">soln</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0[0]:6.1f}</span><span class="s1"> </span><span class="si">{0[1]:6.1f}</span><span class="s1"> </span><span class="si">{0[2]:6.1f}</span><span class="s1"> |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vl</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{0[0]:6.1f}</span><span class="s1"> </span><span class="si">{0[1]:6.1f}</span><span class="s1"> </span><span class="si">{0[2]:6.1f}</span><span class="s1"> |</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vln</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;-------------|----------------------|----------------------|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">sigma0</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">Q</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">soln</span><span class="p">,</span> <span class="n">vl</span><span class="p">,</span> <span class="n">vln</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Jean-Mathieu Nocquet IRD.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>